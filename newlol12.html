<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrintMoKoPOS & Inventory</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NEW: Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* --- REVISED: Global Dark Mode Styles --- */
        .dark body {
            background-color: #111827; /* gray-900 */
            color: #f3f4f6; /* gray-100 - FIX: Sets ALL default text to light */
        }

        /* Main containers */
        .dark #main-content,
        .dark #tab-content {
            background-color: #1f2937; /* gray-800 */
            border-color: #374151; /* gray-700 */
        }

        /* All white cards, modals, and tables */
        .dark .bg-white, 
        .dark .modal > div {
            background-color: #1f2937; /* gray-800 */
            border-color: #374151; /* gray-700 */
        }

        /* REVISED: Targets ALL light backgrounds used in the app */
        .dark .bg-gray-50, 
        .dark .hover\:bg-gray-50:hover,
        .dark .bg-gray-100,
        .dark .bg-indigo-50,
        .dark .bg-blue-50,
        .dark .bg-red-100,
        .dark .bg-green-100,
        .dark .bg-blue-100,
        .dark .bg-yellow-100 {
            background-color: #374151; /* gray-700 */
        }

        /* REVISED: Targets main dark text */
        .dark .text-gray-800,
        .dark .text-gray-900,
        .dark .text-gray-700 {
            color: #f3f4f6; /* gray-100 */
        }

        /* Targets secondary text */
        .dark .text-gray-600,
        .dark .text-gray-500 {
            color: #9ca3af; /* gray-400 */
        }

        /* NEW: Targets all colored text to make them light for contrast */
        .dark .text-indigo-700,
        .dark .text-indigo-600 {
            color: #a5b4fc; /* indigo-300 */
        }
        .dark .text-blue-700,
        .dark .text-blue-600 {
            color: #93c5fd; /* blue-300 */
        }
        .dark .text-green-700,
        .dark .text-green-600 {
            color: #86efac; /* green-300 */
        }
        .dark .text-purple-700,
        .dark .text-purple-600 {
            color: #c4b5fd; /* purple-300 */
        }
        .dark .text-red-700,
        .dark .text-red-600 {
            color: #fca5a5; /* red-300 */
        }
        .dark .text-yellow-700,
        .dark .text-yellow-600 {
            color: #fde047; /* yellow-300 */
        }
        /* --- END NEW COLORED TEXT --- */

        /* Borders */
        .dark .border-b,
        .dark .border-t,
        .dark .border,
        .dark .divide-y > :not([hidden]) ~ :not([hidden]) {
            border-color: #374151 !important; /* gray-700 */
        }

        /* Form Inputs */
        .dark input,
        .dark select {
            background-color: #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
            border-color: #4b5563; /* gray-600 */
        }
        /* NEW: Fixes placeholder text color in dark mode */
        .dark input::placeholder,
        .dark select::placeholder {
            color: #9ca3af; /* gray-400 */
        }
        /* --- END: Global Dark Mode Styles --- */

        .main-app-container {
            min-height: 100vh;
        }

        /* Style for the print receipt - Hide everything else when printing */
        
        @media print {
            body > *:not(#receipt-print-area) {
                display: none !important;
            }
            #receipt-print-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: auto;
                margin: 0;
                padding: 1rem;
                
                /* --- NEW: Force Light Mode for Printing --- */
                background-color: #ffffff !important; /* Force white background */
                color: #000000 !important; /* Force default text to black */
                border: 1px solid #ccc !important; /* Add a simple border */
                box-shadow: none !important; /* Remove any shadows */
            }
            
            /* --- NEW: Force all child elements to have black text --- */
            /* This overrides any 'dark:text-gray-300' etc. */
            #receipt-print-area * {
                color: #000000 !important;
                background-color: transparent !important;
            }

            /* --- NEW: Restore specific colors (like for discounts) --- */
            #receipt-print-area .text-red-600 {
                color: #dc2626 !important; /* Keep discount text red */
            }
            
            /* --- NEW: Ensure loyalty points text is also dark --- */
            #receipt-print-area .text-gray-700 {
                 color: #374151 !important;
            }
        }

        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Style for the active settings sub-tab */
        .settings-sub-tab-active {
            border-bottom-width: 2px;
            border-color: #6366f1; /* indigo-500 */
            color: #4f46e5; /* indigo-700 */
            font-weight: 600;
        }

        /* NEW: Dark mode override for active sub-tab */
        .dark .settings-sub-tab-active {
            border-color: #a5b4fc; /* indigo-300 */
            /* Text color is now handled by the .dark .text-indigo-700 rule */
        }
    </style>
    <script>
            // On page load, this script runs before the page is visible
            // It checks localStorage and applies the 'dark' class if needed
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        </script>
</head>
<body class="bg-white">

    <div id="app" class="main-app-container flex flex-col items-center">
        
        <!-- Authentication Screen -->
        <div id="auth-screen" class="p-8 w-full max-w-md mx-auto h-screen flex flex-col justify-center">
            <div class="bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
                <h2 id="auth-title" class="text-3xl font-bold text-center text-indigo-700 mb-6">Log In</h2>
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="auth-email" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="auth-password" required minlength="6" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p id="auth-message" class="text-sm text-red-500 hidden"></p>
                    <button id="auth-button" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                        Log In
                    </button>
                    <p id="auth-toggle" class="text-center text-sm text-indigo-600 hover:text-indigo-800 cursor-pointer mt-4">Need an account? Sign Up</p>
                </form>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content" class="hidden w-full max-w-8xl mx-auto p-4 md:p-10">
            
            <!-- Header and Navigation -->
            <header class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-lg mb-6">
                <div class="flex items-center space-x-3 mb-4 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path fill-rule="evenodd" d="M7.875 1.5C6.839 1.5 6 2.34 6 3.375v2.99c-.426.053-.851.11-1.274.174-1.454.218-2.476 1.483-2.476 2.917v6.294a3 3 0 0 0 3 3h.27l-.155 1.705A1.875 1.875 0 0 0 7.232 22.5h9.536a1.875 1.875 0 0 0 1.867-2.045l-.155-1.705h.27a3 3 0 0 0 3-3V9.456c0-1.434-1.022-2.7-2.476-2.917A48.716 48.716 0 0 0 18 6.366V3.375c0-1.036-.84-1.875-1.875-1.875h-8.25ZM16.5 6.205v-2.83A.375.375 0 0 0 16.125 3h-8.25a.375.375 0 0 0-.375.375v2.83a49.353 49.353 0 0 1 9 0Zm-.217 8.265c.178.018.317.16.333.337l.526 5.784a.375.375 0 0 1-.374.409H7.232a.375.375 0 0 1-.374-.409l.526-5.784a.373.373 0 0 1 .333-.337 41.741 41.741 0 0 1 8.566 0Zm.967-3.97a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H18a.75.75 0 0 1-.75-.75V10.5ZM15 9.75a.75.75 0 0 0-.75.75v.008c0 .414.336.75.75.75h.008a.75.75 0 0 0 .75-.75V10.5a.75.75 0 0 0-.75-.75H15Z" clip-rule="evenodd" />
                    </svg>
                    <h1 class="text-2xl font-bold text-violet-600">PrintMoKo POS & Inventory</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-info" class="text-sm text-gray-600 truncate max-w-[150px] md:max-w-none"></span>

                    <!-- NEW: Settings Icon Button -->
                    <button id="settings-icon-button" data-tab="settings" class="tab-button text-gray-500 hover:text-indigo-600 p-2 rounded-full transition duration-150" title="Settings">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                    <button id="theme-toggle-button" class="text-gray-500 hover:text-indigo-600 p-2 rounded-full transition duration-150" title="Toggle light/dark mode">
                        <svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-1.636 4.364a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1zM6.05 15.364a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM3.464 5.464a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1z"></path></svg>
                    </button>
                    <button id="logout-button" class="bg-violet-500 hover:bg-red-600 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                        Log Out
                    </button>
                </div>
            </header>

            <!-- Tabs Navigation -->
            <nav class="bg-white p-2 rounded-xl shadow-lg mb-6">
                <div class="flex flex-nowrap overflow-x-auto space-x-1 md:space-x-2 pb-2">
                    
                    <button data-tab="dashboard" class="tab-button flex-shrink-0 whitespace-nowrap py-2 px-3 text-center text-sm font-medium rounded-lg transition duration-150 text-gray-600 hover:bg-gray-100">
                        Dashboard
                    </button>
                    
                    <button data-tab="pos" class="tab-button flex-shrink-0 whitespace-nowrap py-2 px-3 text-center text-sm font-medium rounded-lg transition duration-150 bg-indigo-600 text-white">
                        Point of Sale
                    </button>
                    <button data-tab="pending" class="tab-button flex-shrink-0 whitespace-nowrap py-2 px-3 text-center text-sm font-medium rounded-lg transition duration-150 text-gray-600 hover:bg-gray-100">
                    <!-- FIX: Wrapped in a relative span so the badge isn't cut off by overflow-x-auto -->
                        <span class="relative">
                            Pending Sales
                            <span id="pending-sales-count-badge" class="hidden absolute -top-2 -right-4 w-5 h-5 rounded-full bg-red-500 text-white text-xs font-bold flex items-center justify-center">0</span>
                        </span>
                    </button>
                    <button data-tab="categories" class="tab-button flex-shrink-0 whitespace-nowrap py-2 px-3 text-center text-sm font-medium rounded-lg transition duration-150 text-gray-600 hover:bg-gray-100">
                        Categories
                    </button>
                    <button data-tab="inventory" class="tab-button flex-shrink-0 whitespace-nowrap py-2 px-3 text-center text-sm font-medium rounded-lg transition duration-150 text-gray-600 hover:bg-gray-100">
                        Inventory
                    </button>
                    <button data-tab="reports" class="tab-button flex-shrink-0 whitespace-nowrap py-2 px-3 text-center text-sm font-medium rounded-lg transition duration-150 text-gray-600 hover:bg-gray-100">
                        Reports
                    </button>
                    <button data-tab="customers" class="tab-button flex-shrink-0 whitespace-nowrap py-2 px-3 text-center text-sm font-medium rounded-lg transition duration-150 text-gray-600 hover:bg-gray-100">
                        Customers
                    </button>
                    <button data-tab="archive" class="tab-button flex-shrink-0 whitespace-nowrap py-2 px-3 text-center text-sm font-medium rounded-lg transition duration-150 text-gray-600 hover:bg-gray-100">
                        Archive Data
                    </button>

                    <button data-tab="settings" class="tab-button hidden">Settings</button>
                    
                </div>
            </nav>

            <!-- Tab Content -->
            <div id="tab-content" class="p-6 bg-white shadow-xl rounded-b-xl mb-10">
            <!-- 6. Archive Data Tab -->
            <div id="archive-tab" class="tab-pane hidden space-y-8">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-6">Archived Data</h2>

                <!-- Archived Categories -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Archived Categories</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category Name</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody id="archived-category-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Archived categories injected here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="archived-category-empty-message" class="text-gray-500 text-center py-8 hidden">No archived categories.</p>
                </div>

                <!-- Archived Inventory -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Archived Inventory Items</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Cost</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody id="archived-inventory-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Archived inventory injected here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="archived-inventory-empty-message" class="text-gray-500 text-center py-8 hidden">No archived inventory items.</p>
                </div>

                <!-- Archived Customers -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Archived Customers</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody id="archived-customer-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Archived customers injected here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="archived-customer-empty-message" class="text-gray-500 text-center py-8 hidden">No archived customers.</p>
                </div>

            </div>

            <!-- NEW: Settings Tab Pane -->
            <div id="settings-tab" class="tab-pane hidden space-y-6">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">Business Settings</h2>

                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button class="settings-sub-tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 settings-sub-tab-active" data-subtab="store-info">
                            Store Information
                        </button>
                        <button class="settings-sub-tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700" data-subtab="security">
                            Account & Security
                        </button>
                    </nav>
                </div>

                <div id="store-info-sub-tab" class="settings-sub-tab-pane">
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Store Information</h3>
                        <p class="text-sm text-gray-500 mb-6">This information will be displayed on your printed receipts.</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="settings-business-name" class="block text-sm font-medium text-gray-700">Business Name</label>
                                <input type="text" id="settings-business-name" placeholder="e.g., Mamamo shop" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="settings-business-address" class="block text-sm font-medium text-gray-700">Address</label>
                                <input type="text" id="settings-business-address" placeholder="Write your Address here" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="settings-business-contact" class="block text-sm font-medium text-gray-700">Contact Number</label>
                                <input type="text" id="settings-business-contact" placeholder="e.g., CP: 0912345678" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>

                            <div class="pt-4 mt-4 border-t border-gray-200">
                                <label for="settings-loyalty-rate" class="block text-sm font-medium text-gray-700">Loyalty Points Rule</label>
                                <div class="mt-1 flex items-center space-x-2">
                                    <span class="text-gray-700 dark:text-black-300">Earn 1 point for every ₱</span>
                                    <input type="number" id="settings-loyalty-rate" value="15" min="1" class="w-24 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <span class="text-gray-700 dark:text-black-300">spent.</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Set the amount (e.g., 15) a customer must spend to earn 1 point.</p>
                            </div>

                            <div class="pt-4 mt-4 border-t border-gray-200">
                                <label for="settings-default-payment-method" class="block text-sm font-medium text-gray-700">Default Payment Method</label>
                                <select id="settings-default-payment-method" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                    <option value="">-- None --</option>
                                    <option value="Cash">Cash</option>
                                    <option value="GCash">GCash</option>
                                    <option value="Maya">Maya</option>
                                    <option value="GoTyme">GoTyme</option>
                                    <option value="MariBank">MariBank</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Card">Card</option>
                                    <option value="Other">Other</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">This payment method will be pre-selected on the POS screen.</p>
                            </div>

                            <div class="pt-4 mt-4 border-t border-gray-200 space-y-4">
                                <div>
                                    <label for="settings-logo-url" class="block text-sm font-medium text-gray-700">Logo URL</label>
                                    <input type="text" id="settings-logo-url" placeholder="https://your-logo-image-url.com/logo.png" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <p class="text-xs text-gray-500 mt-1">Upload your logo to an image host (like imgbb.com) and paste the URL here.</p>
                                </div>

                                <div>
                                    <label for="settings-logo-size" class="block text-sm font-medium text-gray-700">Logo Size (Width)</label>
                                    <div class="mt-1 flex items-center space-x-2">
                                        <input type="number" id="settings-logo-size" value="50" min="10" max="100" class="w-24 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                        <span class="text-gray-700 dark:text-black-300">% of receipt width</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Default is 50%. (10% min, 100% max)</p>
                                </div>
                                <div>
                                    <label for="settings-font-size" class="block text-sm font-medium text-gray-700">Receipt Font Size</label>
                                    <select id="settings-font-size" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                        <option value="text-xs">Small</option>
                                        <option value="text-sm" selected>Medium (Default)</option>
                                        <option value="text-base">Large</option>
                                    </select>
                                </div>

                                <div class="flex items-center space-x-3">
                                    <input id="settings-show-contact" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="settings-show-contact" class="block text-sm font-medium text-gray-700">Show Contact Info (Address/Phone) on Receipt</label>
                                </div>

                                <div class="flex items-center space-x-3">
                                    <input id="settings-show-loyalty" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="settings-show-loyalty" class="block text-sm font-medium text-gray-700">Show Loyalty Points Summary on Receipt</label>
                                </div>
                            </div>
                            </div>
    
                        <button id="save-settings-button" class="mt-6 w-full md:w-auto flex justify-center py-2 px-6 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                            Save Settings
                        </button>
                        <p id="store-settings-message" class="text-sm text-green-500 mt-4 hidden"></p>
                    </div>
                </div>

                <div id="security-sub-tab" class="settings-sub-tab-pane hidden">
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Change Password</h3>
                        <p class="text-sm text-gray-500 mb-6">Changing your password will log you out of all other devices and sessions.</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="security-old-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                                <input type="password" id="security-old-password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="security-new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                                <input type="password" id="security-new-password" required minlength="6" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="security-confirm-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                                <input type="password" id="security-confirm-password" required minlength="6" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
    
                        <button id="change-password-button" class="mt-6 w-full md:w-auto flex justify-center py-2 px-6 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                            Change Password
                        </button>
                        <p id="security-message" class="text-sm text-green-500 mt-4 hidden"></p>
                    </div>
                </div>

            </div>
            <!-- END: Settings Tab Pane -->


            <!-- 0. Dashboard Tab -->
            <div id="dashboard-tab" class="tab-pane hidden">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-6">Business Dashboard</h2>
                <!-- Quick Filters -->
                <div class="flex flex-wrap items-center gap-2 p-4 w-full rounded-md border-gray-300 p-2 border focus:ring-indigo-500 focus:border-indigo-500 ">
                    <span class="text-sm font-medium text-gray-700 dark:text-black-200 mr-2">Quick Filters:</span>
                    <button data-filter="all" class="dashboard-filter-button px-3 py-1 text-sm font-medium rounded-md bg-indigo-600 text-white">All Time</button>
                    <button data-filter="today" class="dashboard-filter-button px-3 py-1 text-sm font-medium rounded-md bg-white">Today</button>
                    <button data-filter="week" class="dashboard-filter-button px-3 py-1 text-sm font-medium rounded-md">This Week</button>
                    <button data-filter="month" class="dashboard-filter-button px-3 py-1 text-sm font-medium rounded-md bg-white">This Month</button>
                </div>
                <br>
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Total Sales (Revenue)</p>
                        <p id="dashboard-sales-amount" class="text-3xl font-bold text-blue-700 mt-1">₱0.00</p>
                    </div>
                    
                    <!-- NEW: Total Profit Card -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Total Profit</p>
                        <p id="dashboard-total-profit" class="text-3xl font-bold text-green-700 mt-1">₱0.00</p>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Total Products</p>
                        <p id="dashboard-product-count" class="text-3xl font-bold text-green-700 mt-1">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">
                        <p class="text-sm font-medium text-gray-500">Total Categories</p>
                        <p id="dashboard-category-count" class="text-3xl font-bold text-purple-700 mt-1">0</p>
                    </div>
                </div>
                    
            

                <!-- Data Tables -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Highest Selling Products -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Highest Selling Products (Top 5)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qty Sold</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Revenue</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboard-highest-selling" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows injected by JS -->
                                    <tr><td colspan="3" class="px-4 py-6 text-center text-gray-500">No sales data yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Recently Added Products -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Recently Added Products (Top 5)</h3>
                         <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date Added</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboard-recently-added" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows injected by JS -->
                                    <tr><td colspan="3" class="px-4 py-6 text-center text-gray-500">No products added yet.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 1. Point of Sale (POS) Tab -->
            <div id="pos-tab" class="tab-pane">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- POS Left: Item Selection -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 class="text-xl font-bold text-gray-800">New Sale Transaction</h2>
                            <button id="resume-sale-button" class="relative py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                                Resume Sale
                                <span id="held-sale-count-badge" class="hidden absolute -top-2 -right-2 w-5 h-5 rounded-full bg-red-500 text-white text-xs font-bold flex items-center justify-center">0</span>
                            </button>
                        </div>
                        
                        <!-- Customer Info -->
                        <div class="mb-4 p-4 border border-indigo-200 bg-indigo-102 rounded-lg">
                            <label for="pos-customer-search" class="block text-sm font-medium text-indigo-700 mb-1">Search Existing Customer (Optional)</label>
                            <input type="text" id="pos-customer-search" placeholder="Type to search customer name or number..." class="w-full rounded-md border-gray-300 p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                            
                            <label for="pos-customer-selector" class="sr-only ">Select Existing Customer</label> <!-- Hidden label for accessibility -->
                            <select id="pos-customer-selector" class="w-full rounded-md border-gray-300 p-2 border focus:ring-indigo-500 focus:border-indigo-500"></select>
                            <div id="pos-customer-points-display" class="hidden w-full text-center rounded-md border-gray-300 p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                                <span class="text-sm font-medium text-gray-700 dark:text-black-300">Loyalty Points:</span>
                                <span id="pos-customer-points" class="text-lg font-bold text-indigo-600 dark:text-indigo-800">0</span>
                            </div>

                            <label for="customer-name" class="block text-sm font-medium text-indigo-700 mb-1">Customer Name (Required)</label>
                            <input type="text" id="customer-name" required class="w-full rounded-md border-gray-300 p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        </div>

                        <div id="pos-items-container" class="space-y-3 mb-6"></div>
                        
                        
                        <button id="add-item-button" class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white-600 bg-indigo-500 hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Add Material Item
                        </button>
                    </div>

                    <!-- POS Right: Summary & Checkout -->
                    <div class="bg-white p-6 rounded-xl shadow-lg h-fit lg:sticky top-4">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Order Summary</h2>
                        
                        <div id="pos-summary-items" class="space-y-2 text-gray-600 mb-4">
                            <!-- Summary items will be injected here -->
                        </div>

                        <!-- NEW: Subtotal, Discount, and Total Section -->
                        <div class="border-t pt-4 mt-4 space-y-2">
                            <div class="flex justify-between items-center text-md">
                                <span class="font-medium text-gray-600">Subtotal:</span>
                                <span id="pos-subtotal" class="font-medium text-gray-800">₱0.00</span>
                            </div>
                            
                            <div class="flex justify-between items-center text-md">
                                <label id="pos-discount-label" for="pos-discount" class="font-medium text-gray-600">Discount (₱):</label>
                                <div class="flex items-center space-x-1">
                                    <input type="number" id="pos-discount" value="0" min="0" step="0.01" class="w-24 rounded-md border-gray-300 shadow-sm p-1 border text-right font-medium text-red-600">
                                    <button id="pos-discount-toggle" type="button" class="px-2 py-1 rounded-md bg-indigo-100 dark:bg-gray-600 text-indigo-700 dark:text-gray-200 text-xs font-bold hover:bg-indigo-200">
                                        %
                                    </button>
                                </div>
                            </div>
                            <div id="pos-redeem-points-container" class="hidden"> <div class="flex justify-between items-center text-md">
                                    <label for="pos-redeem-points" class="font-medium text-gray-600">Redeem Points (₱):</label>
                                    <input type="number" id="pos-redeem-points" value="0" min="0" step="1" class="w-24 rounded-md border-gray-300 shadow-sm p-1 border text-right font-medium text-red-600">
                                </div>
                                <div class="text-right text-xs text-indigo-600 dark:text-indigo-400">
                                    Available: <span id="pos-customer-available-points">0</span> points
                                </div>
                            </div>
                            <div class="border-t pt-2 mt-2 flex justify-between items-center">
                                <span class="text-xl font-bold text-gray-800">TOTAL:</span>
                                <span id="total-cost" class="text-2xl font-extrabold text-indigo-700">₱0.00</span>
                            </div>
                        </div>
                        <!-- END: New Section -->
                        
                        <p id="pos-message" class="text-sm text-red-500 mt-4 hidden"></p>

                        <!-- NEW: Payment Method Dropdown -->
                        <div class="mt-6">
                            <label for="pos-payment-method" class="block text-sm font-medium text-gray-700">Payment Method</label>
                            <select id="pos-payment-method" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                <option value="">-- Select Payment --</option>
                                <option value="Cash">Cash</option>
                                <option value="GCash">GCash</option>
                                <option value="Maya">Maya</option>
                                <option value="GoTyme">GoTyme</option>
                                <option value="MariBank">MariBank</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Card">Card</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <!-- END: Payment Method Dropdown -->
                         <button id="hold-sale-button" class="w-full mt-4 flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-lg font-bold text-white bg-orange-500 hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-400 transition duration-150">
                            Hold Sale
                        </button>

                        <button id="process-sale-button" disabled class="w-full mt-6 flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-lg font-bold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                            Process Sale & Generate Receipt
                        </button>
                    </div>
                </div>
            </div>

            <div id="pending-tab" class="tab-pane hidden">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 mb-6">Pending Sales</h2>
                <p class="text-sm text-gray-600 mb-6">These are sales where a bill has been issued (e.g., for GCash, Maya) but payment has not been received yet. Once you receive payment, click "Confirm Payment" to complete the sale.</p>
                
                <div class="overflow-x-auto bg-white rounded-xl shadow-lg border max-h-[600px] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date Billed</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Payment Method</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total Due</th>
                                <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody id="pending-sales-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                <p id="pending-sales-empty-message" class="text-center text-gray-500 mt-4 hidden">No sales are pending payment.</p>
            </div>

            <!-- 2. Categories Tab -->
            <div id="categories-tab" class="tab-pane hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Add New Category -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Add New Category</h2>
                        <div class="flex flex-col space-y-3">
                            <input type="text" id="new-category-name" placeholder="Category Name (e.g., Paper, Ink)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <button id="add-category-button" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 w-full">
                                Add Category
                            </button>
                            <p id="category-message" class="text-sm text-red-500 mt-2 hidden"></p>
                        </div>
                    </div>

                    <!-- Category List -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Manage Categories</h2>
                        <div class="overflow-x-auto mb-6">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Count</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Added</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                    </tr>
                                </thead>
                                <tbody id="category-list-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Category rows injected here -->
                                </tbody>
                            </table>
                        </div>
                        <p id="category-empty-message" class="text-gray-500 text-center py-8 hidden">No categories found. Add one to get started!</p>
                    </div>

                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8 pt-6 border-t">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Add New Sub-Category</h2>
                        <div class="flex flex-col space-y-3">
                            <div>
                                <label for="parent-category-select" class="block text-sm font-medium text-gray-700 mb-1">Parent Category</label>
                                <select id="parent-category-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">-- Select Parent --</option>
                                    </select>
                            </div>
                            <div>
                                <label for="new-subcategory-name" class="block text-sm font-medium text-gray-700 mb-1">Sub-Category Name (e.g., Brand)</label>
                                <input type="text" id="new-subcategory-name" placeholder="e.g., Epson, Canon, A4" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <button id="add-subcategory-button" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 w-full">
                                Add Sub-Category
                            </button>
                            <p id="subcategory-message" class="text-sm text-red-500 mt-2 hidden"></p>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Manage Sub-Categories</h2>
                        <div class="overflow-x-auto mb-6 max-h-96 overflow-y-auto border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub-Category Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent Category</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                    </tr>
                                </thead>
                                <tbody id="subcategory-list-body" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                        <p id="subcategory-empty-message" class="text-gray-500 text-center py-8 hidden">No sub-categories found.</p>
                    </div>
                </div>
                </div>
                
            <!-- 3. Customers Tab -->
            <div id="customers-tab" class="tab-pane hidden">
                
                <!-- Customer Dashboard -->
                <div class="mb-6 space-y-6">
                    <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">Customer Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Total Customers -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                            <p class="text-sm font-medium text-gray-500">Total Customers</p>
                            <p id="customer-dashboard-total" class="text-3xl font-bold text-blue-700 mt-1">0</p>
                        </div>
                        <!-- Top Customers Chart -->
                        <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Top 5 Customers (by Total Sales)</h3>
                            <div class="relative h-64">
                                <canvas id="customer-dashboard-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Existing Customer Content -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Customer List -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Registered Customers</h2>
                        
                        <input type="text" id="customer-search" placeholder="Search customers by name or contact..." class="w-full md:w-1/2 mb-4 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <div class="overflow-x-auto mb-6 max-h-96 overflow-y-auto border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Number</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                        <!-- NEW: Loyalty Member Column -->
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loyalty Member</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Points</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                    </tr>
                                </thead>
                                <tbody id="customer-list-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Customer rows injected here -->
                                </tbody>
                            </table>
                        </div>
                        <p id="customer-empty-message" class="text-gray-500 text-center py-8 hidden">No registered customers found.</p>
                        <p id="customer-message" class="text-sm text-red-500 mt-4 hidden"></p>

                        <!-- MODIFIED: Add New Customer -->
                        <div class="mt-8 pt-4 border-t border-gray-200">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">Add New Customer</h3>
                            <!-- Changed to vertical stack for new field -->
                            <div class="flex flex-col space-y-3">
                                <input type="text" id="new-customer-name" placeholder="Full Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <input type="text" id="new-customer-contact" placeholder="Contact Number" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <input type="text" id="new-customer-address" placeholder="Address (Optional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">

                                <!-- NEW: Loyalty Opt-in Checkbox -->
                                <div class="flex items-center space-x-2">
                                    <input id="new-customer-joins-loyalty" type="checkbox" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="new-customer-joins-loyalty" class="block text-sm font-medium text-gray-700">Join Loyalty Program</label>
                                </div>

                                <button id="add-customer-button" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 w-full md:w-auto">
                                    Add Customer
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Customer History -->
                    <div id="customer-history-area" class="bg-white p-6 rounded-xl shadow-lg h-full">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Customer Purchase History</h2>
                        <div id="customer-history-list" class="space-y-4 max-h-96 overflow-y-auto">
                            <p id="history-placeholder" class="text-gray-500">Select a customer from the list to view their sales history.</p>
                            <!-- History items injected here -->
                        </div>
                    </div>
                </div>
            </div>

        

            <!-- 4. Inventory Tab -->
            <div id="inventory-tab" class="tab-pane hidden">
                <div class="space-y-6">
                    <!-- Inventory Dashboard -->
                    <div id="inventory-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Dashboard metrics injected here -->
                    </div>
                    
                    <!-- Inventory List & Search -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Current Inventory Stock</h2>
                        
                        <input type="text" id="inventory-search" placeholder="Search materials by name..." class="w-full md:w-1/3 mb-4 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material Name</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub-Category</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Unit Cost</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sale Price</th>
                                        
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit (₱)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Margin (%)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Unit Info</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Inventory rows injected here -->
                                </tbody>
                            </table>
                        </div>
                        <p id="inventory-empty-message" class="text-gray-500 text-center py-8 hidden">No inventory items found. Add one below!</p>
                    </div>

                    <!-- Add New Material -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Add New Material</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="col-span-1 md:col-span-1">
                                <label for="new-material-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                <select id="new-material-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">-- Select Category --</option>
                                    </select>
                            </div>
                            
                            <div class="col-span-1 md:col-span-1">
                                <label for="new-material-subcategory" class="block text-sm font-medium text-gray-700 mb-1">Sub-Category (Optional)</label>
                                <select id="new-material-subcategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">-- Select Sub-Category --</option>
                                    </select>
                            </div>
                            <div class="col-span-1 md:col-span-1">
                                <label for="new-material-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                <input type="text" id="new-material-name" placeholder="e.g., A4 Paper" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>

                            <!-- MODIFIED ROW 2 -->
                            <div class="col-span-1">
                                <label for="new-material-cost" class="block text-sm font-medium text-gray-700 mb-1">Unit Cost (Your Cost | per pc)</label>
                                <input type="number" id="new-material-cost" placeholder="e.g., 1.00" min="0.01" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="col-span-1">
                                <label for="new-material-sale-price" class="block text-sm font-medium text-gray-700 mb-1">Sale Price (Customer Price)</label>
                                <input type="number" id="new-material-sale-price" placeholder="e.g., 1.50" min="0.01" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="col-span-1">
                                <label for="new-material-stock" class="block text-sm font-medium text-gray-700 mb-1">Initial Stock</label>
                                <input type="number" id="new-material-stock" placeholder="Usage Unit Stock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            
                            <!-- MODIFIED ROW 3 -->
                            <div class="col-span-1">
                                <label for="new-material-usage-unit" class="block text-sm font-medium text-gray-700 mb-1">Usage Unit</label>
                                <input type="text" id="new-material-usage-unit" placeholder="e.g., sheet" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            
                            <div class="col-span-1">
                                <label for="new-material-purchase-unit" class="block text-sm font-medium text-gray-700 mb-1">Purchase Unit</label>
                                <input type="text" id="new-material-purchase-unit" placeholder="e.g., ream" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="col-span-1">
                                <label for="new-material-conversion-factor" class="block text-sm font-medium text-gray-700 mb-1">Conversion Factor</label>
                                <input type="number" id="new-material-conversion-factor" placeholder="e.g., 500" min="1" step="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>

                            <div class="col-span-1">
                                <label for="new-material-low-stock" class="block text-sm font-medium text-gray-700 mb-1">Low Stock Alert At</label>
                                <input type="number" id="new-material-low-stock" placeholder="e.g., 10" min="0" value="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">Set to 0 to disable.</p>
                            </div>
                            <div class="col-span-1 md:col-span-3 text-sm text-gray-500 flex items-end pb-2">
                                <span>1 [Purchase Unit] = [Conversion Factor] [Usage Unit] (e.g., 1 ream = 500 sheets)</span>
                            </div>

                        </div>
                        <button id="add-material-button" class="mt-4 w-full md:w-auto flex justify-center py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                            Create Material
                        </button>
                    </div>
                    <!-- NEW: Inventory History Section START -->
                        <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Inventory History</h2>
                            
                            <!-- NEW: Expanded Inventory History Filter Bar -->
                            <div class="flex flex-wrap items-center justify-between gap-4 p-4 bg-gray-50 border border-gray-200 rounded-lg mb-6">
                                
                                <div class="flex flex-wrap items-end gap-4">
                                    <h3 class="text-lg font-medium text-gray-700 w-full mb-2">Filter History:</h3>
                                    <div>
                                        <label for="inventory-history-search" class="block text-sm font-medium text-gray-700">Search</label>
                                        <input type="text" id="inventory-history-search" placeholder="Search item or reason..." class="mt-1 block w-full md:w-auto px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                    </div>

                                    <div>
                                        <label for="inventory-history-type-filter" class="block text-sm font-medium text-gray-700">Type</label>
                                        <select id="inventory-history-type-filter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                            <option value="">-- All Types --</option>
                                            <option value="stock_in">Stock Received</option>
                                            <option value="stock_out">Stock Used</option>
                                            <option value="sale">Sale Deduction</option>
                                            <option value="points_adjustment">Points Adjustment</option>
                                            <option value="low_stock">Low Stock Alert</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label for="inventory-history-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                                        <input type="date" id="inventory-history-start-date" class="mt-1 block rounded-md border-gray-300 shadow-sm p-2 border">
                                    </div>
                                    <div>
                                        <label for="inventory-history-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                                        <input type="date" id="inventory-history-end-date" class="mt-1 block rounded-md border-gray-300 shadow-sm p-2 border">
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-2 pt-5">
                                    <button id="filter-inventory-history-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                                        Apply Filter
                                    </button>
                                    <button id="reset-inventory-history-button" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                                        Reset
                                    </button>
                                    <button id="generate-inventory-history-pdf-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                                        Generate PDF
                                    </button>
                                </div>

                            </div>
                            <!-- END: New Filter Bar -->
                            
                            <div id="inventory-history-list" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- History items will be injected here by JavaScript -->
                            </div>  
                            <p id="inventory-history-empty-message" class="text-gray-500 text-center py-8">
                                No inventory history found.
                            </p>
                        </div>
                        <!-- NEW: Inventory History Section END -->
                </div>
            </div>

                <!-- 5. REPORTS Tab Content -->
                <div id="reports-tab" class="tab-pane hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Sales Transaction History</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Sales Trend (Filtered)</h3>
                        <div class="relative h-64 md:h-80">
                            <canvas id="sales-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Gross Revenue (Subtotal)</p>
                        <p id="reports-gross-revenue" class="text-3xl font-bold text-blue-700 mt-1">₱0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-500">Total Discounts</p>
                        <p id="reports-total-discounts" class="text-3xl font-bold text-red-700 mt-1">₱0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">Total Points Redeemed</p>
                        <p id="reports-total-redeemed" class="text-3xl font-bold text-yellow-700 mt-1">₱0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Net Revenue (Final Total)</p>
                        <p id="reports-net-revenue" class="text-3xl font-bold text-green-700 mt-1">₱0.00</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-emerald-500">
                        <p class="text-sm font-medium text-gray-500">Total Profit (Filtered)</p>
                        <p id="reports-total-profit" class="text-3xl font-bold text-green-700 mt-1">₱0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-gray-500">
                        <p class="text-sm font-medium text-gray-500">Total Sales (Filtered)</p>
                        <p id="reports-total-sales" class="text-3xl font-bold text-gray-700 mt-1">0</p>
                    </div>
                </div>
                        

                    

                    <!-- Date Range Filter -->
                    <div class="flex flex-col gap-4 p-4 bg-blue-50 border border-blue-200 rounded-lg mb-6">
                        
                        <h3 class="text-lg font-medium text-blue-700">Filter Transactions:</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                                <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                                <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            </div>
                            <div>
                                <label for="reports-payment-method-filter" class="block text-sm font-medium text-gray-700">Payment Method</label>
                                <select id="reports-payment-method-filter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                    <option value="">-- All Methods --</option>
                                    <option value="Cash">Cash</option>
                                    <option value="GCash">GCash</option>
                                    <option value="Maya">Maya</option>
                                    <option value="GoTyme">GoTyme</option>
                                    <option value="MariBank">MariBank</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Card">Card</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="reports-search" class="block text-sm font-medium text-gray-700">Search</label>
                                <input type="text" id="reports-search" placeholder="Search customer or items..." class="mt-1 block w-full md:w-auto px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 pt-4 border-t border-blue-100">
                            <button id="filter-reports-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                                Apply Filter
                            </button>
                            <button id="reset-reports-button" class="bg-red-400 hover:bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                                Reset
                            </button>
                            <button id="generate-pdf-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                                Generate PDF
                            </button>
                        </div>
                    </div>

                    <!-- NEW: Customer Type Filter Toggles -->
                    <div class="flex flex-wrap items-center gap-2 p-2 rounded-md border-gray-300 border bg-white">
                        <span class="text-sm font-medium text-gray-700 dark:text-black-200 mr-2">Show Sales From:</span>
                        <button data-customer-filter="all" class="customer-report-filter-button px-3 py-1 text-sm font-medium rounded-md bg-indigo-600 text-white">All Customers</button>
                        <button data-customer-filter="registered" class="customer-report-filter-button px-3 py-1 text-sm font-medium rounded-md bg-white">Registered Customers Only</button>
                        <button data-customer-filter="temporary" class="customer-report-filter-button px-3 py-1 text-sm font-medium rounded-md bg-white">Temporary Customers Only</button>
                    </div>

                    

                    <!-- Reports Table -->
                    <div class="overflow-x-auto bg-white rounded-xl shadow-lg border max-h-[500px] overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Name</th>
                                        <!-- NEW: Customer Type Column -->
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items/Quantities</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Cost (₱)</th>
                                        <!-- NEW: Profit Column -->
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Profit (₱)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ref #</th>
                                        <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                    </tr>
                                </thead>
                            <tbody id="reports-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Sales rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="reports-empty-message" class="text-center text-gray-500 mt-4 hidden">No transactions found for the selected range.</p>
                </div>

            </div>
        </div>
    </div>

    <!-- Receipt Print Area (Hidden in normal view) -->
    <div id="receipt-print-area" class="hidden max-w-sm mx-auto p-6 bg-white border border-gray-300 rounded-lg shadow-2xl">
        
        <div class="text-center mb-4">
            <img id="receipt-logo" src="" alt="Business Logo" class="hidden mx-auto">
        </div>
        <h1 id="receipt-business-name" class="text-xl font-bold text-center mb-2"> <br>(Acknowledgement Receipt)</h1>
        
        <div id="receipt-contact-info-wrapper">
            <p id="receipt-business-info" class="text-center text-sm mb-4 border-b pb-2">Your Address <br>Your Contact</p>
        </div>
        <div class="space-y-1 text-sm mb-4">
            <p><strong>Receipt Date:</strong> <span id="receipt-date"></span></p>
            <p><strong>Customer:</strong> <span id="receipt-customer-name"></span></p>
            <p><strong>Transaction ID:</strong> <span id="receipt-id"></span></p>
            <!-- NEW: Payment Method on Receipt -->
            <p><strong>Payment Method:</strong> <span id="receipt-payment-method"></span></p>
        </div>

        <h2 class="text-lg font-semibold border-t pt-2 mb-2">Items:</h2>
        <div class="space-y-1 text-sm mb-4" id="receipt-materials">
            <!-- Items go here -->
        </div>

        <!-- MODIFIED: Receipt Total Section -->
        <div class="border-t pt-2 mt-4 space-y-1">
            <div class="flex justify-between text-sm">
                <span>Subtotal:</span>
                <span id="receipt-subtotal">₱0.00</span>
            </div>
            <div class="flex justify-between text-sm font-medium text-red-600">
                <span>Discount:</span>
                <span id="receipt-discount">- ₱0.00</span>
            </div>
            <div id="receipt-redeemed-line" class="hidden flex justify-between text-sm font-medium text-red-600">
                <span>Points Redeemed:</span>
                <span id="receipt-points-redeemed">- ₱0.00</span>
            </div>
            <div class="border-t pt-1 mt-1 flex justify-between text-md font-bold">
                <span>TOTAL:</span>
                <span id="receipt-total-cost">₱0.00</span>
            </div>
        </div>
        <div id="receipt-points-summary" class="hidden border-t pt-2 mt-2 text-xs text-gray-700 dark:text-gray-300">
            <p class="text-center font-semibold mb-1">Loyalty Points Summary</p>
            <div class="flex justify-between">
                <span>Points Earned:</span>
                <span id="receipt-points-earned" class="font-medium">0</span>
            </div>
            <div class="flex justify-between">
                <span>New Total Points:</span>
                <span id="receipt-total-points" class="font-bold">0</span>
            </div>
        </div>
        <!-- END: Modified Section -->

        <p class="text-xs text-center font-semibold mt-4">Thank you!</p>    
                        <p class="text-xs text-center">Please come again.</p>
    </div>

        <!-- Modals -->
        
        <!-- Receive Stock Modal -->
        <div id="receive-stock-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Add Stock to Inventory</h3>
                <form id="receive-stock-form" class="space-y-4">
                    <div>
                        <label for="receive-material-select" class="block text-sm font-medium text-gray-700">Material</label>
                        <select id="receive-material-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div>
                        <label for="receive-quantity" class="block text-sm font-medium text-gray-700">Quantity (in <span id="receive-purchase-unit" class="font-semibold">Unit</span>)</label>
                        <input type="number" id="receive-quantity" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p id="receive-conversion-info" class="text-xs text-gray-600 text-center border p-2 rounded-lg bg-gray-50"></p>
                    
                    <div>
                        <label for="receive-reason" class="block text-sm font-medium text-gray-700">Reason (Optional)</label>
                        <input type="text" id="receive-reason" placeholder="e.g., Supplier restock" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="window.closeReceiveStockModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150">
                            Confirm Receipt
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Use Material Modal -->
        <div id="use-material-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Deduct Material from Stock</h3>
                <form id="use-material-form" class="space-y-4">
                    <div>
                        <label for="use-material-select" class="block text-sm font-medium text-gray-700">Material</label>
                        <select id="use-material-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div>
                        <label for="use-quantity" class="block text-sm font-medium text-gray-700">Quantity (in <span id="use-usage-unit" class="font-semibold">Unit</span>)</label>
                        <input type="number" id="use-quantity" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p id="use-stock-info" class="text-sm font-medium text-center border p-2 rounded-lg bg-gray-50"></p>
                    
                    <div>
                        <label for="use-reason" class="block text-sm font-medium text-gray-700">Reason (Optional)</label>
                        <input type="text" id="use-reason" placeholder="e.g., Damaged item, Internal use" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="window.closeUseMaterialModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">
                            Confirm Usage
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Material Modal -->
        <div id="edit-material-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Edit Material Details</h3>
                <form id="edit-material-form" class="space-y-4">
                    <input type="hidden" id="edit-material-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-material-name" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="edit-material-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="edit-material-stock" class="block text-sm font-medium text-gray-700">Current Stock</label>
                            <input type="number" id="edit-material-stock" min="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <div>
                        <label for="edit-material-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="edit-material-category" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                            </select>
                    </div>

                    <div>
                        <label for="edit-material-subcategory" class="block text-sm font-medium text-gray-700">Sub-Category (Optional)</label>
                        <select id="edit-material-subcategory" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                            </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div>
                            <label for="edit-material-cost" class="block text-sm font-medium text-gray-700">Unit Cost (Usage)</label>
                            <input type="number" id="edit-material-cost" min="0.01" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="edit-material-sale-price" class="block text-sm font-medium text-gray-700">Sale Price (Usage)</label>
                            <input type="number" id="edit-material-sale-price" min="0.01" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="edit-material-usage-unit" class="block text-sm font-medium text-gray-700">Usage Unit</label>
                            <input type="text" id="edit-material-usage-unit" required placeholder="e.g., sheet" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                         <div>
                            <label for="edit-material-purchase-unit" class="block text-sm font-medium text-gray-700">Purchase Unit</label>
                            <input type="text" id="edit-material-purchase-unit" required placeholder="e.g., ream" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                     <div>
                        <label for="edit-material-conversion-factor" class="block text-sm font-medium text-gray-700">Conversion Factor</label>
                        <input type="number" id="edit-material-conversion-factor" min="1" step="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">1 [Purchase Unit] = [Conversion Factor] [Usage Unit]</p>
                    </div>

                    <div>
                        <label for="edit-material-low-stock" class="block text-sm font-medium text-gray-700">Low Stock Alert At</label>
                        <input type="number" id="edit-material-low-stock" min="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">Set to 0 to disable alerts.</p>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="window.closeEditMaterialModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Customer Modal -->
        <div id="edit-customer-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Edit Customer Details</h3>
                <form id="edit-customer-form" class="space-y-4">
                    <input type="hidden" id="edit-customer-id">
                    <div>
                        <label for="edit-customer-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="edit-customer-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-customer-contact" class="block text-sm font-medium text-gray-700">Contact Number</label>
                        <input type="text" id="edit-customer-contact" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-customer-address" class="block text-sm font-medium text-gray-700">Address</label>
                        <input type="text" id="edit-customer-address" placeholder="Address (Optional)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- NEW: Loyalty Opt-in Checkbox -->
                    <div class="flex items-center space-x-2 pt-2">
                        <input id="edit-customer-joins-loyalty" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="edit-customer-joins-loyalty" class="block text-sm font-medium text-gray-700">Is Loyalty Program Member</label>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="window.closeEditCustomerModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- NEW: Confirm Inventory Delete Modal (with Password) -->
    <div id="confirm-inventory-delete-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-red-700">Confirm Deletion</h3>
            <p id="delete-inventory-message" class="text-gray-700 mb-4">Are you sure? This will permanently delete the item <strong id="delete-inventory-name-span"></strong>.</p>

            <div class="mt-4">
                <label for="delete-inventory-password" class="block text-sm font-medium text-gray-700">Enter Your Password to Confirm</label>
                <input type="password" id="delete-inventory-password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500">
                <p id="delete-inventory-error-message" class="text-sm text-red-500 mt-2 hidden"></p>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button id="delete-inventory-confirm-no" type="button" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                    No, Cancel
                </button>
                <button id="delete-inventory-confirm-yes" type="button" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">
                    Yes, Delete Item
                </button>
            </div>
        </div>
    </div>

        <!-- NEW: Edit Category Modal -->
        <div id="edit-category-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Edit Category Name</h3>
                <form id="edit-category-form" class="space-y-4">
                    <input type="hidden" id="edit-category-id">
                    <div>
                        <label for="edit-category-name" class="block text-sm font-medium text-gray-700">Category Name</label>
                        <input type="text" id="edit-category-name" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="window.closeEditCategoryModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- NEW: Confirm Category Delete Modal (with Password) -->
        <div id="confirm-category-delete-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-red-700">Confirm Deletion</h3>
                <p id="delete-category-message" class="text-gray-700 mb-4">Are you sure? This will permanently delete the category <strong id="delete-category-name-span"></strong> AND all associated inventory items.</p>
                
                <div class="mt-4">
                    <label for="delete-category-password" class="block text-sm font-medium text-gray-700">Enter Your Password to Confirm</label>
                    <input type="password" id="delete-category-password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500">
                    <p id="delete-category-error-message" class="text-sm text-red-500 mt-2 hidden"></p>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button id="delete-category-confirm-no" type="button" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                        No, Cancel
                    </button>
                    <button id="delete-category-confirm-yes" type="button" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">
                        Yes, Delete Everything
                    </button>
                </div>
            </div>
        </div>


        <!-- MODIFIED: Confirm Void/Delete Modal with Password -->
        <div id="confirm-void-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-red-700">Confirm Void</h3>
                <p id="void-message" class="text-gray-700 mb-4">Are you sure you want to void this transaction? This action cannot be undone.</p>
                
                <!-- NEW: Password field for void confirmation -->
                <div class="mt-4">
                    <label for="void-password" class="block text-sm font-medium text-gray-700">Enter Your Password to Confirm</label>
                    <input type="password" id="void-password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500">
                    <p id="void-error-message" class="text-sm text-red-500 mt-2 hidden"></p>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button id="void-confirm-no" type="button" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                        No, Cancel
                    </button>
                    <button id="void-confirm-yes" type="button" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">
                        Yes, Void
                    </button>
                </div>
            </div>
        </div>
        <!-- NEW: Password field for void confirmation -->
        <div id="confirm-customer-delete-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-red-700">Confirm Deletion</h3>
                <p id="delete-customer-message" class="text-gray-700 mb-4">Are you sure? This will permanently delete the customer <strong id="delete-customer-name-span"></strong>.</p>
                
                <div class="mt-4">
                    <label for="delete-customer-password" class="block text-sm font-medium text-gray-700">Enter Your Password to Confirm</label>
                    <input type="password" id="delete-customer-password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500">
                    <p id="delete-customer-error-message" class="text-sm text-red-500 mt-2 hidden"></p>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button id="delete-customer-confirm-no" type="button" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                        No, Cancel
                    </button>
                    <button id="delete-customer-confirm-yes" type="button" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">
                        Yes, Delete Customer
                    </button>
                </div>
            </div>
        </div>

        <div id="edit-subcategory-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Edit Sub-Category</h3>
                <form id="edit-subcategory-form" class="space-y-4">
                    <input type="hidden" id="edit-subcategory-id">

                    <div>
                        <label for="edit-subcategory-name" class="block text-sm font-medium text-gray-700">Sub-Category Name</label>
                        <input type="text" id="edit-subcategory-name" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="edit-subcategory-parent" class="block text-sm font-medium text-gray-700">Parent Category</label>
                        <select id="edit-subcategory-parent" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                            </select>
                        <p class="text-xs text-gray-500 mt-1">Warning: Changing the parent will also update all inventory items in this sub-category.</p>
                    </div>

                    <p id="edit-subcategory-message" class="text-sm text-red-500 hidden"></p>

                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="window.closeEditSubCategoryModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="adjust-points-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-2 text-gray-800">Adjust Loyalty Points</h3>
                <p class="text-sm text-gray-600 mb-4">For: <strong id="adjust-points-customer-name"></strong></p>
                <form id="adjust-points-form" class="space-y-4">
                    <input type="hidden" id="adjust-points-customer-id">
                    <input type="hidden" id="adjust-points-current-points">
                    
                    <div>
                        <label for="adjust-points-amount" class="block text-sm font-medium text-gray-700">Points to Add/Subtract</label>
                        <input type="number" id="adjust-points-amount" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 50 or -10">
                    </div>
                    <div>
                        <label for="adjust-points-reason" class="block text-sm font-medium text-gray-700">Reason</label>
                        <input type="text" id="adjust-points-reason" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Birthday bonus, Return correction">
                    </div>
                    
                    <p id="adjust-points-preview" class="text-center font-medium p-2 rounded-lg bg-indigo-50 text-indigo-700"></p>
                    <p id="adjust-points-message" class="text-sm text-red-500 hidden"></p>

                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="window.closeAdjustPointsModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                            Confirm Adjustment
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div id="resume-sale-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Held Sales</h3>
                <div class="overflow-x-auto max-h-96 overflow-y-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Held At</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                                <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody id="held-sales-list-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                <p id="held-sales-empty-message" class="text-gray-500 text-center py-8 hidden">No sales are currently on hold.</p>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="window.closeResumeSaleModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <div id="receive-payment-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Confirm Payment</h3>
                <form id="receive-payment-form" class="space-y-4">
                    <input type="hidden" id="receive-payment-sale-id">
                    
                    <p class="text-sm text-gray-600">You are about to complete sale <strong id="receive-payment-sale-name"></strong> for <strong id="receive-payment-sale-total"></strong>.</p>

                    <div>
                        <label for="receive-payment-ref" class="block text-sm font-medium text-gray-700">Reference Number</label>
                        <input type="text" id="receive-payment-ref" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., GCash Ref No.">
                    </div>
                    
                    <p id="receive-payment-message" class="text-sm text-red-500 hidden"></p>

                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="window.closeReceivePaymentModal()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100">
                            Cancel
                        </button>
                        <button type="submit" class="py-2 px-4 border border-transparent rounded-lg text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150">
                            Confirm & Print Receipt
                        </button>
                    </div>
                </form>
            </div>
        </div>



    <!-- Firebase Initialization and Main Logic -->
    <script type="module">
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'print-pos-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD0lStiB4-FwDoR9K69aFo9MCqFdsyKqQQ",
            authDomain: "print-98e0f.firebaseapp.com",
            projectId: "print-98e0f",
            storageBucket: "print-98e0f.firebasestorage.app",
            messagingSenderId: "993963477496",
            appId: "1:993963477496:web:c283778ba82296ee722e0d",
        };

        // Firebase CDN Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, reauthenticateWithCredential, EmailAuthProvider, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // MODIFIED: Added query, where, getDocs for cascade delete and category edit
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, Timestamp, query, where, getDocs, getDoc, setDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug'); 

        let app, db, auth, userId = null;
        let inventoryData = [];
        let salesData = [];
        let customersData = [];
        let categoriesData = []; // NEW: For categories
        let currentFilteredSales = []; // <-- ADD THIS LINE
        let currentFilteredInventoryHistory = []; // <-- ADD THIS
        let archivedCategoriesData = [];
        // NEW: For Inventory History
        let inventoryHistoryData = [];
        let archivedInventoryData = [];
        let archivedCustomersData = [];
        let currentItems = [];
        let selectedCustomerId = null;
        let businessSettings = {}; // NEW: For settings
        let isSignUpMode = false;
        let isDiscountPercent = false; // <-- NEW
        let currentDashboardFilter = 'all'; // <-- ADD THIS LINE
        let heldSales = []; // <-- ADD THIS
        let pendingSalesData = []; // <-- ADD THIS
        let subCategoriesData = []; // <-- ADD THIS
        let salesChartInstance = null; // For Reports Chart
        let customerChartInstance = null; // NEW: For Customer Dashboard Chart
        let currentHistoryCustomerId = null; 
        let activeListeners = []; // <-- ADD THIS LINE
        let reportsCustomerType = 'all'; // <-- NEW: For report filtering
                
        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen');
        const mainContent = document.getElementById('main-content');
        const userInfoSpan = document.getElementById('user-info');
        const inventoryTableBody = document.getElementById('inventory-table-body');
        const inventoryEmptyMessage = document.getElementById('inventory-empty-message');

        // --- NEW: Pending Sales DOM ---
        const pendingSalesCountBadge = document.getElementById('pending-sales-count-badge');
        const pendingSalesTableBody = document.getElementById('pending-sales-table-body');
        const pendingSalesEmptyMessage = document.getElementById('pending-sales-empty-message');
        const receivePaymentModal = document.getElementById('receive-payment-modal');
        const receivePaymentForm = document.getElementById('receive-payment-form');
        const receivePaymentSaleId = document.getElementById('receive-payment-sale-id');
        const receivePaymentSaleName = document.getElementById('receive-payment-sale-name');
        const receivePaymentSaleTotal = document.getElementById('receive-payment-sale-total');
        const receivePaymentRefInput = document.getElementById('receive-payment-ref');
        const receivePaymentMessage = document.getElementById('receive-payment-message');
        // --- END: New DOM ---

        // --- ADD THESE 3 LINES BACK ---
        const posItemsContainer = document.getElementById('pos-items-container');
        const totalCostSpan = document.getElementById('total-cost');
        const posSummaryItems = document.getElementById('pos-summary-items');
        // --- END OF FIX ---

        // --- NEW: Hold/Resume DOM Elements ---
        const holdSaleButton = document.getElementById('hold-sale-button');
        const resumeSaleButton = document.getElementById('resume-sale-button');
        const heldSaleCountBadge = document.getElementById('held-sale-count-badge');
        const resumeSaleModal = document.getElementById('resume-sale-modal');
        const heldSalesListBody = document.getElementById('held-sales-list-body');
        const heldSalesEmptyMessage = document.getElementById('held-sales-empty-message');
        // --- END: New DOM ---
        const posMessage = document.getElementById('pos-message');
        const processSaleButton = document.getElementById('process-sale-button');
        const customerNameInput = document.getElementById('customer-name');
        const reportsTableBody = document.getElementById('reports-table-body');
        const reportsEmptyMessage = document.getElementById('reports-empty-message');
        const reportsSearchInput = document.getElementById('reports-search'); // <-- ADD THIS
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const posCustomerSelector = document.getElementById('pos-customer-selector');
        const inventoryDashboard = document.getElementById('inventory-dashboard'); 
        const inventorySearchInput = document.getElementById('inventory-search'); 
        const posCustomerSearchInput = document.getElementById('pos-customer-search'); 
        // NEW: Confirm Customer Delete Modal DOM
        const confirmCustomerDeleteModal = document.getElementById('confirm-customer-delete-modal');
        const deleteCustomerMessage = document.getElementById('delete-customer-message');
        const deleteCustomerNameSpan = document.getElementById('delete-customer-name-span');
        const deleteCustomerPasswordInput = document.getElementById('delete-customer-password');
        const deleteCustomerErrorMessage = document.getElementById('delete-customer-error-message');
        const deleteCustomerConfirmYes = document.getElementById('delete-customer-confirm-yes');
        const deleteCustomerConfirmNo = document.getElementById('delete-customer-confirm-no');
        // NEW: Confirm Inventory Delete Modal DOM
        const confirmInventoryDeleteModal = document.getElementById('confirm-inventory-delete-modal');
        const deleteInventoryMessage = document.getElementById('delete-inventory-message');
        const deleteInventoryNameSpan = document.getElementById('delete-inventory-name-span');
        const deleteInventoryPasswordInput = document.getElementById('delete-inventory-password');
        const deleteInventoryErrorMessage = document.getElementById('delete-inventory-error-message');
        const deleteInventoryConfirmYes = document.getElementById('delete-inventory-confirm-yes');
        const deleteInventoryConfirmNo = document.getElementById('delete-inventory-confirm-no');

        // --- NEW: Adjust Points Modal DOM ---
        const adjustPointsModal = document.getElementById('adjust-points-modal');
        const adjustPointsForm = document.getElementById('adjust-points-form');
        const adjustPointsCustomerName = document.getElementById('adjust-points-customer-name');
        const adjustPointsCustomerId = document.getElementById('adjust-points-customer-id');
        const adjustPointsCurrentPoints = document.getElementById('adjust-points-current-points');
        const adjustPointsAmount = document.getElementById('adjust-points-amount');
        const adjustPointsReason = document.getElementById('adjust-points-reason');
        const adjustPointsPreview = document.getElementById('adjust-points-preview');
        const adjustPointsMessage = document.getElementById('adjust-points-message');
        // --- END: New DOM ---


        // Auth DOM elements
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const authToggle = document.getElementById('auth-toggle');
        const authMessage = document.getElementById('auth-message');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');

        // Customer Tab DOM
        const customerListBody = document.getElementById('customer-list-body');
        const customerEmptyMessage = document.getElementById('customer-empty-message');
        const customerMessage = document.getElementById('customer-message');
        const customerHistoryArea = document.getElementById('customer-history-area');
        const historyPlaceholder = document.getElementById('history-placeholder');
        const customerHistoryList = document.getElementById('customer-history-list');
        const customerSearchInput = document.getElementById('customer-search'); // <-- ADD THIS
        const customerDashboardTotal = document.getElementById('customer-dashboard-total');

        // Category Tab DOM
        const categoryListBody = document.getElementById('category-list-body');
        const categoryEmptyMessage = document.getElementById('category-empty-message');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const addCategoryButton = document.getElementById('add-category-button');
        const categoryMessage = document.getElementById('category-message');
        // --- NEW: Sub-Category DOM ---
        const parentCategorySelect = document.getElementById('parent-category-select');
        const newSubCategoryNameInput = document.getElementById('new-subcategory-name');
        const addSubCategoryButton = document.getElementById('add-subcategory-button');
        const subCategoryMessage = document.getElementById('subcategory-message');
        const subCategoryListBody = document.getElementById('subcategory-list-body');
        const subCategoryEmptyMessage = document.getElementById('subcategory-empty-message');
        // --- END: New DOM ---
        // Archive Tab DOM (NEW)
        const archivedCategoryListBody = document.getElementById('archived-category-list-body');
        const archivedCategoryEmptyMessage = document.getElementById('archived-category-empty-message');
        const archivedInventoryListBody = document.getElementById('archived-inventory-list-body');
        // NEW: Inventory History DOM
        const inventoryHistoryList = document.getElementById('inventory-history-list');
        const inventoryHistoryEmptyMessage = document.getElementById('inventory-history-empty-message');
        // --- NEW: History Filter DOM ---
        const inventoryHistorySearch = document.getElementById('inventory-history-search');
        const inventoryHistoryTypeFilter = document.getElementById('inventory-history-type-filter');
        const generateInventoryHistoryPdfButton = document.getElementById('generate-inventory-history-pdf-button');
        // --- END: New DOM ---
        const archivedInventoryEmptyMessage = document.getElementById('archived-inventory-empty-message');
        const archivedCustomerListBody = document.getElementById('archived-customer-list-body');
        const archivedCustomerEmptyMessage = document.getElementById('archived-customer-empty-message');

        // Dashboard Tab DOM
        const dashboardSalesAmount = document.getElementById('dashboard-sales-amount');
        const dashboardProductCount = document.getElementById('dashboard-product-count');
        const dashboardCategoryCount = document.getElementById('dashboard-category-count');
        const dashboardHighestSelling = document.getElementById('dashboard-highest-selling');
        const dashboardRecentlyAdded = document.getElementById('dashboard-recently-added');

        // Inventory Form Category Select
        const newMaterialCategorySelect = document.getElementById('new-material-category');

        // Modals
        const receiveStockModal = document.getElementById('receive-stock-modal');
        const receiveMaterialSelect = document.getElementById('receive-material-select');
        const receivePurchaseUnit = document.getElementById('receive-purchase-unit');
        const receiveConversionInfo = document.getElementById('receive-conversion-info');
        const receiveQuantityInput = document.getElementById('receive-quantity');
        
        const useMaterialModal = document.getElementById('use-material-modal');
        const useMaterialSelect = document.getElementById('use-material-select');
        const useUsageUnit = document.getElementById('use-usage-unit');
        const useStockInfo = document.getElementById('use-stock-info');
        const useQuantityInput = document.getElementById('use-quantity');
        const editMaterialModal = document.getElementById('edit-material-modal'); 

        // Edit Customer Modal DOM
        const editCustomerModal = document.getElementById('edit-customer-modal');
        const editCustomerForm = document.getElementById('edit-customer-form');
        const editCustomerId = document.getElementById('edit-customer-id');
        const editCustomerName = document.getElementById('edit-customer-name');
        const editCustomerContact = document.getElementById('edit-customer-contact');
        const editCustomerAddress = document.getElementById('edit-customer-address');
        const editCustomerJoinsLoyalty = document.getElementById('edit-customer-joins-loyalty'); // <-- ADD THIS

        // NEW: Edit Category Modal DOM
        const editCategoryModal = document.getElementById('edit-category-modal');
        const editCategoryForm = document.getElementById('edit-category-form');
        const editCategoryId = document.getElementById('edit-category-id');
        const editCategoryName = document.getElementById('edit-category-name');

        // NEW: Confirm Category Delete Modal DOM
        const confirmCategoryDeleteModal = document.getElementById('confirm-category-delete-modal');
        const deleteCategoryMessage = document.getElementById('delete-category-message');
        const deleteCategoryNameSpan = document.getElementById('delete-category-name-span');
        const deleteCategoryPasswordInput = document.getElementById('delete-category-password');
        const deleteCategoryErrorMessage = document.getElementById('delete-category-error-message');
        const deleteCategoryConfirmYes = document.getElementById('delete-category-confirm-yes');
        const deleteCategoryConfirmNo = document.getElementById('delete-category-confirm-no');


        // Void Modal DOM
        const confirmVoidModal = document.getElementById('confirm-void-modal');
        const voidMessage = document.getElementById('void-message');
        const voidConfirmYes = document.getElementById('void-confirm-yes');
        const voidConfirmNo = document.getElementById('void-confirm-no');
        const voidPasswordInput = document.getElementById('void-password'); 
        const voidErrorMessage = document.getElementById('void-error-message'); 

        // NEW: Settings Tab DOM
        const settingsBusinessName = document.getElementById('settings-business-name');
        const settingsBusinessAddress = document.getElementById('settings-business-address');
        const settingsBusinessContact = document.getElementById('settings-business-contact');
        const settingsLoyaltyRate = document.getElementById('settings-loyalty-rate'); // <-- ADD THIS
        const settingsDefaultPaymentMethod = document.getElementById('settings-default-payment-method'); // <-- ADD THIS
        
        // --- NEW: Receipt Settings DOM ---
        const settingsLogoUrl = document.getElementById('settings-logo-url');
        const settingsLogoSize = document.getElementById('settings-logo-size'); // <-- ADD THIS
        const settingsFontSize = document.getElementById('settings-font-size');
        const settingsShowContact = document.getElementById('settings-show-contact');
        const settingsShowLoyalty = document.getElementById('settings-show-loyalty');
        // --- END: New DOM ---

        const saveSettingsButton = document.getElementById('save-settings-button');
        const storeSettingsMessage = document.getElementById('store-settings-message'); // <-- MODIFIED ID

        // NEW: Security Sub-tab DOM
        const securityOldPassword = document.getElementById('security-old-password');
        const securityNewPassword = document.getElementById('security-new-password');
        const securityConfirmPassword = document.getElementById('security-confirm-password');
        const changePasswordButton = document.getElementById('change-password-button');
        const securityMessage = document.getElementById('security-message');

        // NEW: Receipt DOM
        const receiptBusinessName = document.getElementById('receipt-business-name');
        const receiptBusinessInfo = document.getElementById('receipt-business-info');
        const receiptPaymentMethod = document.getElementById('receipt-payment-method'); // <-- NEW
        
        // NEW: POS Payment
        const posPaymentMethod = document.getElementById('pos-payment-method'); // <-- NEW
        
        // NEW: POS Discount
        const posSubtotal = document.getElementById('pos-subtotal');
        const posDiscountInput = document.getElementById('pos-discount');
        const posDiscountLabel = document.getElementById('pos-discount-label'); // <-- NEW
        const posDiscountToggle = document.getElementById('pos-discount-toggle'); // <-- NEW

            const receiptSubtotal = document.getElementById('receipt-subtotal');
            const receiptDiscount = document.getElementById('receipt-discount');
            const receiptTotalCost = document.getElementById('receipt-total-cost'); // <-- FIX: Add this line

        // NEW: Theme Toggle
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
            
        // NEW: Connection Status
        const connectionStatusBanner = document.getElementById('connection-status-banner');
        // NEW: Loyalty Points
        const posCustomerPointsDisplay = document.getElementById('pos-customer-points-display');
        const posCustomerPoints = document.getElementById('pos-customer-points');

        // NEW: Redeem Points
        const posRedeemPointsContainer = document.getElementById('pos-redeem-points-container');
        const posRedeemPointsInput = document.getElementById('pos-redeem-points');
        const posCustomerAvailablePoints = document.getElementById('pos-customer-available-points');

        // NEW: Receipt Points
        const receiptRedeemedLine = document.getElementById('receipt-redeemed-line');
        const receiptPointsRedeemed = document.getElementById('receipt-points-redeemed');
        const receiptPointsSummary = document.getElementById('receipt-points-summary');
        const receiptPointsEarned = document.getElementById('receipt-points-earned');
        const receiptTotalPoints = document.getElementById('receipt-total-points');
        
            

        // --- Utility Functions ---

        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        const formatCurrency = (amount) => {
            return `₱${Number(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
        };

        // --- NEW: Dashboard Filter Date Helper ---
        const getFilterDates = (filter) => {
            const now = new Date();
            let start = new Date(now);
            let end = new Date(now);

            switch (filter) {
                case 'today':
                    start.setHours(0, 0, 0, 0);
                    end.setHours(23, 59, 59, 999);
                    break;
                case 'week':
                    // Assumes Sunday is the first day of the week
                    const firstDayOfWeek = now.getDate() - now.getDay(); 
                    start = new Date(now.setDate(firstDayOfWeek));
                    start.setHours(0, 0, 0, 0);
                    
                    // Set end to Saturday
                    end = new Date(start); 
                    end.setDate(end.getDate() + 6); 
                    end.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    // First day of the current month
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    start.setHours(0, 0, 0, 0);
                    
                    // Last day of the current month
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0); 
                    end.setHours(23, 59, 59, 999);
                    break;
                case 'all':
                default:
                    return { start: null, end: null };
            }
            return { start, end };
        };
        // --- END: New Helper ---

        // --- NEW: Loading Spinner Helpers ---
        const spinnerIcon = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>`;
        
        // Helper to show loading state
        function showButtonLoading(button, loadingText = 'Processing...') {
            if (!button) return;
            // Store original content if it's not already stored
            if (!button.dataset.originalContent) {
                button.dataset.originalContent = button.innerHTML;
            }
            button.disabled = true;
            // Add flex and items-center to center the spinner
            button.classList.add('opacity-75', 'cursor-not-allowed', 'flex', 'items-center', 'justify-center');
            button.innerHTML = `${spinnerIcon} ${loadingText}`;
        }

        // Helper to hide loading state
        function hideButtonLoading(button) {
            if (!button || !button.dataset.originalContent) return;
            // Restore original content from dataset
            button.innerHTML = button.dataset.originalContent;
            button.disabled = false;
            button.classList.remove('opacity-75', 'cursor-not-allowed', 'flex', 'items-center', 'justify-center');
            // We can clear the stored content
            delete button.dataset.originalContent;
        }
        // --- END: New Helpers ---

        // --- Firebase Paths ---

        const getInventoryCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/inventory`;
        const getSalesCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/sales`;
        const getCustomersCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/customers`;
        const getCategoriesCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/categories`; // NEW
        const getArchivedCategoriesCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/archived_categories`;
        const getArchivedInventoryCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/archived_inventory`;
        // NEW: For Inventory History
        const getInventoryHistoryCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/inventory_history`; // <-- ADD THIS FIX
        const getPendingSalesCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/pending_sales`; // <-- ADD THIS
        const getSubCategoriesCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/subcategories`; // <-- ADD THIS
        const getArchivedCustomersCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/archived_customers`;
        // NEW: Settings path (single document)
        const getSettingsDocPath = (uid) => `/artifacts/${appId}/users/${uid}/settings/business_info`;

        // --- Authentication Logic ---

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            if (isSignUpMode) {
                authTitle.textContent = 'Sign Up';
                authButton.textContent = 'Create Account';
                authToggle.textContent = 'Already have an account? Log In';
            } else {
                authTitle.textContent = 'Log In';
                authButton.textContent = 'Log In';
                authToggle.textContent = 'Need an account? Sign Up';
            }
            authMessage.classList.add('hidden');
        }
        authToggle.addEventListener('click', toggleAuthMode);

        async function handleAuthSubmit(e) {
            e.preventDefault();
            authMessage.classList.add('hidden');
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            if (!email || password.length < 6) {
                authMessage.textContent = 'Please enter a valid email and a password of at least 6 characters.';
                authMessage.classList.remove('hidden');
                return;
            }

            showButtonLoading(authButton, isSignUpMode ? 'Creating...' : 'Logging In...');

            try {
                if (isSignUpMode) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    authMessage.textContent = 'Account created and logged in!';
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    authMessage.textContent = 'Logged in successfully!';
                }
                
                authMessage.classList.remove('text-red-500');
                authMessage.classList.add('text-green-500');
                authMessage.classList.remove('hidden');

            } catch (error) {
                console.error("Authentication Error:", error);
                let message = 'An unknown error occurred.';
                if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password.';
                } else if (error.code === 'auth/user-not-found') {
                    message = 'No account found with this email.';
                } else if (error.code === 'auth/email-already-in-use') {
                    message = 'This email is already in use.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Password must be at least 6 characters.';
                }
                
                authMessage.textContent = message;
                authMessage.classList.remove('hidden');
                authMessage.classList.add('text-red-500');
            } finally {
                hideButtonLoading(authButton);
            }
        }
        authForm.addEventListener('submit', handleAuthSubmit);


        // --- Application State Management ---

        const setTab = (tabId) => {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${tabId}-tab`).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('bg-indigo-600', 'text-white', 'font-semibold');
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'font-semibold');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });

            // Reset history view when changing tabs
            if (tabId !== 'customers') {
                customerHistoryList.innerHTML = '';
                historyPlaceholder.classList.remove('hidden');
                currentHistoryCustomerId = null; 
            }
            if (tabId === 'archive') {
                renderArchiveTab();
            }
            
            // Refresh data when the tab is opened
            if (tabId === 'dashboard') {
                renderDashboard();
            }
            if (tabId === 'categories') {
                renderCategoryList();
            }
            if (tabId === 'reports') {
                renderReportsTable();
            }
            if (tabId === 'inventory') { 
                 renderInventoryDashboard();
                 renderInventoryTable();
            }
            if (tabId === 'customers') {
                renderCustomerDashboard();
            }
        };



        // --- Authentication and Initialization ---

        function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                console.debug("Firebase services initialized.");
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.debug("User successfully authenticated with UID:", userId);
                        
                        authScreen.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        userInfoSpan.textContent = `Email Account User:  (${user.email})`;
                        
                        listenToInventory(user.uid);
                        listenToSales(user.uid);
                        listenToCustomers(user.uid);
                        listenToCategories(user.uid);
                        listenToArchivedCategories(user.uid);
                        listenToArchivedInventory(user.uid);
                        listenToArchivedCustomers(user.uid); 
                        // NEW: Listen for inventory history
                        listenToInventoryHistory(user.uid);
                        listenToPendingSales(user.uid); // <-- ADD THIS
                        listenToSubCategories(user.uid); // <-- ADD THIS FIX
                        // NEW: Listen for settings
                        listenToSettings(user.uid);

                        setTab('dashboard');
                        addItem(); // Initialize POS with an empty item

                    } else {
                        mainContent.classList.add('hidden');
                        authScreen.classList.remove('hidden');
                        userInfoSpan.textContent = '';
                        inventoryData = [];
                        salesData = [];
                        customersData = [];
                        categoriesData = []; 
                        currentItems = [];
                        categoriesData = []; 
                        archivedCategoriesData = []; // ADD THIS
                        archivedInventoryData = []; // ADD THIS
                        archivedCustomersData = []; // ADD THIS
                        currentItems = [];
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                authMessage.textContent = `System Error: ${error.message}`;
                authMessage.classList.remove('hidden');
            }
        }

        // --- Dashboard Logic ---
        function renderDashboard() {
            // --- NEW: Filter sales data based on the current filter ---
            const { start, end } = getFilterDates(currentDashboardFilter);
            const filteredSales = salesData.filter(sale => {
                if (currentDashboardFilter === 'all') return true;
                return sale.date >= start && sale.date <= end;
            });
            // --- END: New Filter ---

            // --- MODIFIED: Use filteredSales instead of salesData ---
            const totalSales = filteredSales.reduce((acc, sale) => acc + (sale.totalCost || 0), 0);
            const totalProfit = filteredSales.reduce((acc, sale) => acc + (sale.profit || 0), 0);
            
            dashboardSalesAmount.textContent = formatCurrency(totalSales);
            
            // NEW: Find and update profit card
            const dashboardTotalProfit = document.getElementById('dashboard-total-profit');
            if(dashboardTotalProfit) {
                dashboardTotalProfit.textContent = formatCurrency(totalProfit);
            }
            
            dashboardProductCount.textContent = inventoryData.length;
            dashboardCategoryCount.textContent = categoriesData.length;

            const productSales = {};
            filteredSales.forEach(sale => { // <-- MODIFIED
                sale.materialsUsed.forEach(item => {
                    if (!productSales[item.name]) {
                        productSales[item.name] = { qty: 0, revenue: 0 };
                    }
                    productSales[item.name].qty += Number(item.qty);
                    productSales[item.name].revenue += Number(item.subtotal);
                });
            });

            const sortedProducts = Object.entries(productSales)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.qty - a.qty) // Sort by quantity
                .slice(0, 5);

            dashboardHighestSelling.innerHTML = '';
            if (sortedProducts.length === 0) {
                dashboardHighestSelling.innerHTML = '<tr><td colspan="3" class="px-4 py-6 text-center text-gray-500">No sales data yet.</td></tr>';
            } else {
                sortedProducts.forEach(product => {
                    dashboardHighestSelling.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${product.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${product.qty}</td>
                            <td class="px-4 py-3 text-sm font-semibold text-indigo-600">${formatCurrency(product.revenue)}</td>
                        </tr>
                    `;
                });
            }

            const recentProducts = [...inventoryData]
                .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0))
                .slice(0, 5);
            
            dashboardRecentlyAdded.innerHTML = '';
            if (recentProducts.length === 0) {
                dashboardRecentlyAdded.innerHTML = '<tr><td colspan="3" class="px-4 py-6 text-center text-gray-500">No products added yet.</td></tr>';
            } else {
                recentProducts.forEach(product => {
                    const categoryName = categoriesData.find(c => c.id === product.categoryId)?.name || 'Uncategorized';
                    const dateAdded = product.createdAt ? product.createdAt.toDate().toLocaleDateString() : 'N/A';
                    dashboardRecentlyAdded.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${product.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${categoryName}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${dateAdded}</td>
                        </tr>
                    `;
                });
            }
        }

        // --- (NEW) SETTINGS LOGIC ---

        function listenToSettings(uid) {
            const settingsRef = doc(db, getSettingsDocPath(uid));
            return onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    businessSettings = docSnap.data();
                    console.debug("Business settings loaded:", businessSettings);
                } else {
                    // No settings found, use defaults
                    businessSettings = {
                        name: "",
                        address: "",
                        contact: ""
                    };
                    console.debug("No settings found, using defaults.");
                }
                updateSettingsForm();
            }, (error) => {
                console.error("Error listening to settings: ", error.message);
            });
        }

        // Populates the settings form with loaded data
        function updateSettingsForm() {
            if (settingsBusinessName) {
                settingsBusinessName.value = businessSettings.name || '';
                settingsBusinessAddress.value = businessSettings.address || '';
                settingsBusinessContact.value = businessSettings.contact || '';
                settingsLoyaltyRate.value = businessSettings.loyaltyRate || 15;
                
                // --- NEW: Load and Apply Default Payment Method ---
                const defaultPayment = businessSettings.defaultPaymentMethod || "";
                settingsDefaultPaymentMethod.value = defaultPayment;
                posPaymentMethod.value = defaultPayment;
                // --- END NEW ---

                settingsLogoUrl.value = businessSettings.logoURL || '';
                settingsLogoSize.value = businessSettings.logoSize || 50; // <-- ADD THIS
                settingsFontSize.value = businessSettings.fontSize || 'text-sm';
                settingsShowContact.checked = businessSettings.showContact !== false; // Default to true
                settingsShowLoyalty.checked = businessSettings.showLoyalty === true; // Default to false
                // --- END NEW ---
            }
        }

        // Saves the settings form data to Firestore
        async function saveSettings() {
            if (!userId) return;

            const newSettings = {
                name: settingsBusinessName.value.trim(),
                address: settingsBusinessAddress.value.trim(),
                contact: settingsBusinessContact.value.trim(),
                loyaltyRate: parseInt(settingsLoyaltyRate.value) || 15, 
                defaultPaymentMethod: settingsDefaultPaymentMethod.value,
                
                // --- NEW: Save Receipt Settings ---
                logoURL: settingsLogoUrl.value.trim(),
                logoSize: parseInt(settingsLogoSize.value) || 50, // <-- ADD THIS
                fontSize: settingsFontSize.value,
                showContact: settingsShowContact.checked,
                showLoyalty: settingsShowLoyalty.checked
                // --- END: New ---
            };

            showButtonLoading(saveSettingsButton, 'Saving...');

            try {
                const settingsRef = doc(db, getSettingsDocPath(userId));
                // Use setDoc with merge:true to create or update the single doc
                await setDoc(settingsRef, newSettings, { merge: true });

                storeSettingsMessage.textContent = 'Settings saved successfully!'; // <-- RENAMED
                storeSettingsMessage.classList.remove('hidden', 'text-red-500'); // <-- RENAMED
                storeSettingsMessage.classList.add('text-green-500');

            } catch (error) {
                console.error("Error saving settings:", error);
                storeSettingsMessage.textContent = 'Error saving settings.'; // <-- RENAMED
                storeSettingsMessage.classList.remove('hidden', 'text-green-500'); // <-- RENAMED
                storeSettingsMessage.classList.add('text-red-500');
            } finally {
                hideButtonLoading(saveSettingsButton);
                setTimeout(() => storeSettingsMessage.classList.add('hidden'), 3000); // <-- RENAMED
            }
        }
        // Add listener to the save button
        saveSettingsButton.addEventListener('click', saveSettings);

        // --- NEW: Settings Sub-tab Logic ---
        function setSettingsSubTab(targetSubTab) {
            // Hide all sub-tab panes
            document.querySelectorAll('.settings-sub-tab-pane').forEach(pane => {
                pane.classList.add('hidden');
            });
            // Remove active class from all sub-tab buttons
            document.querySelectorAll('.settings-sub-tab-button').forEach(button => {
                button.classList.remove('settings-sub-tab-active');
            });

            // Show the target pane
            document.getElementById(`${targetSubTab}-sub-tab`).classList.remove('hidden');
            // Add active class to the target button
            document.querySelector(`.settings-sub-tab-button[data-subtab="${targetSubTab}"]`).classList.add('settings-sub-tab-active');
        }

        // Add listeners for the sub-tab buttons
        document.querySelectorAll('.settings-sub-tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                setSettingsSubTab(e.target.dataset.subtab);
            });
        });

        // --- NEW: Change Password Logic ---
        async function handleChangePassword(e) {
            e.preventDefault();
            const oldPassword = securityOldPassword.value;
            const newPassword = securityNewPassword.value;
            const confirmPassword = securityConfirmPassword.value;

            securityMessage.classList.add('hidden');
            securityMessage.classList.remove('text-red-500', 'text-green-500');

            if (!oldPassword || !newPassword || !confirmPassword) {
                securityMessage.textContent = "Please fill in all fields.";
                securityMessage.classList.add('text-red-500');
                securityMessage.classList.remove('hidden');
                return;
            }

            if (newPassword.length < 6) {
                securityMessage.textContent = "New password must be at least 6 characters long.";
                securityMessage.classList.add('text-red-500');
                securityMessage.classList.remove('hidden');
                return;
            }

            if (newPassword !== confirmPassword) {
                securityMessage.textContent = "New passwords do not match.";
                securityMessage.classList.add('text-red-500');
                securityMessage.classList.remove('hidden');
                return;
            }

            showButtonLoading(changePasswordButton, 'Updating...');

            try {
                const user = auth.currentUser;
                const credential = EmailAuthProvider.credential(user.email, oldPassword);

                // 1. Re-authenticate with the old password
                await reauthenticateWithCredential(user, credential);

                // 2. If successful, update to the new password
                await updatePassword(user, newPassword);

                securityMessage.textContent = 'Password changed successfully! All other sessions have been logged out.';
                securityMessage.classList.add('text-green-500');
                securityMessage.classList.remove('hidden');
                
                // Clear the form
                securityOldPassword.value = '';
                securityNewPassword.value = '';
                securityConfirmPassword.value = '';

            } catch (error) {
                console.error("Password Change Error:", error);
                if (error.code === 'auth/wrong-password') {
                    securityMessage.textContent = 'Incorrect current password.';
                } else {
                    securityMessage.textContent = `Error: ${error.message}`;
                }
                securityMessage.classList.add('text-red-500');
                securityMessage.classList.remove('hidden');
            } finally {
                hideButtonLoading(changePasswordButton);
            }
        }
        changePasswordButton.addEventListener('click', handleChangePassword);

        // --- END SETTINGS LOGIC ---

        // --- END SETTINGS LOGIC ---


        // --- Category Logic ---

        function listenToCategories(uid) {
            const categoriesRef = collection(db, getCategoriesCollectionPath(uid));
            return onSnapshot(categoriesRef, (snapshot) => {
                categoriesData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    createdAt: doc.data().createdAt ? doc.data().createdAt.toDate() : new Date()
                }));
                categoriesData.sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically
                
                renderCategoryList();
                updateCategorySelectors(); // Update dropdowns in inventory
                updateParentCategorySelector(); // <-- ADD THIS
                renderDashboard(); // Update dashboard card
            }, (error) => {
                console.error("Error listening to categories: ", error.message);
            });
        }

        // MODIFIED: Added Edit button
        function renderCategoryList() {
            categoryListBody.innerHTML = '';
            if (categoriesData.length === 0) {
                categoryEmptyMessage.classList.remove('hidden');
                return;
            }
            categoryEmptyMessage.classList.add('hidden');

            categoriesData.forEach(category => {
                // --- NEW: Calculate item count ---
                const itemCount = inventoryData.filter(item => item.categoryId === category.id).length;
                // --- END: New ---

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${category.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${itemCount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${category.createdAt.toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                        <button onclick="window.openEditCategoryModal('${category.id}', '${category.name.replace(/'/g, "\\'")}')" class="text-indigo-600 hover:text-indigo-900 font-semibold">
                            Edit
                        </button>
                        <!-- NEW Archive Button -->
                        <button onclick="window.archiveCategory('${category.id}')" class="text-yellow-600 hover:text-yellow-900 font-semibold">
                            Archive
                        </button>
                        <button onclick="window.openConfirmCategoryDeleteModal('${category.id}', '${category.name.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-900 font-semibold">
                            Delete
                        </button>
                    </td>
                `;
                categoryListBody.appendChild(row);
            });
        }

        async function addCategory() {
            const name = newCategoryNameInput.value.trim();
            if (!name || !userId) {
                categoryMessage.textContent = "Please enter a category name.";
                categoryMessage.classList.remove('hidden');
                categoryMessage.classList.add('text-red-500');
                setTimeout(() => categoryMessage.classList.add('hidden'), 3000);
                return;
            }

            try {
                showButtonLoading(addCategoryButton, 'Adding...'); // <-- ADD THIS
                await addDoc(collection(db, getCategoriesCollectionPath(userId)), {
                    name: name,
                    createdAt: Timestamp.now()
                });

                newCategoryNameInput.value = '';
                categoryMessage.textContent = `${name} added successfully!`;
                categoryMessage.classList.remove('hidden', 'text-red-500');
                categoryMessage.classList.add('text-green-500');
                setTimeout(() => categoryMessage.classList.add('hidden'), 3000);

            } catch (error) {
                console.error("Error adding category:", error);
                categoryMessage.textContent = 'Error adding category.';
                categoryMessage.classList.remove('hidden');
                categoryMessage.classList.add('text-red-500');
            } finally {
                hideButtonLoading(addCategoryButton); // <-- ADD THIS
            }
        }
        addCategoryButton.addEventListener('click', addCategory);

        // --- NEW: Category Edit Modal Functions ---
        window.openEditCategoryModal = (id, name) => {
            editCategoryId.value = id;
            editCategoryName.value = name;
            editCategoryModal.classList.remove('hidden');
        };

        window.closeEditCategoryModal = () => {
            editCategoryModal.classList.add('hidden');
            editCategoryForm.reset();
        };

        async function handleEditCategorySubmit(e) {
            e.preventDefault();
            const id = editCategoryId.value;
            const newName = editCategoryName.value.trim();

            if (!id || !newName) {
                categoryMessage.textContent = "Category name cannot be empty.";
                categoryMessage.classList.remove('hidden', 'text-green-500');
                categoryMessage.classList.add('text-red-500');
                return;
            }
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitButton, 'Saving...');
            
            try {
                // 1. Update the category document
                const categoryRef = doc(db, getCategoriesCollectionPath(userId), id);
                await updateDoc(categoryRef, { name: newName });

                // 2. Find all inventory items with this categoryId and update them
                const q = query(collection(db, getInventoryCollectionPath(userId)), where("categoryId", "==", id));
                const querySnapshot = await getDocs(q);
                
                const updatePromises = [];
                querySnapshot.forEach((itemDoc) => {
                    updatePromises.push(updateDoc(itemDoc.ref, { categoryName: newName }));
                });
                
                await Promise.all(updatePromises);

                window.closeEditCategoryModal();
                categoryMessage.textContent = `Category and ${updatePromises.length} item(s) updated successfully!`;
                categoryMessage.classList.remove('hidden', 'text-red-500');
                categoryMessage.classList.add('text-green-500');

            } catch (error) {
                console.error("Error updating category:", error);
                categoryMessage.textContent = 'Error updating category.';
                categoryMessage.classList.remove('hidden', 'text-green-500');
                categoryMessage.classList.add('text-red-500');
            } finally {
                hideButtonLoading(submitButton);
                setTimeout(() => categoryMessage.classList.add('hidden'), 5000);
            }
        }
        editCategoryForm.addEventListener('submit', handleEditCategorySubmit);
        // --- End of Category Edit Modal Functions ---


        // --- NEW: Category Delete Modal Functions (with Password & Cascade) ---
        
        // MODIFIED: This now opens the confirmation modal instead of deleting directly
        window.openConfirmCategoryDeleteModal = (id, name) => {
            if (!id || !name) return;
            // Store data on the modal itself for the confirmation function
            confirmCategoryDeleteModal.dataset.categoryId = id;
            confirmCategoryDeleteModal.dataset.categoryName = name;
            
            deleteCategoryNameSpan.textContent = `"${name}"`;
            deleteCategoryPasswordInput.value = '';
            deleteCategoryErrorMessage.classList.add('hidden');
            
            confirmCategoryDeleteModal.classList.remove('hidden');
        };
        
        window.closeConfirmCategoryDeleteModal = () => {
            confirmCategoryDeleteModal.classList.add('hidden');
            delete confirmCategoryDeleteModal.dataset.categoryId;
            delete confirmCategoryDeleteModal.dataset.categoryName;
            deleteCategoryPasswordInput.value = '';
            deleteCategoryErrorMessage.classList.add('hidden');
        };

        async function handleCategoryDeleteConfirm() {
            const categoryId = confirmCategoryDeleteModal.dataset.categoryId;
            const categoryName = confirmCategoryDeleteModal.dataset.categoryName;
            const password = deleteCategoryPasswordInput.value;
            const email = auth.currentUser ? auth.currentUser.email : null;

            if (!categoryId || !email) {
                deleteCategoryErrorMessage.textContent = "User data missing. Please log out and in.";
                deleteCategoryErrorMessage.classList.remove('hidden');
                return;
            }

            if (password.length < 6) {
                deleteCategoryErrorMessage.textContent = "Password is required (min 6 chars).";
                deleteCategoryErrorMessage.classList.remove('hidden');
                return;
            }

            showButtonLoading(deleteCategoryConfirmYes, 'Deleting...');

            try {
                // 1. Re-authenticate user to verify password
                const user = auth.currentUser;
                const credential = EmailAuthProvider.credential(user.email, password);
                await reauthenticateWithCredential(user, credential);

                // 2. Password is correct. Find all associated inventory items.
                const q = query(collection(db, getInventoryCollectionPath(userId)), where("categoryId", "==", categoryId));
                const querySnapshot = await getDocs(q);

                const deleteItemPromises = [];
                querySnapshot.forEach((doc) => {
                    deleteItemPromises.push(deleteDoc(doc.ref));
                });
                
                // 3. Add the category deletion to the promise list
                const categoryRef = doc(db, getCategoriesCollectionPath(userId), categoryId);
                deleteItemPromises.push(deleteDoc(categoryRef));

                // 4. Run all deletions
                await Promise.all(deleteItemPromises);

                // 5. Success
                window.closeConfirmCategoryDeleteModal();
                categoryMessage.textContent = `Category "${categoryName}" and ${querySnapshot.docs.length} associated item(s) have been deleted.`;
                categoryMessage.classList.remove('hidden', 'text-red-500');
                categoryMessage.classList.add('text-green-500');

            } catch (error) {
                console.error("Error deleting category:", error);
                let message = 'An unknown error occurred.';
                if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password. Deletion failed.';
                } else {
                    message = `Error: ${error.message}`;
                }
                deleteCategoryErrorMessage.textContent = message;
                deleteCategoryErrorMessage.classList.remove('hidden');
            } finally {
                hideButtonLoading(deleteCategoryConfirmYes);
                setTimeout(() => categoryMessage.classList.add('hidden'), 5000);
            }
        }
        
        // Add listeners for the new modal buttons
        deleteCategoryConfirmYes.addEventListener('click', handleCategoryDeleteConfirm);
        deleteCategoryConfirmNo.addEventListener('click', window.closeConfirmCategoryDeleteModal);
        // --- End of Category Delete Modal Functions ---

        // --- NEW: Sub-Category Logic ---

        function listenToSubCategories(uid) {
            const subCategoriesRef = collection(db, getSubCategoriesCollectionPath(uid));
            // REMOVED: query(..., orderBy(...)) to prevent Firestore index error
            return onSnapshot(subCategoriesRef, (snapshot) => { 
                subCategoriesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // NEW: Sort in JavaScript
                subCategoriesData.sort((a, b) => {
                    if (a.parentCategoryName < b.parentCategoryName) return -1;
                    if (a.parentCategoryName > b.parentCategoryName) return 1;
                    if (a.name < b.name) return -1;
                    if (a.name > b.name) return 1;
                    return 0;
                });

                renderSubCategoryList();
            }, (error) => {
                console.error("Error listening to sub-categories: ", error.message);
            });
        }

        function updateParentCategorySelector() {
            if (!parentCategorySelect) return;
            parentCategorySelect.innerHTML = `
                <option value="">-- Select Parent --</option>
                ${categoriesData.map(cat => 
                    `<option value="${cat.id}">${cat.name}</option>`
                ).join('')}
            `;
        }

        function renderSubCategoryList() {
            subCategoryListBody.innerHTML = '';
            if (subCategoriesData.length === 0) {
                subCategoryEmptyMessage.classList.remove('hidden');
                return;
            }
            subCategoryEmptyMessage.classList.add('hidden');

            subCategoriesData.forEach(sub => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sub.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sub.parentCategoryName || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                        <button onclick="window.openEditSubCategoryModal('${sub.id}')" class="text-indigo-600 hover:text-indigo-900 font-semibold">
                            Edit
                        </button>
                        <button onclick="window.deleteSubCategory('${sub.id}')" class="text-red-600 hover:text-red-900 font-semibold">
                            Delete
                        </button>
                    </td>
                `;
                subCategoryListBody.appendChild(row);
            });
        }

        async function addSubCategory() {
            const parentId = parentCategorySelect.value;
            const name = newSubCategoryNameInput.value.trim();
            
            if (!parentId || !name) {
                subCategoryMessage.textContent = "Please select a parent category and enter a name.";
                subCategoryMessage.classList.remove('hidden', 'text-green-500');
                subCategoryMessage.classList.add('text-red-500');
                setTimeout(() => subCategoryMessage.classList.add('hidden'), 3000);
                return;
            }

            const parentCategory = categoriesData.find(c => c.id === parentId);
            if (!parentCategory) return;

            try {
                showButtonLoading(addSubCategoryButton, 'Adding...'); // <-- ADD THIS
                await addDoc(collection(db, getSubCategoriesCollectionPath(userId)), {
                    name: name,
                    parentCategoryId: parentId,
                    parentCategoryName: parentCategory.name,
                    createdAt: Timestamp.now()
                });

                newSubCategoryNameInput.value = '';
                parentCategorySelect.value = '';
                subCategoryMessage.textContent = `${name} added successfully!`;
                subCategoryMessage.classList.remove('hidden', 'text-red-500');
                subCategoryMessage.classList.add('text-green-500');
                setTimeout(() => subCategoryMessage.classList.add('hidden'), 3000);

            } catch (error) {
                console.error("Error adding sub-category:", error);
                subCategoryMessage.textContent = 'Error adding sub-category.';
                subCategoryMessage.classList.remove('hidden', 'text-green-500');
                subCategoryMessage.classList.add('text-red-500');
            } finally {
                hideButtonLoading(addSubCategoryButton); // <-- ADD THIS
            }
        }
        addSubCategoryButton.addEventListener('click', addSubCategory);

        window.deleteSubCategory = async (id) => {
            if (!userId) return;
            if (!confirm("Are you sure you want to delete this sub-category? This will clear the sub-category from all associated inventory items.")) {
                return;
            }
            
            try {
                // Delete the sub-category document
                await deleteDoc(doc(db, getSubCategoriesCollectionPath(userId), id));
                
                // Find all items with this sub-category ID and clear the fields
                const q = query(collection(db, getInventoryCollectionPath(userId)), where("subCategoryId", "==", id));
                const querySnapshot = await getDocs(q);
                
                const updatePromises = [];
                querySnapshot.forEach((itemDoc) => {
                    updatePromises.push(updateDoc(itemDoc.ref, { 
                        subCategoryId: '',
                        subCategoryName: ''
                    }));
                });
                await Promise.all(updatePromises);

                subCategoryMessage.textContent = `Sub-category deleted and ${updatePromises.length} items updated.`;
                subCategoryMessage.classList.remove('hidden', 'text-red-500');
                subCategoryMessage.classList.add('text-green-500');
                setTimeout(() => subCategoryMessage.classList.add('hidden'), 4000);

            } catch (error) {
                console.error("Error deleting sub-category:", error);
                subCategoryMessage.textContent = 'Error deleting sub-category.';
                subCategoryMessage.classList.remove('hidden', 'text-green-500');
                subCategoryMessage.classList.add('text-red-500');
            }
        }
        // --- END: Sub-Category Logic ---

        // --- NEW: Edit Sub-Category Modal Logic ---

        // 1. Get DOM Elements for the new modal
        const editSubCategoryModal = document.getElementById('edit-subcategory-modal');
        const editSubCategoryForm = document.getElementById('edit-subcategory-form');
        const editSubCategoryId = document.getElementById('edit-subcategory-id');
        const editSubCategoryName = document.getElementById('edit-subcategory-name');
        const editSubCategoryParent = document.getElementById('edit-subcategory-parent');
        const editSubCategoryMessage = document.getElementById('edit-subcategory-message');

        // 2. Open Modal Function
        window.openEditSubCategoryModal = (id) => {
            const sub = subCategoriesData.find(s => s.id === id);
            if (!sub) {
                console.error("Sub-category not found:", id);
                return;
            }

            // Populate the modal fields
            editSubCategoryId.value = sub.id;
            editSubCategoryName.value = sub.name;
            editSubCategoryMessage.classList.add('hidden');

            // Populate the parent category dropdown
            editSubCategoryParent.innerHTML = categoriesData.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');

            // Set the currently selected parent
            editSubCategoryParent.value = sub.parentCategoryId;

            editSubCategoryModal.classList.remove('hidden');
        };

        // 3. Close Modal Function
        window.closeEditSubCategoryModal = () => {
            editSubCategoryModal.classList.add('hidden');
            editSubCategoryForm.reset();
        };

        // 4. Handle Form Submit
        async function handleEditSubCategorySubmit(e) {
            e.preventDefault();
            const subId = editSubCategoryId.value;
            const newName = editSubCategoryName.value.trim();
            const newParentId = editSubCategoryParent.value;

            if (!subId || !newName || !newParentId) {
                editSubCategoryMessage.textContent = "All fields are required.";
                editSubCategoryMessage.classList.remove('hidden');
                return;
            }

            const newParentCategory = categoriesData.find(c => c.id === newParentId);
            if (!newParentCategory) {
                editSubCategoryMessage.textContent = "Selected parent category not found.";
                editSubCategoryMessage.classList.remove('hidden');
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitButton, 'Saving...');
            editSubCategoryMessage.classList.add('hidden');

            try {
                // 1. Update the sub-category document itself
                const subCategoryRef = doc(db, getSubCategoriesCollectionPath(userId), subId);
                await updateDoc(subCategoryRef, {
                    name: newName,
                    parentCategoryId: newParentId,
                    parentCategoryName: newParentCategory.name
                });

                // 2. Cascade Update: Find all inventory items using this sub-category
                const q = query(collection(db, getInventoryCollectionPath(userId)), where("subCategoryId", "==", subId));
                const querySnapshot = await getDocs(q);

                const updatePromises = [];
                querySnapshot.forEach((itemDoc) => {
                    // Update each item with the new sub-category name and new parent category info
                    updatePromises.push(updateDoc(itemDoc.ref, { 
                        subCategoryName: newName,
                        categoryId: newParentId,
                        categoryName: newParentCategory.name
                    }));
                });

                await Promise.all(updatePromises);

                window.closeEditSubCategoryModal();
                subCategoryMessage.textContent = `Sub-category updated successfully. ${updatePromises.length} inventory item(s) were also updated.`;
                subCategoryMessage.classList.remove('hidden', 'text-red-500');
                subCategoryMessage.classList.add('text-green-500');

            } catch (error) {
                console.error("Error updating sub-category:", error);
                editSubCategoryMessage.textContent = "Error saving changes: " + error.message;
                editSubCategoryMessage.classList.remove('hidden');
            } finally {
                hideButtonLoading(submitButton);
                setTimeout(() => subCategoryMessage.classList.add('hidden'), 5000);
            }
        }

        // 5. Add the event listener
        editSubCategoryForm.addEventListener('submit', handleEditSubCategorySubmit);

        // --- END: Edit Sub-Category Modal Logic ---


        function updateCategorySelectors(selectedId = '') {
            const selectors = [
                document.getElementById('new-material-category'),
                document.getElementById('edit-material-category')
            ];

            const optionsHtml = `
                <option value="">-- Select Category --</option>
                ${categoriesData.map(cat => 
                    `<option value="${cat.id}" ${cat.id === selectedId ? 'selected' : ''}>${cat.name}</option>`
                ).join('')}
            `;

            selectors.forEach(select => {
                if (select) {
                    const currentValue = select.value; // Preserve current value if possible
                    select.innerHTML = optionsHtml;
                    // Try to restore the previous selection
                    if (categoriesData.some(c => c.id === currentValue)) {
                         select.value = currentValue;
                    } else if (selectedId) {
                         select.value = selectedId;
                    }
                }
            });
        }

        // --- NEW: Sub-Category Selector Logic ---
        function updateSubCategorySelectors(parentCategoryId = '', selectedSubCategoryId = '') {
            const newSubSelect = document.getElementById('new-material-subcategory');
            const editSubSelect = document.getElementById('edit-material-subcategory');
            
            // Filter sub-categories based on the parent
            const filteredSubs = subCategoriesData.filter(s => s.parentCategoryId === parentCategoryId);

            const optionsHtml = `
                <option value="">-- Select Sub-Category --</option>
                ${filteredSubs.map(sub => 
                    `<option value="${sub.id}" ${sub.id === selectedSubCategoryId ? 'selected' : ''}>${sub.name}</option>`
                ).join('')}
            `;

            if (newSubSelect) newSubSelect.innerHTML = optionsHtml;
            if (editSubSelect) editSubSelect.innerHTML = optionsHtml;
        }

        // Add listeners to main category dropdowns to trigger the update
        document.getElementById('new-material-category').addEventListener('change', (e) => {
            updateSubCategorySelectors(e.target.value);
        });
        document.getElementById('edit-material-category').addEventListener('change', (e) => {
            updateSubCategorySelectors(e.target.value);
        });
        // --- END: New Logic ---

        
        // --- CUSTOMER LOGIC ---
        
        function listenToCustomers(uid) {
            const customersRef = collection(db, getCustomersCollectionPath(uid));
            return onSnapshot(customersRef, (snapshot) => {
                customersData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderCustomerList(); // This will now render with the full list
                updatePosCustomerSelector();
                renderCustomerDashboard(); 
                renderDashboard(); 
            }, (error) => {
                console.error("Error listening to customers: ", error.message);
            });
        }

        // --- NEW: Customer Search Function ---
        function filterCustomerList() {
            const searchTerm = customerSearchInput.value.toLowerCase().trim();
            const filteredData = customersData.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.contactNumber.toLowerCase().includes(searchTerm)
            );
            renderCustomerList(filteredData);
        }
        customerSearchInput.addEventListener('input', debounce(filterCustomerList, 300));
        // --- END: New Function ---
        // --- (ADD ALL OF THIS CODE) INVENTORY HISTORY LOGIC ---

        // NEW: Helper function to add a log entry
        async function logInventoryHistory(itemName, message, type, reason = '', transactionId = '') { // <-- MODIFIED
        if (!userId) return; // Don't log if user isn't set
            try {
                await addDoc(collection(db, getInventoryHistoryCollectionPath(userId)), {
                    itemName: itemName,
                    message: message,
                    reason: reason, // <-- ADDED
                    type: type, // 'stock_in', 'stock_out', 'sale', 'low_stock'
                    transactionId: transactionId, // <-- ADD THIS LINE
                    date: Timestamp.now()
                });
            } catch (error) {
                console.error("Failed to log inventory history:", error);
            }
        }

        // NEW: Listener for the history collection
        function listenToInventoryHistory(uid) {
            const historyRef = collection(db, getInventoryHistoryCollectionPath(uid));
            
            // FIX: Removed (orderBy/limit) from the query to avoid index errors.
            // We will sort and limit in JavaScript instead, which is more reliable.
            
            return onSnapshot(historyRef, (snapshot) => { // Use the base historyRef, not 'q'
                let history = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Ensure date exists before calling .toDate()
                    date: doc.data().date ? doc.data().date.toDate() : new Date()
                }));
                
                // NEW: Sort and limit on the client-side
                history.sort((a, b) => b.date.getTime() - a.date.getTime()); // Sort descending
                inventoryHistoryData = history.slice(0, 50); // Get the 50 most recent
                
                renderInventoryHistory();
            }, (error) => {
                console.error("Error listening to inventory history: ", error.message);
            });
        }

        // NEW: Function to render the history list
        function renderInventoryHistory(data = inventoryHistoryData) { // <-- MODIFIED THIS LINE
            if (!inventoryHistoryList) return; // In case element isn't on the page

            inventoryHistoryList.innerHTML = '';
            if (data.length === 0) { // <-- MODIFIED THIS LINE
                inventoryHistoryEmptyMessage.classList.remove('hidden');
                return;
            }
            inventoryHistoryEmptyMessage.classList.add('hidden');

            data.forEach(log => { // <-- MODIFIED THIS LINE
                const itemEl = document.createElement('div');
                let iconHtml = '';
                let titleColor = 'text-gray-900';

                // Apply styles based on log type
                switch (log.type) {
                    case 'stock_in':
                        iconHtml = `<div class="p-2 rounded-full bg-green-100 text-green-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></div>`;
                        titleColor = 'text-green-700';
                        break;
                    
                    case 'points_adjustment':
                        iconHtml = `<div class="p-2 rounded-full bg-yellow-100 text-yellow-600"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg></div>`;
                        titleColor = 'text-yellow-700';
                        break;
                    case 'stock_out':
                    case 'stock_out':
                        iconHtml = `<div class="p-2 rounded-full bg-red-100 text-red-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path></svg></div>`;
                        titleColor = 'text-red-700';
                        break;
                    case 'sale':
                        iconHtml = `<div class="p-2 rounded-full bg-blue-100 text-blue-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>`;
                        titleColor = 'text-blue-700';
                        break;
                    case 'low_stock':
                        iconHtml = `<div class="p-2 rounded-full bg-yellow-100 text-yellow-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>`;
                        titleColor = 'text-yellow-700';
                        break;
                }

                itemEl.className = 'flex items-start space-x-3 p-3 border-b border-gray-100';
                const reasonHtml = log.reason ? `<p class="text-sm text-gray-500 italic mt-1">Reason: ${log.reason}</p>` : ''; 
                // <-- ADD THIS LINE
                const transactionIdHtml = log.transactionId ? `<p class="text-sm text-gray-500 mt-1">Sale ID: <span class="font-medium text-indigo-600 dark:text-indigo-400">${log.transactionId}</span></p>` : '';

                itemEl.innerHTML = `
                    ${iconHtml}
                    <div class="flex-1">
                        <p class="text-sm font-semibold ${titleColor}">${log.itemName}</p>
                        <p class="text-sm text-gray-600">${log.message}</p>
                        ${reasonHtml}
                        ${transactionIdHtml} <p class="text-xs text-gray-400 mt-1">${log.date.toLocaleString()}</p>
                    </div>
                `;
                inventoryHistoryList.appendChild(itemEl);
            });
        }

        // --- MODIFIED: Inventory History Filter Function ---
        function filterInventoryHistory() {
            const startDateInput = document.getElementById('inventory-history-start-date');
            const endDateInput = document.getElementById('inventory-history-end-date');
            
            // Get all filter values
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
            const searchTerm = inventoryHistorySearch.value.toLowerCase().trim();
            const typeFilter = inventoryHistoryTypeFilter.value;

            let filtered = inventoryHistoryData;

            // Apply date filters
            if (startDate) {
                startDate.setHours(0, 0, 0, 0);
                filtered = filtered.filter(log => log.date >= startDate);
            }
            if (endDate) {
                endDate.setHours(23, 59, 59, 999);
                filtered = filtered.filter(log => log.date <= endDate);
            }

            // Apply type filter
            if (typeFilter) {
                filtered = filtered.filter(log => log.type === typeFilter);
            }

            // Apply search term filter
            if (searchTerm) {
                filtered = filtered.filter(log => 
                    log.itemName.toLowerCase().includes(searchTerm) ||
                    (log.reason && log.reason.toLowerCase().includes(searchTerm))
                );
            }

            // Save for PDF export
            currentFilteredInventoryHistory = filtered;
            
            // Render the list
            renderInventoryHistory(filtered); 
        }
        // --- END: Inventory History Filter Function ---
        
        async function addCustomer() {
            const nameInput = document.getElementById('new-customer-name');
            const contactInput = document.getElementById('new-customer-contact');
            const addressInput = document.getElementById('new-customer-address');
            const joinsLoyaltyInput = document.getElementById('new-customer-joins-loyalty'); // <-- NEW

            const name = nameInput.value.trim();
            const contactNumber = contactInput.value.trim();
            const address = addressInput.value.trim(); 
            const joinsLoyalty = joinsLoyaltyInput.checked; // <-- NEW

            if (!name || !contactNumber || !userId) {
                customerMessage.textContent = "Please enter both customer name and contact number.";
                customerMessage.classList.remove('hidden');
                customerMessage.classList.add('text-red-500');
                setTimeout(() => customerMessage.classList.add('hidden'), 3000);
                return;
            }
            const addButton = document.getElementById('add-customer-button');

            try {
                showButtonLoading(addButton, 'Adding...'); 
                await addDoc(collection(db, getCustomersCollectionPath(userId)), {
                    name: name,
                    contactNumber: contactNumber,
                    address: address, 
                    loyaltyPoints: 0, 
                    joinsLoyalty: joinsLoyalty, // <-- NEW
                    createdAt: Timestamp.now()
                });

                nameInput.value = '';
                contactInput.value = '';
                addressInput.value = ''; 
                joinsLoyaltyInput.checked = true; // <-- NEW: Reset checkbox

                customerMessage.textContent = `${name} added successfully!`;
                customerMessage.classList.remove('hidden', 'text-red-500');
                customerMessage.classList.add('text-green-500');
                setTimeout(() => customerMessage.classList.add('hidden'), 3000);

            } catch (error) {
                console.error("Error adding customer:", error);
                customerMessage.textContent = 'Error adding customer.';
                customerMessage.classList.remove('hidden');
                customerMessage.classList.add('text-red-500');
            } finally {
                hideButtonLoading(addButton); 
            }
        }
        document.getElementById('add-customer-button').addEventListener('click', addCustomer);
        
        // --- NEW: Customer Delete Modal Functions (with Password) ---
        
        // 1. This function is called by the "Delete" button. It just opens the modal.
        window.deleteCustomer = (id, name) => {
            if (!id || !name) return;
            // Store data on the modal itself for the confirmation function
            confirmCustomerDeleteModal.dataset.customerId = id;
            confirmCustomerDeleteModal.dataset.customerName = name;
            
            deleteCustomerNameSpan.textContent = `"${name}"`;
            deleteCustomerPasswordInput.value = '';
            deleteCustomerErrorMessage.classList.add('hidden');
            
            confirmCustomerDeleteModal.classList.remove('hidden');
        };
        
        // 2. This helper function closes the modal
        window.closeConfirmCustomerDeleteModal = () => {
            confirmCustomerDeleteModal.classList.add('hidden');
            delete confirmCustomerDeleteModal.dataset.customerId;
            delete confirmCustomerDeleteModal.dataset.customerName;
            deleteCustomerPasswordInput.value = '';
            deleteCustomerErrorMessage.classList.add('hidden');
        };

        // 3. This function runs when the "Yes, Delete Customer" button is clicked
        async function handleCustomerDeleteConfirm() {
            const customerId = confirmCustomerDeleteModal.dataset.customerId;
            const customerName = confirmCustomerDeleteModal.dataset.customerName;
            const password = deleteCustomerPasswordInput.value;
            const email = auth.currentUser ? auth.currentUser.email : null;

            if (!customerId || !email) {
                deleteCustomerErrorMessage.textContent = "User data missing. Please log out and in.";
                deleteCustomerErrorMessage.classList.remove('hidden');
                return;
            }

            if (password.length < 6) {
                deleteCustomerErrorMessage.textContent = "Password is required (min 6 chars).";
                deleteCustomerErrorMessage.classList.remove('hidden');
                return;
            }

            showButtonLoading(deleteCustomerConfirmYes, 'Deleting...');

            try {
                // 1. Re-authenticate user to verify password
                const user = auth.currentUser;
                const credential = EmailAuthProvider.credential(user.email, password);
                await reauthenticateWithCredential(user, credential);

                // 2. Password is correct. Delete the customer.
                const customerRef = doc(db, getCustomersCollectionPath(userId), customerId);
                await deleteDoc(customerRef);

                // 3. Success
                window.closeConfirmCustomerDeleteModal();
                customerMessage.textContent = `Customer "${customerName}" has been deleted.`;
                customerMessage.classList.remove('hidden', 'text-red-500');
                customerMessage.classList.add('text-green-500');

            } catch (error) {
                console.error("Error deleting customer:", error);
                let message = 'An unknown error occurred.';
                if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password. Deletion failed.';
                } else {
                    message = `Error: ${error.message}`;
                }
                deleteCustomerErrorMessage.textContent = message;
                deleteCustomerErrorMessage.classList.remove('hidden');
            } finally {
                hideButtonLoading(deleteCustomerConfirmYes);
                setTimeout(() => customerMessage.classList.add('hidden'), 5000);
            }
        }
        
        // 4. Add event listeners for the new modal's buttons
        deleteCustomerConfirmYes.addEventListener('click', handleCustomerDeleteConfirm);
        deleteCustomerConfirmNo.addEventListener('click', window.closeConfirmCustomerDeleteModal);
        // --- End of Customer Delete Modal Functions ---

        // --- NEW: Inventory Delete Modal Functions (with Password) ---

    // 1. This function is called by the "Delete" button. It just opens the modal.
    window.openConfirmInventoryDeleteModal = (id, name) => {
        if (!id || !name) return;
        // Store data on the modal itself for the confirmation function
        confirmInventoryDeleteModal.dataset.itemId = id;
        confirmInventoryDeleteModal.dataset.itemName = name;

        deleteInventoryNameSpan.textContent = `"${name}"`;
        deleteInventoryPasswordInput.value = '';
        deleteInventoryErrorMessage.classList.add('hidden');

        confirmInventoryDeleteModal.classList.remove('hidden');
    };

    // 2. This helper function closes the modal
    window.closeConfirmInventoryDeleteModal = () => {
        confirmInventoryDeleteModal.classList.add('hidden');
        delete confirmInventoryDeleteModal.dataset.itemId;
        delete confirmInventoryDeleteModal.dataset.itemName;
        deleteInventoryPasswordInput.value = '';
        deleteInventoryErrorMessage.classList.add('hidden');
    };

    // 3. This function runs when the "Yes, Delete Item" button is clicked
    async function handleInventoryDeleteConfirm() {
        const itemId = confirmInventoryDeleteModal.dataset.itemId;
        const itemName = confirmInventoryDeleteModal.dataset.itemName;
        const password = deleteInventoryPasswordInput.value;
        const email = auth.currentUser ? auth.currentUser.email : null;

        if (!itemId || !email) {
            deleteInventoryErrorMessage.textContent = "User data missing. Please log out and in.";
            deleteInventoryErrorMessage.classList.remove('hidden');
            return;
        }

        if (password.length < 6) {
            deleteInventoryErrorMessage.textContent = "Password is required (min 6 chars).";
            deleteInventoryErrorMessage.classList.remove('hidden');
            return;
        }

        showButtonLoading(deleteInventoryConfirmYes, 'Deleting...');

        try {
            // 1. Re-authenticate user to verify password
            const user = auth.currentUser;
            const credential = EmailAuthProvider.credential(user.email, password);
            await reauthenticateWithCredential(user, credential);

            // 2. Password is correct. Delete the item.
            const itemRef = doc(db, getInventoryCollectionPath(userId), itemId);
            await deleteDoc(itemRef);

            // 3. Log the deletion to history (as you requested!)
            await logInventoryHistory(itemName, "Item permanently deleted", 'stock_out', 'Manual Deletion by User');

            // 4. Success
            window.closeConfirmInventoryDeleteModal();
            posMessage.textContent = `Item "${itemName}" has been permanently deleted.`;
            posMessage.classList.remove('hidden', 'text-red-500');
            posMessage.classList.add('text-green-500');

        } catch (error) {
            console.error("Error deleting item:", error);
            let message = 'An unknown error occurred.';
            if (error.code === 'auth/wrong-password') {
                message = 'Incorrect password. Deletion failed.';
            } else {
                message = `Error: ${error.message}`;
            }
            deleteInventoryErrorMessage.textContent = message;
            deleteInventoryErrorMessage.classList.remove('hidden');
        } finally {
            hideButtonLoading(deleteInventoryConfirmYes);
            setTimeout(() => posMessage.classList.add('hidden'), 5000);
        }
    }

    // 4. Add event listeners for the new modal's buttons
    deleteInventoryConfirmYes.addEventListener('click', handleInventoryDeleteConfirm);
    deleteInventoryConfirmNo.addEventListener('click', window.closeConfirmInventoryDeleteModal);
    // --- End of Inventory Delete Modal Functions ---


        // --- NEW: Adjust Points Modal Functions ---

        // 1. Open Modal
        window.openAdjustPointsModal = (id, name, currentPoints) => {
            adjustPointsCustomerId.value = id;
            adjustPointsCustomerName.textContent = name;
            adjustPointsCurrentPoints.value = currentPoints;
            
            adjustPointsPreview.textContent = `Current Points: ${currentPoints}`;
            adjustPointsMessage.classList.add('hidden');
            adjustPointsForm.reset();
            
            adjustPointsModal.classList.remove('hidden');
        };

        // 2. Close Modal
        window.closeAdjustPointsModal = () => {
            adjustPointsModal.classList.add('hidden');
            adjustPointsForm.reset();
        };

        // 3. Update Preview on input
        adjustPointsAmount.addEventListener('input', () => {
            const current = parseInt(adjustPointsCurrentPoints.value) || 0;
            const adjustment = parseInt(adjustPointsAmount.value) || 0;
            const newTotal = current + adjustment;
            adjustPointsPreview.textContent = `Current: ${current} | Adjustment: ${adjustment} | New Total: ${newTotal}`;
        });

        // 4. Handle Form Submit
        async function handleAdjustPointsSubmit(e) {
            e.preventDefault();
            const customerId = adjustPointsCustomerId.value;
            const customerName = adjustPointsCustomerName.textContent;
            const reason = adjustPointsReason.value.trim();
            const adjustment = parseInt(adjustPointsAmount.value);
            const currentPoints = parseInt(adjustPointsCurrentPoints.value);

            if (!customerId || isNaN(adjustment) || adjustment === 0 || !reason) {
                adjustPointsMessage.textContent = "Please enter a valid, non-zero amount and a reason.";
                adjustPointsMessage.classList.remove('hidden');
                return;
            }

            const newTotalPoints = currentPoints + adjustment;
            if (newTotalPoints < 0) {
                adjustPointsMessage.textContent = "Adjustment would result in negative points. Please correct.";
                adjustPointsMessage.classList.remove('hidden');
                return;
            }

            adjustPointsMessage.classList.add('hidden');
            const submitButton = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitButton, 'Saving...');

            try {
                // 1. Update the customer's points
                const customerRef = doc(db, getCustomersCollectionPath(userId), customerId);
                await updateDoc(customerRef, { loyaltyPoints: newTotalPoints });
                
                // 2. Log this adjustment to history
                const message = `Points adjusted by ${adjustment > 0 ? '+' : ''}${adjustment}`;
                // We re-use the inventory log for this
                await logInventoryHistory(customerName, message, 'points_adjustment', reason);

                window.closeAdjustPointsModal();
                customerMessage.textContent = `Points for ${customerName} adjusted successfully.`;
                customerMessage.classList.remove('hidden', 'text-red-500');
                customerMessage.classList.add('text-green-500');

            } catch (error) {
                console.error("Error adjusting points:", error);
                adjustPointsMessage.textContent = `Error: ${error.message}`;
                adjustPointsMessage.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                hideButtonLoading(submitButton);
                setTimeout(() => customerMessage.classList.add('hidden'), 5000);
            }
        }
        adjustPointsForm.addEventListener('submit', handleAdjustPointsSubmit);
        // --- END: Adjust Points Modal Functions ---

        function renderCustomerList(data = customersData) { // <-- MODIFIED
            customerListBody.innerHTML = '';

            // --- NEW: Updated Empty Message Logic ---
            const searchTerm = customerSearchInput.value.trim();
            if (data.length === 0 && searchTerm) {
                customerEmptyMessage.textContent = "No customers found matching your search.";
                customerEmptyMessage.classList.remove('hidden');
                return;
            }
            if (customersData.length === 0) {
                customerEmptyMessage.textContent = "No registered customers found.";
                customerEmptyMessage.classList.remove('hidden');
                return;
            }
            // --- END: New Logic ---

            customerEmptyMessage.classList.add('hidden');

            data.forEach(customer => { // <-- MODIFIED
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // --- NEW: Logic for Loyalty Member display ---
                const loyaltyStatus = customer.joinsLoyalty === false ? 
                    '<span class="text-sm font-medium text-gray-500">No</span>' :
                    '<span class="text-sm font-bold text-green-600">Yes</span>';

                // --- NEW: Disable points button if not a member ---
                const adjustPointsButtonDisabled = customer.joinsLoyalty === false ? 'disabled' : '';
                const adjustPointsButtonClasses = customer.joinsLoyalty === false ? 
                    'text-gray-400 cursor-not-allowed' : 
                    'text-green-600 hover:text-green-900 font-semibold';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.contactNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.address || 'N/A'}</td>
                    <!-- NEW: Loyalty Member Column Data -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${loyaltyStatus}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-indigo-600 dark:text-indigo-400">${customer.loyaltyPoints || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                        <button onclick="window.openEditCustomerModal('${customer.id}')" class="text-indigo-600 hover:text-indigo-900 font-semibold">
                            Edit
                        </button>
                        <button onclick="window.openAdjustPointsModal('${customer.id}', '${customer.name.replace(/'/g, "\\'")}', ${customer.loyaltyPoints || 0})" class="${adjustPointsButtonClasses}" ${adjustPointsButtonDisabled}>
                            Adjust Points
                        </button>
                        <button onclick="window.showCustomerHistory('${customer.id}', '${customer.name.replace(/'/g, "\\'")}')" class="text-blue-600 hover:text-blue-900 font-semibold">
                            History
                        </button>
                        <!-- NEW Archive Button -->
                        <button onclick="window.archiveCustomer('${customer.id}')" class="text-yellow-600 hover:text-yellow-900 font-semibold">
                            Archive
                        </button>
                        <button onclick="window.deleteCustomer('${customer.id}', '${customer.name.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-900 font-semibold">
                            Delete
                        </button>
                    </td>
                `;
                customerListBody.appendChild(row);
            });
        }
        
        // --- Customer Edit Modal Functions ---
        window.openEditCustomerModal = (customerId) => {
            const customer = customersData.find(item => item.id === customerId);
            if (!customer) {
                console.error("Customer not found for editing:", customerId);
                return;
            }

            editCustomerId.value = customer.id;
            editCustomerName.value = customer.name;
            editCustomerContact.value = customer.contactNumber;
            editCustomerAddress.value = customer.address || '';
            // --- NEW: Load loyalty status ---
            // Use ?? true as a fallback for old customers (default them to loyalty members)
            editCustomerJoinsLoyalty.checked = customer.joinsLoyalty ?? true; 

            editCustomerModal.classList.remove('hidden');
        };

        window.closeEditCustomerModal = () => {
            editCustomerModal.classList.add('hidden');
            editCustomerForm.reset();
        };

        async function handleEditCustomerSubmit(e) {
            e.preventDefault();

            const customerId = editCustomerId.value;
            const updatedCustomer = {
                name: editCustomerName.value.trim(),
                contactNumber: editCustomerContact.value.trim(),
                address: editCustomerAddress.value.trim(),
                joinsLoyalty: editCustomerJoinsLoyalty.checked // <-- NEW
            };

            if (!updatedCustomer.name || !updatedCustomer.contactNumber) {
                customerMessage.textContent = "Name and Contact Number are required.";
                customerMessage.classList.remove('hidden');
                customerMessage.classList.add('text-red-500');
                setTimeout(() => customerMessage.classList.add('hidden'), 5000);
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitButton, 'Saving...'); // <-- MODIFIED

            try {
                if (!userId || !customerId) {
                    throw new Error("User or Customer ID is missing.");
                }

                const itemRef = doc(db, getCustomersCollectionPath(userId), customerId);
                await updateDoc(itemRef, updatedCustomer);

                window.closeEditCustomerModal();
                customerMessage.textContent = `${updatedCustomer.name} updated successfully.`;
                customerMessage.classList.remove('hidden', 'text-red-500');
                customerMessage.classList.add('text-green-500');
                setTimeout(() => customerMessage.classList.add('hidden'), 3000);

            } catch (error) {
                console.error("Error updating customer:", error);
                customerMessage.textContent = `Error updating customer: ${error.message}`;
                customerMessage.classList.remove('hidden');
                customerMessage.classList.add('text-red-500');
                setTimeout(() => customerMessage.classList.add('hidden'), 5000);
            } finally {
                hideButtonLoading(submitButton); // <-- MODIFIED
            }
        }
        editCustomerForm.addEventListener('submit', handleEditCustomerSubmit);
        // --- End of Edit Customer Modal Logic ---


        // --- Customer Dashboard Render Function ---
        function renderCustomerDashboard() {
            if (customerDashboardTotal) {
                customerDashboardTotal.textContent = customersData.length;
            }

            const customerSales = {};
            salesData.forEach(sale => {
                if (sale.customerId) {
                    const customer = customersData.find(c => c.id === sale.customerId);
                    const name = customer ? customer.name : 'Unknown Customer';
                    
                    if (customerSales[name]) {
                        customerSales[name] += sale.totalCost;
                    } else {
                        customerSales[name] = sale.totalCost;
                    }
                }
            });

            const sortedCustomers = Object.entries(customerSales)
                .map(([name, total]) => ({ name, total }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5); // Get top 5

            const labels = sortedCustomers.map(c => c.name);
            const data = sortedCustomers.map(c => c.total);

            if (customerChartInstance) {
                customerChartInstance.destroy();
            }
            
            const chartCanvas = document.getElementById('customer-dashboard-chart');
            if (!chartCanvas) return;
            const ctx = chartCanvas.getContext('2d');

            customerChartInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Sales',
                        data: data,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)', // Indigo
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', 
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: context => `Sales: ${formatCurrency(context.parsed.x)}`
                            }
                        }
                    }
                }
            });
        }


        window.showCustomerHistory = (customerId, customerName) => {
            currentHistoryCustomerId = customerId; 
            historyPlaceholder.classList.add('hidden');
            customerHistoryList.innerHTML = `<h4 class="text-lg font-bold text-gray-800 border-b pb-2">${customerName}'s History</h4>`;

            const history = salesData.filter(sale => sale.customerId === customerId);
            
            if (history.length === 0) {
                customerHistoryList.innerHTML += `<p class="text-gray-500 mt-4">No purchase history found for ${customerName}.</p>`;
                return;
            }

            history.forEach(sale => {
                const materials = sale.materialsUsed.map(m => `${m.qty}x ${m.name}`).join('; ');
                
                const historyItem = document.createElement('div');
                historyItem.className = 'p-3 border border-gray-300 rounded-lg bg-white shadow-sm flex justify-between items-center';
                
                historyItem.innerHTML = `
                    <div>
                        <p class="font-bold text-sm text-indigo-700">${formatCurrency(sale.totalCost)}</p>
                        <p class="text-xs text-gray-500">${sale.date.toLocaleString()}</p>
                        <p class="text-sm mt-1">${materials}</p>
                    </div>
                    <button 
                        onclick="window.reprintReceipt('${sale.id}')"
                        class="text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg transition duration-150 flex items-center"
                        title="Generate Receipt for this transaction"
                    >
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 2h10m0-8a2 2 0 100-4 2 2 0 000 4zm-4 8v-2a3 3 0 00-3-3H8a3 3 0 00-3 3v2"></path></svg>
                        Receipt
                    </button>
                `;
                customerHistoryList.appendChild(historyItem);
            });
        }
        
        window.reprintReceipt = (saleId) => {
            const sale = salesData.find(s => s.id === saleId);
            if (!sale) {
                console.error("Sale record not found for reprinting:", saleId);
                return;
            }

            // Handle old sales that might not have these fields
            const subtotal = sale.subtotal || sale.totalCost; // Default to totalCost if subtotal missing
            const discountAmount = sale.discountAmount || 0; // Default to 0
            const redeemPointsAmount = sale.redeemPointsAmount || 0; // <-- NEW

            // MODIFIED: Pass all new values
            generateReceipt(
                sale.saleId,
                sale.customerName,
                sale.materialsUsed,
                subtotal,
                discountAmount,
                redeemPointsAmount, // <-- NEW
                sale.totalCost,    // This is the final total
                sale.paymentMethod,
                undefined, // <-- NEW: Pass undefined so receipt hides "Points Earned"
                undefined  // <-- NEW: Pass undefined so receipt hides "New Total Points"
            );
        };

        // --- Void Transaction Logic ---

        window.openConfirmVoidModal = (docId, saleId) => {
            if (!docId) return;
            confirmVoidModal.dataset.docId = docId;
            voidMessage.textContent = `To void transaction #${saleId}, please enter your password. This will return all items to inventory.`;
            
            voidPasswordInput.value = '';
            voidErrorMessage.classList.add('hidden');
            voidErrorMessage.textContent = '';
            
            confirmVoidModal.classList.remove('hidden');
        };

        window.closeConfirmVoidModal = () => {
            confirmVoidModal.classList.add('hidden');
            delete confirmVoidModal.dataset.docId;
            voidPasswordInput.value = '';
            voidErrorMessage.classList.add('hidden');
            voidErrorMessage.textContent = '';
        };

        async function voidSaleTransaction() { 
            const docId = confirmVoidModal.dataset.docId;
            const password = voidPasswordInput.value;
            const email = auth.currentUser ? auth.currentUser.email : null;

            if (!docId || !userId || !email) {
                console.error("Missing data for void (docId, userId, or email).");
                voidErrorMessage.textContent = "User data missing. Please log out and in.";
                voidErrorMessage.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                voidErrorMessage.textContent = "Password is required (min 6 chars).";
                voidErrorMessage.classList.remove('hidden');
                return;
            }
            
            showButtonLoading(voidConfirmYes, 'Voiding...');
            
            try {
                // 1. Re-authenticate user to verify password
                const user = auth.currentUser;
                const credential = EmailAuthProvider.credential(user.email, password);
                await reauthenticateWithCredential(user, credential);
                
                // 2. Password is correct. Find the sale to void.
                const saleToVoid = salesData.find(s => s.id === docId);
                if (!saleToVoid || !saleToVoid.materialsUsed) {
                    throw new Error("Sale record not found or has no items.");
                }

                // --- NEW: Create a list of promises to run all at once ---
                const allPromises = [];

                // 3. Add inventory restock promises AND log them
                saleToVoid.materialsUsed.forEach(item => {
                    const material = inventoryData.find(m => m.id === item.id);
                    if (material) {
                        const newStock = Number(material.stock) + Number(item.qty);
                        const itemRef = doc(db, getInventoryCollectionPath(userId), item.id);
                        
                        // Add the update to our promise list
                        allPromises.push(updateDoc(itemRef, { stock: newStock }));
                        
                        // --- NEW: Log this restock to inventory history ---
                        allPromises.push(logInventoryHistory(
                            material.name, 
                            `Stock restocked: +${item.qty} ${item.usageUnit}`, 
                            'stock_in', // This is a 'stock_in' event
                            `Void Sale #${saleToVoid.saleId}`,
                            saleToVoid.saleId // <-- ADD THIS LINE
                        ));
                        // --- END NEW ---

                    } else {
                        console.warn(`Material with ID ${item.id} (${item.name}) not found in inventory. Skipping stock update.`);
                    }
                });

                // 4. --- NEW: Reverse customer loyalty points ---
                if (saleToVoid.customerId) {
                    const customer = customersData.find(c => c.id === saleToVoid.customerId);
                    if (customer) {
                        // Calculate points earned from this sale
                        const loyaltyRate = parseInt(businessSettings.loyaltyRate) || 15;
                        let pointsEarned = 0;
                        if (loyaltyRate > 0) {
                            pointsEarned = Math.floor(saleToVoid.totalCost / loyaltyRate);
                        }
                        
                        // Points redeemed IN this sale
                        const pointsRedeemed = saleToVoid.redeemPointsAmount || 0;

                        // New total = current - earned (from void) + redeemed (from void)
                        const currentPoints = customer.loyaltyPoints || 0;
                        const newTotalPoints = currentPoints - pointsEarned + pointsRedeemed;

                        const customerRef = doc(db, getCustomersCollectionPath(userId), saleToVoid.customerId);
                        
                        // Add customer point update to our promise list
                        allPromises.push(updateDoc(customerRef, { loyaltyPoints: newTotalPoints }));
                        
                        // --- NEW: Log this point adjustment ---
                        const logReason = `Void Sale #${saleToVoid.saleId}`;
                        const logMessage = `Points adjustment: -${pointsEarned} earned, +${pointsRedeemed} redeemed`;
                        allPromises.push(logInventoryHistory(
                            customer.name, 
                            logMessage, 
                            'points_adjustment', 
                            logReason
                        ));
                        // --- END NEW ---
                    }
                }
                // --- END NEW POINT LOGIC ---

                // 5. Add the sale deletion promise
                const saleRef = doc(db, getSalesCollectionPath(userId), docId);
                allPromises.push(deleteDoc(saleRef));
                
                // 6. Run all promises together
                await Promise.all(allPromises);
                
                window.closeConfirmVoidModal();
                posMessage.textContent = 'Transaction voided successfully! Inventory and points have been restored.';
                posMessage.classList.remove('hidden', 'text-red-500');
                posMessage.classList.add('text-green-500');
                setTimeout(() => posMessage.classList.add('hidden'), 5000);

            } catch (error) {
                console.error("Error voiding transaction:", error);
                
                let message = 'An unknown error occurred.';
                if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password. Void failed.';
                } else {
                    message = `Error: ${error.message}`;
                }
                
                voidErrorMessage.textContent = message;
                voidErrorMessage.classList.remove('hidden');

            } finally {
                hideButtonLoading(voidConfirmYes);
            }
        }
        
        voidConfirmYes.addEventListener('click', voidSaleTransaction); 
        voidConfirmNo.addEventListener('click', window.closeConfirmVoidModal);
        // --- End of Void Transaction Logic ---


        // --- Inventory Logic ---

        function listenToInventory(uid) {
            const inventoryRef = collection(db, getInventoryCollectionPath(uid));
            console.debug("Setting up Inventory listener for path:", getInventoryCollectionPath(uid));

            return onSnapshot(inventoryRef, (snapshot) => {
                inventoryData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderInventoryDashboard(); 
                renderInventoryTable();
                updatePosItemSelectors(); // MODIFIED: Update selectors to reflect any changes (e.g., stock)
                renderDashboard(); 
            }, (error) => {
                console.error("Error listening to inventory: ", error.message);
            });
        }
        
        function renderInventoryDashboard() { 
            let totalValueCost = 0; // MODIFIED: Renamed from totalValue
            let totalValueSale = 0; // NEW: For sale price
            let lowStockCount = 0;
            // const lowStockThreshold = 10; // <-- No longer needed

            inventoryData.forEach(item => {
                const stock = Number(item.stock || 0);
                const cost = Number(item.unitCost || 0);
                const salePrice = Number(item.salePrice || 0); // NEW
                const itemLowStockThreshold = Number(item.lowStockThreshold || 10); // <-- ADDED
                
                totalValueCost += stock * cost; // MODIFIED
                totalValueSale += stock * salePrice; // NEW
                
                if (stock > 0 && stock < itemLowStockThreshold) { // <-- MODIFIED
                    lowStockCount++;
                }
            });

            inventoryDashboard.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                    <p class="text-sm font-medium text-gray-500">Total Inventory Value (unit cost/puhunan)</p>
                    <p class="text-3xl font-bold text-indigo-700 mt-1">${formatCurrency(totalValueCost)}</p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                    <p class="text-sm font-medium text-gray-500">Total Inventory Value (total sale price/kabuuang benta)</p>
                    <p class="text-3xl font-bold text-green-700 mt-1">${formatCurrency(totalValueSale)}</p>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-${lowStockCount > 0 ? 'red' : 'green'}-500">
                    <p class="text-sm font-medium text-gray-500">Low Stock Items (Below Item Threshold)</p>
                    <p class="text-3xl font-bold text-${lowStockCount > 0 ? 'red' : 'green'}-700 mt-1">${lowStockCount} Items</p>
                </div>
            `;
        }

        function filterInventory() {
            const searchTerm = inventorySearchInput.value.toLowerCase().trim();
            const filteredData = inventoryData.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );
            renderInventoryTable(filteredData);
        }
        inventorySearchInput.addEventListener('input', debounce(filterInventory, 300)); 


        function renderInventoryTable(data = inventoryData) {
            inventoryTableBody.innerHTML = '';
            const dataToRender = data.length > 0 ? data : (inventorySearchInput.value ? [] : inventoryData);

            if (inventorySearchInput.value && data.length === 0) {
                 inventoryEmptyMessage.textContent = "No materials found matching your search.";
                 inventoryEmptyMessage.classList.remove('hidden');
                 return;
            }
            
            if (inventoryData.length === 0) {
                inventoryEmptyMessage.textContent = "No inventory items found. Add one below!";
                inventoryEmptyMessage.classList.remove('hidden');
                return;
            }
            
            inventoryEmptyMessage.classList.add('hidden');

            (data.length > 0 || !inventorySearchInput.value ? inventoryData : []).filter(item => {
                const searchTerm = inventorySearchInput.value.toLowerCase().trim();
                return item.name.toLowerCase().includes(searchTerm);
            }).forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                const stockValue = Number(item.stock || 0);
                const itemLowStockThreshold = Number(item.lowStockThreshold || 10); // <-- ADD THIS
                const costValue = Number(item.unitCost || 0);
                const salePriceValue = Number(item.salePrice || 0); // <-- ADD THIS

                // --- NEW: Profit & Margin Calculations ---
                const profit = salePriceValue - costValue;
                const margin = salePriceValue > 0 ? (profit / salePriceValue) * 100 : 0;
                // --- END: New Calculations ---

                const uomString = `${item.purchaseUnit} (${item.conversionFactor} ${item.usageUnit})`;
                const categoryName = categoriesData.find(c => c.id === item.categoryId)?.name || 'Uncategorized'; 

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${categoryName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.subCategoryName || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(costValue)}/${item.usageUnit}</td>

                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">${formatCurrency(salePriceValue)}/${item.usageUnit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600">${formatCurrency(profit)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${margin.toFixed(1)}%</td>

                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${stockValue < itemLowStockThreshold ? 'text-red-500' : 'text-green-600'}">${stockValue} ${item.usageUnit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-400">${uomString}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="window.openEditMaterialModal('${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3 font-semibold">
                            Edit
                        </button>
                        <button onclick="window.openReceiveStockModal('${item.id}')" class="text-green-600 hover:text-green-900 mr-3 font-semibold">
                            Add Stock
                        </button>
                        <button onclick="window.openUseMaterialModal('${item.id}')" class="text-red-600 hover:text-red-900 mr-3 font-semibold">
                            Use
                        </button>
                        <!-- NEW Archive Button -->
                        <button onclick="window.archiveInventoryItem('${item.id}')" class="text-yellow-600 hover:text-yellow-900 mr-3 font-semibold">
                            Archive
                        </button>
                        <button onclick="window.openConfirmInventoryDeleteModal('${item.id}', '${item.name.replace(/'/g, "\\'")}')" class="text-red-500 hover:text-red-700 font-semibold">
                            Delete
                        </button>
                    </td>
                `;
                inventoryTableBody.appendChild(row);
            });
        }


        async function addMaterial() {
            const categoryId = document.getElementById('new-material-category').value; 
            const categoryName = document.getElementById('new-material-category').options[document.getElementById('new-material-category').selectedIndex].text; 
            // --- NEW ---
            const subCategorySelect = document.getElementById('new-material-subcategory');
            const subCategoryId = subCategorySelect.value;
            const subCategoryName = subCategoryId ? subCategorySelect.options[subCategorySelect.selectedIndex].text : '';
            // --- END NEW ---
            const name = document.getElementById('new-material-name').value.trim();
            const cost = parseFloat(document.getElementById('new-material-cost').value);
            const stock = parseInt(document.getElementById('new-material-stock').value);
            const usageUnit = document.getElementById('new-material-usage-unit').value.trim(); 
            const salePrice = parseFloat(document.getElementById('new-material-sale-price').value);
            const purchaseUnit = document.getElementById('new-material-purchase-unit').value.trim(); 
            const conversionFactor = parseInt(document.getElementById('new-material-conversion-factor').value); 
            const lowStock = parseInt(document.getElementById('new-material-low-stock').value); // <-- ADDED

            if (!categoryId || !name || isNaN(cost) || cost <= 0 || isNaN(salePrice) || salePrice <= 0 || isNaN(stock) || !userId || !usageUnit || !purchaseUnit || isNaN(conversionFactor) || conversionFactor <= 0 || isNaN(lowStock) || lowStock < 0) { // <-- MODIFIED
                console.error("Invalid input for new material or userId missing.");
                posMessage.textContent = "Please fill all fields (Category, Name, Cost, Sale Price, Stock, Units, Conversion, and Low Stock) with valid values."; // <-- MODIFIED
                posMessage.classList.remove('hidden');
                posMessage.classList.add('text-red-500');
                setTimeout(() => posMessage.classList.add('hidden'), 5000);
                return;
            }
            const addButton = document.getElementById('add-material-button'); // <-- ADD THIS
            try {
                showButtonLoading(addButton, 'Creating...'); // <-- ADD THIS
                await addDoc(collection(db, getInventoryCollectionPath(userId)), {
                    categoryId: categoryId, 
                    categoryName: categoryName, 
                    subCategoryId: subCategoryId || '', // <-- ADD THIS
                    subCategoryName: subCategoryName || '', // <-- ADD THIS
                    name: name,
                    unitCost: cost, // This is COGS
                    salePrice: salePrice, // This is Sale Price
                    stock: stock,
                    usageUnit: usageUnit, 
                    purchaseUnit: purchaseUnit, 
                    conversionFactor: conversionFactor, 
                    lowStockThreshold: lowStock, // <-- ADD THIS
                    createdAt: Timestamp.now()
                });

                document.getElementById('new-material-category').value = '';
                document.getElementById('new-material-subcategory').innerHTML = '<option value="">-- Select Sub-Category --</option>'; // <-- ADD THIS
                document.getElementById('new-material-name').value = '';
                document.getElementById('new-material-cost').value = '';
                document.getElementById('new-material-stock').value = 0;
                document.getElementById('new-material-sale-price').value = '';
                document.getElementById('new-material-usage-unit').value = '';
                document.getElementById('new-material-purchase-unit').value = '';
                document.getElementById('new-material-conversion-factor').value = '';
                document.getElementById('new-material-low-stock').value = '10'; // <-- ADD THIS


                posMessage.textContent = `${name} added successfully!`;
                posMessage.classList.remove('hidden', 'text-red-500');
                posMessage.classList.add('text-green-500');
                setTimeout(() => posMessage.classList.add('hidden'), 3000);

            } catch (error) {
                console.error("Error adding material:", error);
            } finally {
                hideButtonLoading(addButton); // <-- ADD THIS
            }
        }
        document.getElementById('add-material-button').addEventListener('click', addMaterial);

        // --- Stock Adjustment Modals ---

        // Edit Material Modal Logic
        const editMaterialForm = document.getElementById('edit-material-form');
        const editMaterialId = document.getElementById('edit-material-id');
        const editMaterialCategory = document.getElementById('edit-material-category'); 
        const editMaterialSubCategory = document.getElementById('edit-material-subcategory'); // <-- ADD THIS
        const editMaterialName = document.getElementById('edit-material-name');
        const editMaterialStock = document.getElementById('edit-material-stock');
        const editMaterialCost = document.getElementById('edit-material-cost');
        const editMaterialUsageUnit = document.getElementById('edit-material-usage-unit');
        const editMaterialSalePrice = document.getElementById('edit-material-sale-price');
        const editMaterialPurchaseUnit = document.getElementById('edit-material-purchase-unit');
        const editMaterialConversionFactor = document.getElementById('edit-material-conversion-factor');
        const editMaterialLowStock = document.getElementById('edit-material-low-stock'); // <-- ADD THIS

        window.openEditMaterialModal = (materialId) => {
            const material = inventoryData.find(item => item.id === materialId);
            if (!material) {
                console.error("Material not found for editing:", materialId);
                return;
            }

            editMaterialId.value = material.id;
            editMaterialName.value = material.name;
            editMaterialStock.value = material.stock;
            editMaterialCost.value = material.unitCost;
            editMaterialUsageUnit.value = material.usageUnit;
            editMaterialSalePrice.value = material.salePrice;
            editMaterialPurchaseUnit.value = material.purchaseUnit;
            editMaterialConversionFactor.value = material.conversionFactor;
            editMaterialLowStock.value = material.lowStockThreshold || 10; // <-- ADD THIS

            updateCategorySelectors(material.categoryId); // Load all categories, select parent
            editMaterialCategory.value = material.categoryId || '';
            
            // --- NEW: Load sub-categories for that parent ---
            updateSubCategorySelectors(material.categoryId, material.subCategoryId);
            editMaterialSubCategory.value = material.subCategoryId || '';
            // --- END NEW ---

            editMaterialModal.classList.remove('hidden');
        };

        window.closeEditMaterialModal = () => {
            editMaterialModal.classList.add('hidden');
            editMaterialForm.reset();
        };

        async function handleEditMaterialSubmit(e) {
            e.preventDefault();
            
            const materialId = editMaterialId.value;
            const categoryId = editMaterialCategory.value; 
            const categoryName = editMaterialCategory.options[editMaterialCategory.selectedIndex].text; 
            // --- NEW ---
            const subCategoryId = editMaterialSubCategory.value;
            const subCategoryName = subCategoryId ? editMaterialSubCategory.options[editMaterialSubCategory.selectedIndex].text : '';
            // --- END NEW ---

            const updatedMaterial = {
                categoryId: categoryId, 
                categoryName: categoryName, 
                subCategoryId: subCategoryId || '', // <-- ADD THIS
                subCategoryName: subCategoryName || '', // <-- ADD THIS
                name: editMaterialName.value.trim(),
                stock: parseInt(editMaterialStock.value),
                unitCost: parseFloat(editMaterialCost.value),
                usageUnit: editMaterialUsageUnit.value.trim(),
                salePrice: parseFloat(editMaterialSalePrice.value),
                purchaseUnit: editMaterialPurchaseUnit.value.trim(),
                conversionFactor: parseInt(editMaterialConversionFactor.value),
                lowStockThreshold: parseInt(editMaterialLowStock.value) // <-- ADD THIS
            };

            if (!updatedMaterial.categoryId || !updatedMaterial.name || isNaN(updatedMaterial.stock) || isNaN(updatedMaterial.unitCost) || isNaN(updatedMaterial.salePrice) || !updatedMaterial.usageUnit || !updatedMaterial.purchaseUnit || isNaN(updatedMaterial.conversionFactor) || isNaN(updatedMaterial.lowStockThreshold) || updatedMaterial.unitCost <= 0 || updatedMaterial.salePrice <= 0 || updatedMaterial.conversionFactor <= 0 || updatedMaterial.lowStockThreshold < 0) { // <-- MODIFIED
                
                posMessage.textContent = "Please fill all fields (Category, Cost, Sale Price, Low Stock, etc.) with valid, positive values."; // <-- MODIFIED
                posMessage.classList.remove('hidden');
                posMessage.classList.add('text-red-500');
                setTimeout(() => posMessage.classList.add('hidden'), 5000);
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitButton, 'Saving...');

            try {
                if (!userId || !materialId) {
                    throw new Error("User or Material ID is missing.");
                }
                
                const itemRef = doc(db, getInventoryCollectionPath(userId), materialId);
                await updateDoc(itemRef, updatedMaterial);

                window.closeEditMaterialModal();
                posMessage.textContent = `${updatedMaterial.name} updated successfully.`;
                posMessage.classList.remove('hidden', 'text-red-500');
                posMessage.classList.add('text-green-500');
                setTimeout(() => posMessage.classList.add('hidden'), 3000);

            } catch (error) {
                console.error("Error updating material:", error);
                posMessage.textContent = `Error updating material: ${error.message}`;
                posMessage.classList.remove('hidden');
                posMessage.classList.add('text-red-500');
                setTimeout(() => posMessage.classList.add('hidden'), 5000);
            } finally {
                hideButtonLoading(submitButton);
            }
        }
        editMaterialForm.addEventListener('submit', handleEditMaterialSubmit);
        // --- End of Edit Material Modal Logic ---


        window.openReceiveStockModal = (materialId) => {
            if (!inventoryData.length) return;
            
            receiveMaterialSelect.innerHTML = inventoryData.map(item => 
                `<option value="${item.id}" ${item.id === materialId ? 'selected' : ''}>${item.name}</option>`
            ).join('');

            updateReceiveStockInfo();
            receiveQuantityInput.value = 1;

            receiveMaterialSelect.onchange = updateReceiveStockInfo;
            receiveQuantityInput.oninput = updateReceiveStockInfo;
            
            receiveStockModal.classList.remove('hidden');
        };

        window.closeReceiveStockModal = () => {
            receiveStockModal.classList.add('hidden');
            document.getElementById('receive-stock-form').reset();
            receiveMaterialSelect.onchange = null;
            receiveQuantityInput.oninput = null;
        };

        function updateReceiveStockInfo() {
            const selectedId = receiveMaterialSelect.value;
            const material = inventoryData.find(item => item.id === selectedId);
            const qty = parseInt(receiveQuantityInput.value) || 0;

            if (material) {
                receivePurchaseUnit.textContent = material.purchaseUnit;
                const convertedQty = qty * material.conversionFactor;
                receiveConversionInfo.textContent = `${qty} ${material.purchaseUnit} = ${convertedQty} ${material.usageUnit} (to be added to stock).`;
            } else {
                receivePurchaseUnit.textContent = '';
                receiveConversionInfo.textContent = 'Please select a material.';
            }
        }

        document.getElementById('receive-stock-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const materialId = receiveMaterialSelect.value;
            const qty = parseInt(receiveQuantityInput.value);
            const reason = document.getElementById('receive-reason').value.trim(); // <-- ADD THIS
            
            if (!userId || !materialId || qty <= 0) return;

            const material = inventoryData.find(item => item.id === materialId);
            if (!material) return;

            const unitsToAdd = qty * material.conversionFactor;
            const newStock = Number(material.stock) + unitsToAdd;
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitButton, 'Updating...');

            try {
                const itemRef = doc(db, getInventoryCollectionPath(userId), materialId);
                await updateDoc(itemRef, { stock: newStock });
                // NEW: Log this history
                await logInventoryHistory(material.name, `Stock received: +${unitsToAdd} ${material.usageUnit}`, 'stock_in', reason); // <-- MODIFIED

                window.closeReceiveStockModal();
                posMessage.textContent = `Stock received: ${unitsToAdd} ${material.usageUnit} added to ${material.name}.`;
                posMessage.classList.remove('hidden', 'text-red-500');
                posMessage.classList.add('text-green-500');
                setTimeout(() => posMessage.classList.add('hidden'), 5000);

            } catch (error) {
                console.error("Error receiving stock:", error);
            } finally {
                hideButtonLoading(submitButton);
            }
        });


        window.openUseMaterialModal = (materialId) => {
            if (!inventoryData.length) return;
            
            useMaterialSelect.innerHTML = inventoryData.map(item => 
                `<option value="${item.id}" ${item.id === materialId ? 'selected' : ''}>${item.name}</option>`
            ).join('');

            updateUseMaterialInfo();
            useQuantityInput.value = 1;

            useMaterialSelect.onchange = updateUseMaterialInfo;
            useQuantityInput.oninput = updateUseMaterialInfo;

            useMaterialModal.classList.remove('hidden');
        };



        window.closeUseMaterialModal = () => {
            useMaterialModal.classList.add('hidden');
            document.getElementById('use-material-form').reset();
            useMaterialSelect.onchange = null;
            useQuantityInput.oninput = null;
        };


        function updateUseMaterialInfo() {
            const selectedId = useMaterialSelect.value;
            const material = inventoryData.find(item => item.id === selectedId);
            const qty = parseInt(useQuantityInput.value) || 0;

            if (material) {
                useUsageUnit.textContent = material.usageUnit;
                const remainingStock = Number(material.stock) - qty;
                useStockInfo.textContent = `Current Stock: ${material.stock} ${material.usageUnit}. Remaining: ${remainingStock} ${material.usageUnit}.`;
                useStockInfo.className = `text-sm font-medium text-center border p-2 rounded-lg ${remainingStock < 0 ? 'bg-red-50 text-red-700' : 'bg-gray-50 text-gray-700'}`;
            } else {
                useUsageUnit.textContent = '';
                useStockInfo.textContent = 'Please select a material.';
            }
        }

        document.getElementById('use-material-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const materialId = useMaterialSelect.value;
            const qty = parseInt(useQuantityInput.value);
            const reason = document.getElementById('use-reason').value.trim(); // <-- ADD THIS
            
            if (!userId || !materialId || qty <= 0) return;

            const material = inventoryData.find(item => item.id === materialId);
            if (!material) return;

            const newStock = Number(material.stock) - qty;
            
            if (newStock < 0) {
                posMessage.textContent = `Warning: This action will result in negative stock. Please adjust quantity.`;
                posMessage.classList.remove('hidden');
                posMessage.classList.add('text-red-500');
                setTimeout(() => posMessage.classList.add('hidden'), 5000);
                return;
            }
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitButton, 'Updating...');

            try {
                const itemRef = doc(db, getInventoryCollectionPath(userId), materialId);
                await updateDoc(itemRef, { stock: newStock });
                // NEW: Log this history
                await logInventoryHistory(material.name, `Stock used: -${qty} ${material.usageUnit}`, 'stock_out', reason); // <-- MODIFIED
                
                // NEW: Check for low stock
                const itemLowStockThreshold = Number(material.lowStockThreshold || 10); // <-- MODIFIED
                if (newStock > 0 && newStock < itemLowStockThreshold) { 
                     await logInventoryHistory(material.name, `Stock is LOW: ${newStock} ${material.usageUnit} remaining`, 'low_stock', ''); // <-- MODIFIED
                }

                window.closeUseMaterialModal();
                posMessage.textContent = `Material used: ${qty} ${material.usageUnit} deducted from ${material.name}.`;
                posMessage.classList.remove('hidden', 'text-red-500');
                posMessage.classList.add('text-green-500');
                setTimeout(() => posMessage.classList.add('hidden'), 5000);

            } catch (error) {
                console.error("Error using material:", error);
            } finally {
                hideButtonLoading(submitButton);
            }
        });



        // --- POS Logic ---
        
        function updatePosCustomerSelector(searchTerm = '') { 
            const selector = posCustomerSelector;
            if (!selector) return;

            const currentId = selector.value;
            
            const filteredCustomers = customersData.filter(c => 
                c.name.toLowerCase().includes(searchTerm) || 
                c.contactNumber.includes(searchTerm)
            );

            selector.innerHTML = `
                <option value="">-- Select Existing Customer (${filteredCustomers.length} found) --</option>
                ${filteredCustomers.map(c => 
                    `<option value="${c.id}" ${c.id === currentId ? 'selected' : ''}>${c.name} (${c.contactNumber})</option>`
                ).join('')}
            `;
            
            const currentSelectedStillValid = filteredCustomers.some(c => c.id === currentId);

            if (currentId && currentSelectedStillValid) {
                selectedCustomerId = currentId;
                customerNameInput.disabled = true;
                const customer = customersData.find(c => c.id === currentId);
                if (customer) customerNameInput.value = customer.name;
            } else {
                selectedCustomerId = null;
                customerNameInput.disabled = false;
                selector.value = "";
                customerNameInput.value = '';
            }
            
            if(!selector.value) {
                selectedCustomerId = null;
                customerNameInput.disabled = false;
                customerNameInput.value = '';
            }

            checkPosStatus();
        }
        
        posCustomerSelector.addEventListener('change', (e) => {
            const customerId = e.target.value;
            selectedCustomerId = customerId;

            if (customerId) {
                const customer = customersData.find(c => c.id === customerId);
                if (customer) {
                    const currentPoints = customer.loyaltyPoints || 0;
                    customerNameInput.value = customer.name;
                    customerNameInput.disabled = true;

                    // --- NEW: Only show points if customer is a loyalty member ---
                    // Use ?? true as a fallback for old customers
                    const isLoyaltyMember = customer.joinsLoyalty ?? true; 

                    if (isLoyaltyMember) {
                        // Show points display
                        posCustomerPoints.textContent = currentPoints;
                        posCustomerPointsDisplay.classList.remove('hidden');

                        // Show and configure redeem field
                        posCustomerAvailablePoints.textContent = currentPoints;
                        posRedeemPointsInput.max = currentPoints; // Set max redeemable
                        posRedeemPointsInput.value = 0; // Reset on change
                        posRedeemPointsContainer.classList.remove('hidden');
                    } else {
                        // Not a loyalty member, hide points
                        posCustomerPointsDisplay.classList.add('hidden');
                        posRedeemPointsContainer.classList.add('hidden');
                        posRedeemPointsInput.value = 0;
                    }

                }
                posCustomerSearchInput.value = ''; 
                updatePosCustomerSelector(); 
            } else {
                // Hide all customer-specific fields
                customerNameInput.disabled = false;
                customerNameInput.value = '';
                posCustomerPointsDisplay.classList.add('hidden');
                posRedeemPointsContainer.classList.add('hidden');
                posRedeemPointsInput.value = 0;
            }
            calculateTotal(); // Recalculate total since redeem points were reset
        });
        
        posCustomerSearchInput.addEventListener('input', () => {
            const currentSelectedId = posCustomerSelector.value;
            updatePosCustomerSelector(posCustomerSearchInput.value.toLowerCase().trim());
            if (customersData.find(c => c.id === currentSelectedId)) {
                posCustomerSelector.value = currentSelectedId;
            }
        });

        // MODIFIED: To prevent item duplication and add search
        // REVISED: To group items by sub-category in the dropdown
        function getPosSelectOptions(currentItemName = '', searchTerm = '') {
            const searchLower = searchTerm.toLowerCase();

            // 1. Find all item names *already selected* in other dropdowns
            const selectedNames = currentItems
                .map(item => item.name)
                .filter(name => name && name !== currentItemName); // Exclude self and empty

            // 2. Filter the main inventory list
            const availableInventory = inventoryData.filter(material => 
                !selectedNames.includes(material.name) && // Item is not selected elsewhere
                (material.name.toLowerCase().includes(searchLower) || (material.subCategoryName && material.subCategoryName.toLowerCase().includes(searchLower))) // Search item OR sub-category
            );

            // 3. Generate HTML
            const optionsHtml = categoriesData.map(category => {
                const itemsInCategory = availableInventory.filter(m => m.categoryId === category.id);
                if (itemsInCategory.length === 0) return '';

                // --- NEW HIERARCHY LOGIC ---

                // A. Find all unique sub-category IDs in this group of items
                const subCategoryIds = [...new Set(itemsInCategory.map(item => item.subCategoryId).filter(id => id))];

                // B. Get the sub-category objects and sort them
                const subCategories = subCategoryIds
                    .map(id => subCategoriesData.find(sub => sub.id === id))
                    .filter(sub => sub) // Filter out any undefined/missing
                    .sort((a, b) => a.name.localeCompare(b.name));

                // C. Generate HTML for items *with* sub-categories
                const subCategoryHtml = subCategories.map(sub => {
                    // Get items for *this* sub-category
                    const itemsInSubCategory = itemsInCategory.filter(item => item.subCategoryId === sub.id);
                    if (itemsInSubCategory.length === 0) return '';

                    // Add the sub-category as a disabled, indented header
                    const header = `<option disabled>&nbsp;&nbsp;- ${sub.name}</option>`;

                    const itemsHtml = itemsInSubCategory.map(material => {
                        // Use &nbsp;&nbsp;&nbsp;&nbsp; for more indentation
                        // We remove the [SubName] prefix as it's now redundant
                        const displayName = `&nbsp;&nbsp;&nbsp;&nbsp;-- ${material.name}`; 
                        return `<option value="${material.name}" ${material.name === currentItemName ? 'selected' : ''}>${displayName} (${formatCurrency(material.salePrice || 0)}) (Stock: ${material.stock})</option>`
                    }).join('');

                    return header + itemsHtml;
                }).join('');

                // D. Generate HTML for items *without* sub-categories
                const noSubCategoryItems = itemsInCategory.filter(item => !item.subCategoryId);
                const noSubCategoryHtml = noSubCategoryItems.map(material => {
                    const displayName = `&nbsp;&nbsp;&nbsp;&nbsp;-- ${material.name}`; // Indent these too
                    return `<option value="${material.name}" ${material.name === currentItemName ? 'selected' : ''}>${displayName} (${formatCurrency(material.salePrice || 0)}) (Stock: ${material.stock})</option>`
                }).join('');

                // E. Add a header for the "no sub-category" items if they exist
                const noSubCategoryHeader = (noSubCategoryItems.length > 0 && subCategories.length > 0) ? `<option disabled>&nbsp;&nbsp;- (Other)</option>` : '';

                // --- END HIERARCHY LOGIC ---

                return `
                    <optgroup label="${category.name}">
                        ${subCategoryHtml}
                        ${noSubCategoryHeader}
                        ${noSubCategoryHtml}
                    </optgroup>
                `;
            }).join('');

            const uncategorizedItems = availableInventory.filter(m => !m.categoryId && m.name.toLowerCase().includes(searchLower));
            const uncategorizedHtml = uncategorizedItems.length > 0 ? `
                <optgroup label="Uncategorized">
                    ${uncategorizedItems.map(material => {
                        // Match indentation
                        const displayName = `&nbsp;&nbsp;&nbsp;&nbsp;-- ${material.name}`; 
                        return `<option value="${material.name}" ${material.name === currentItemName ? 'selected' : ''}>${displayName} (${formatCurrency(material.salePrice || 0)}) (Stock: ${material.stock})</option>`
                    }).join('')}
                </optgroup>
            ` : '';

            return `<option value="">-- Select Material --</option>${optionsHtml}${uncategorizedHtml}`;
        }


        // MODIFIED: To update *all* selectors when one changes
        function updatePosItemSelectors() {
            // const searchTerm = posItemSearchInput.value; // <-- REMOVED
            currentItems.forEach(item => {
                const selectEl = document.getElementById(`item-select-${item.id}`);
                if (selectEl) {
                    const selectedName = selectEl.value; // This is item.name
                    const material = inventoryData.find(m => m.name === selectedName);
                    
                    // Regenerate options, filtering out items selected in *other* dropdowns
                    // We pass an empty string ('') so it doesn't filter by search
                    selectEl.innerHTML = getPosSelectOptions(selectedName, ''); // <-- MODIFIED
                    
                    if (material) {
                        item.usageUnit = material.usageUnit;
                    }
                }
            });
            calculateTotal();
        }

        // REBUILT: To include a per-item search bar
        function createPosItemElement(itemId) {
            const item = currentItems.find(i => i.id === itemId);
            const itemEl = document.createElement('div');
            itemEl.id = `pos-item-${itemId}`;
            // Added dark:bg-gray-700
            itemEl.className = 'flex items-start space-x-3 p-3 mb-4 p-4 border border-indigo-200 bg-indigo-102 rounded-lg';

            // Get the select options *without* any search term
            const selectHtml = getPosSelectOptions(item.name, '');

            // NEW: innerHTML with a search bar and select
            itemEl.innerHTML = `
                <div class="flex-grow space-y-2">
                    <input type="text" id="item-search-${itemId}" class="w-full rounded-md border-gray-300 p-2 border focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type to search material...">
                    <select id="item-select-${itemId}" class="w-full rounded-md border-gray-300 p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                        ${selectHtml}
                    </select>
                </div>
                <div class="w-24 self-end">
                    <input type="number" id="item-qty-${itemId}" value="${item.qty}" min="1" class="w-full rounded-md border-gray-300 shadow-sm p-2 border text-center" placeholder="Qty">
                </div>
                <button onclick="window.removeItem('${itemId}')" class="text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150 self-end">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            `;

            // --- NEW: Event Listeners for the row ---
            const searchInput = itemEl.querySelector(`#item-search-${itemId}`);
            const selectEl = itemEl.querySelector(`#item-select-${itemId}`);
            
            // 1. Listener for the new search input
            searchInput.addEventListener('input', debounce(() => {
                const searchTerm = searchInput.value;
                const currentSelection = selectEl.value;
                // Re-render *only this* select's options based on the search
                selectEl.innerHTML = getPosSelectOptions(currentSelection, searchTerm);
            }, 300));

            // 2. Listener for the select element
            selectEl.addEventListener('change', (e) => {
                const selectedName = e.target.value;
                const material = inventoryData.find(m => m.name === selectedName);

                const currentItem = currentItems.find(i => i.id === itemId);
                if (currentItem) {
                    currentItem.name = selectedName;
                    currentItem.cost = material ? material.salePrice : 0;
                    currentItem.cogs = material ? material.unitCost : 0;
                    currentItem.usageUnit = material ? material.usageUnit : ''; 
                }
                
                // When one item changes, update ALL *other* dropdowns to reflect new availability
                updatePosItemSelectors(); 
            });

            // 3. Listener for the quantity
            itemEl.querySelector(`#item-qty-${itemId}`).addEventListener('input', (e) => {
                const qty = parseInt(e.target.value) || 0;
                const currentItem = currentItems.find(i => i.id === itemId);
                if (currentItem) currentItem.qty = qty;
                calculateTotal();
            });

            return itemEl;
        }

        // MODIFIED: Check for duplication *before* adding
        // MODIFIED: Check for duplication *before* adding
        function addItem() {
            // --- FIX: Removed the check that prevented adding multiple empty rows ---
            // const hasEmptyRow = currentItems.some(item => !item.name);
            // if (hasEmptyRow && currentItems.length > 0) {
            //     posMessage.textContent = "Please select a material in the existing row first.";
            //     posMessage.classList.remove('hidden');
            //     posMessage.classList.add('text-red-500');
            //     setTimeout(() => posMessage.classList.add('hidden'), 3000);
            //     return;
            // }

            const newItemId = crypto.randomUUID();
            currentItems.push({ id: newItemId, name: '', qty: 1, cost: 0, cogs: 0, usageUnit: '' });
            posItemsContainer.appendChild(createPosItemElement(newItemId));

            // Update all selectors to account for this new (empty) row
            updatePosItemSelectors();
            checkPosStatus();
        }
        document.getElementById('add-item-button').addEventListener('click', addItem);

        // MODIFIED: Must update all selectors after removing an item
        window.removeItem = (itemId) => {
            currentItems = currentItems.filter(item => item.id !== itemId);
            document.getElementById(`pos-item-${itemId}`).remove();
            
            // Update all selectors to make the removed item available again
            updatePosItemSelectors();
            checkPosStatus();

            if (currentItems.length === 0) {
                 addItem();
            }
        };

        function calculateTotal() {
            let subtotal = 0;
            let totalCOGS = 0; 
            posSummaryItems.innerHTML = '';
            let isValid = true;
            posMessage.classList.add('hidden'); // Hide any old messages

            currentItems.forEach(item => {
                const material = inventoryData.find(m => m.name === item.name);
                const quantity = item.qty;

                if (!material || quantity <= 0 || material.stock < quantity) {
                    isValid = false;
                }

                if (material) {
                    const itemSubtotal = (material.salePrice || 0) * quantity;
                    const cogsSubtotal = (material.unitCost || 0) * quantity; 
                    
                    subtotal += itemSubtotal;
                    totalCOGS += cogsSubtotal; 
                    
                    item.subtotal = itemSubtotal;
                    item.cogsSubtotal = cogsSubtotal; 
                    item.usageUnit = material.usageUnit || ''; 

                    const summaryEl = document.createElement('div');
                    summaryEl.className = 'flex justify-between text-sm';
                    summaryEl.innerHTML = `
                        <span class="${material.stock < quantity ? 'text-red-500 font-semibold' : 'text-gray-600'}">${item.name} x ${quantity} ${item.usageUnit}</span>
                        <span>${formatCurrency(itemSubtotal)}</span>
                    `;
                    posSummaryItems.appendChild(summaryEl);
                }
            });

            // --- DISCOUNT & REDEEM LOGIC ---
            
            // 1. Calculate Discount
            let discountValue = parseFloat(posDiscountInput.value) || 0;
            let discountAmount = 0;

            if (discountValue < 0) {
                posDiscountInput.value = 0;
                discountValue = 0;
            }

            if (isDiscountPercent) {
                if (discountValue > 100) {
                    discountValue = 100;
                    posDiscountInput.value = 100;
                }
                // Calculate the ₱ amount from the percentage
                discountAmount = subtotal * (discountValue / 100);
            } else {
                // ₱ amount is just the value
                discountAmount = discountValue;
            }
            
            // 2. Calculate amount after flat/percent discount
            const totalAfterDiscount = subtotal - discountAmount;
            
            if (totalAfterDiscount < 0 && !isDiscountPercent) {
                // If flat discount is more than subtotal, cap it
                discountAmount = subtotal;
                posDiscountInput.value = subtotal;
            }

            // 3. Calculate Redeemed Points
            let redeemPointsAmount = parseInt(posRedeemPointsInput.value) || 0;
            let customerPoints = 0;
            if (selectedCustomerId) {
                const customer = customersData.find(c => c.id === selectedCustomerId);
                customerPoints = customer.loyaltyPoints || 0;
            }

            // 4. Validate Redeemed Points
            if (redeemPointsAmount < 0) {
                redeemPointsAmount = 0;
                posRedeemPointsInput.value = 0;
            }
            if (redeemPointsAmount > customerPoints) {
                redeemPointsAmount = customerPoints;
                posRedeemPointsInput.value = redeemPointsAmount;
                posMessage.textContent = "Redeem amount capped at customer's total points.";
                posMessage.classList.remove('hidden', 'text-green-500');
                posMessage.classList.add('text-red-500');
            }
            
            // Check if redeem points are more than the bill *after discount*
            if (redeemPointsAmount > totalAfterDiscount) {
                redeemPointsAmount = Math.max(0, Math.floor(totalAfterDiscount)); // Use floor for points
                posRedeemPointsInput.value = redeemPointsAmount;
                posMessage.textContent = "Redeem amount capped at total bill after discount.";
                posMessage.classList.remove('hidden', 'text-green-500');
                posMessage.classList.add('text-red-500');
            }

            // 5. Calculate Final Total
            const finalTotalCost = totalAfterDiscount - redeemPointsAmount;

            // Update the summary UI
            posSubtotal.textContent = formatCurrency(subtotal);
            totalCostSpan.textContent = formatCurrency(finalTotalCost < 0 ? 0 : finalTotalCost);
            // --- END NEW LOGIC ---

            checkPosStatus(isValid, finalTotalCost); // Pass final total
            
            return { 
                subtotal: subtotal,
                discountValue: discountValue, // The raw value (e.g., 10 for 10% or 10 for ₱10)
                discountAmount: discountAmount, // The final calculated ₱ amount
                redeemPointsAmount: redeemPointsAmount,
                totalCost: finalTotalCost < 0 ? 0 : finalTotalCost, 
                totalCOGS: totalCOGS 
            };
        }

        const debouncedCalculateTotalOnName = debounce(calculateTotal, 200);
        customerNameInput.addEventListener('input', debouncedCalculateTotalOnName);
        posPaymentMethod.addEventListener('change', checkPosStatus); // <-- NEW
        posDiscountInput.addEventListener('input', calculateTotal); // <-- NEW
        posRedeemPointsInput.addEventListener('input', calculateTotal); // <-- NEW

        // --- NEW: Discount Toggle Logic ---
        function toggleDiscountType() {
            isDiscountPercent = !isDiscountPercent; // Flip the state
            
            if (isDiscountPercent) {
                posDiscountLabel.textContent = 'Discount (%):';
                posDiscountToggle.textContent = '₱';
                posDiscountInput.step = '1'; // Allow whole numbers for percent
                posDiscountInput.max = '100'; // Can't go over 100%
            } else {
                posDiscountLabel.textContent = 'Discount (₱):';
                posDiscountToggle.textContent = '%';
                posDiscountInput.step = '0.01'; // Allow decimals for currency
                posDiscountInput.removeAttribute('max'); // No max for flat amount
            }
            posDiscountInput.value = 0; // Reset value
            calculateTotal(); // Recalculate
        }
        posDiscountToggle.addEventListener('click', toggleDiscountType);
        // --- END: Discount Toggle Logic ---
        
        

        function checkPosStatus(itemsValid = true, totalCost = 0) { // <-- MODIFIED
            const customerName = customerNameInput.value.trim();
            const paymentMethod = posPaymentMethod.value; 
            const itemsValidForSale = currentItems.length > 0 && itemsValid && currentItems.every(i => i.name && i.qty > 0 && inventoryData.find(m => m.name === i.name)?.stock >= i.qty);

            if (!customerName || !itemsValidForSale || !paymentMethod || totalCost < 0) { // <-- MODIFIED
                processSaleButton.disabled = true;
                if (!customerName) {
                    posMessage.textContent = "Customer Name is required for the sale.";
                } else if (!paymentMethod) { 
                    posMessage.textContent = "Please select a payment method."; 
                } else if (totalCost < 0) { // <-- MODIFIED
                    // This message is now set by calculateTotal()
                    if (!posMessage.textContent) {
                         posMessage.textContent = "Total cannot be less than zero.";
                    }
                } else if (currentItems.length > 0 && !itemsValidForSale) {
                    posMessage.textContent = "Customer Name is required for the sale.";
                } else if (!paymentMethod) { 
                    posMessage.textContent = "Please select a payment method."; 
                } else if (totalCost < 0) { // <-- NEW
                    posMessage.textContent = "Discount cannot be more than the subtotal."; // <-- NEW
                } else if (currentItems.length > 0 && !itemsValidForSale) {
                    posMessage.textContent = "Please ensure an item is selected, and stock is sufficient for all items.";
                }
                posMessage.classList.remove('hidden');
                if (!customerName) {
                    posMessage.textContent = "Customer Name is required for the sale.";
                } else if (currentItems.length > 0 && !itemsValidForSale) {
                    posMessage.textContent = "Please ensure an item is selected, and stock is sufficient for all items.";
                } else {
                    posMessage.textContent = "Please add at least one material.";
                }
                posMessage.classList.remove('hidden');
                posMessage.classList.add('text-red-500');
            } else {
                processSaleButton.disabled = false;
                posMessage.classList.add('hidden');
                posMessage.classList.remove('text-red-500');
            }
        }

        // --- NEW: Reusable POS Reset Function ---
        function resetPOS() {
            currentItems = [];
            customerNameInput.value = '';
            customerNameInput.disabled = false;
            posCustomerSelector.value = "";
            selectedCustomerId = null;
            posItemsContainer.innerHTML = '';
            totalCostSpan.textContent = formatCurrency(0);
            posSummaryItems.innerHTML = '';
            posPaymentMethod.value = businessSettings.defaultPaymentMethod || ""; 
            posDiscountInput.value = 0; 
            posSubtotal.textContent = formatCurrency(0); 
            posRedeemPointsInput.value = 0;
            if (isDiscountPercent) {
                toggleDiscountType();
            }
            posRedeemPointsContainer.classList.add('hidden');
            posCustomerPointsDisplay.classList.add('hidden');
            addItem();
        }
        // --- END: New Function ---

        // --- NEW: Hold & Resume Sale Logic ---

        // Helper to update the red badge count
        function updateHeldSaleCount() {
            const count = heldSales.length;
            if (count > 0) {
                heldSaleCountBadge.textContent = count;
                heldSaleCountBadge.classList.remove('hidden');
            } else {
                heldSaleCountBadge.classList.add('hidden');
            }
        }

        // 1. HOLD SALE
        function handleHoldSale() {
            // Check if there is at least one valid item
            const itemsToHold = currentItems.filter(i => i.name && i.qty > 0);
            if (itemsToHold.length === 0) {
                posMessage.textContent = "Please add at least one item to hold the sale.";
                posMessage.classList.remove('hidden', 'text-green-500');
                posMessage.classList.add('text-red-500');
                setTimeout(() => posMessage.classList.add('hidden'), 3000);
                return;
            }

            // Save the entire POS state
            const heldSale = {
                id: crypto.randomUUID(),
                customerName: customerNameInput.value,
                selectedCustomerId: selectedCustomerId,
                currentItems: JSON.parse(JSON.stringify(itemsToHold)), // Deep copy
                discountValue: posDiscountInput.value,
                isDiscountPercent: isDiscountPercent,
                redeemPoints: posRedeemPointsInput.value,
                paymentMethod: posPaymentMethod.value,
                timestamp: new Date()
            };

            heldSales.push(heldSale);
            resetPOS(); // Clear the screen
            updateHeldSaleCount(); // Update the badge

            posMessage.textContent = `Sale for ${heldSale.customerName || 'Walk-in'} held successfully.`;
            posMessage.classList.remove('hidden', 'text-red-500');
            posMessage.classList.add('text-green-500');
            setTimeout(() => posMessage.classList.add('hidden'), 3000);
        }

        // 2. OPEN RESUME MODAL
        function openResumeSaleModal() {
            heldSalesListBody.innerHTML = ''; // Clear the list
            if (heldSales.length === 0) {
                heldSalesEmptyMessage.classList.remove('hidden');
            } else {
                heldSalesEmptyMessage.classList.add('hidden');
                heldSales.forEach(sale => {
                    // Calculate total for display
                    const subtotal = sale.currentItems.reduce((acc, item) => acc + item.subtotal, 0);
                    let discount = 0;
                    if (sale.isDiscountPercent) {
                        discount = subtotal * (parseFloat(sale.discountValue) / 100);
                    } else {
                        discount = parseFloat(sale.discountValue);
                    }
                    const redeem = parseFloat(sale.redeemPoints) || 0;
                    const total = subtotal - discount - redeem;

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.customerName || 'Walk-in'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.timestamp.toLocaleTimeString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-indigo-600">${formatCurrency(total)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                            <button onclick="window.resumeSale('${sale.id}')" class="text-green-600 hover:text-green-900 font-semibold">Resume</button>
                            <button onclick="window.deleteHeldSale('${sale.id}')" class="text-red-600 hover:text-red-900 font-semibold">Delete</button>
                        </td>
                    `;
                    heldSalesListBody.appendChild(row);
                });
            }
            resumeSaleModal.classList.remove('hidden');
        }

        window.closeResumeSaleModal = () => {
            resumeSaleModal.classList.add('hidden');
        }

        // 3. RESUME A SPECIFIC SALE
        window.resumeSale = (saleId) => {
            const sale = heldSales.find(s => s.id === saleId);
            if (!sale) return;

            // Clear the POS first
            resetPOS();
            posItemsContainer.innerHTML = ''; // resetPOS adds one item, we want zero

            // Load the sale state back
            customerNameInput.value = sale.customerName;
            selectedCustomerId = sale.selectedCustomerId;
            posCustomerSelector.value = sale.selectedCustomerId;
            // Manually trigger change to update loyalty points display
            posCustomerSelector.dispatchEvent(new Event('change'));

            posPaymentMethod.value = sale.paymentMethod;
            posDiscountInput.value = sale.discountValue;
            posRedeemPointsInput.value = sale.redeemPoints;

            // Sync the discount type (e.g., if held was % but current is ₱)
            if (sale.isDiscountPercent !== isDiscountPercent) {
                toggleDiscountType();
            }

            // Restore all items
            currentItems = JSON.parse(JSON.stringify(sale.currentItems)); // Deep copy
            currentItems.forEach(item => {
                posItemsContainer.appendChild(createPosItemElement(item.id));
            });
            
            // Recalculate totals and check button status
            calculateTotal();
            checkPosStatus();
            updatePosItemSelectors(); // Make sure all dropdowns are correctly populated

            // Remove from held list
            heldSales = heldSales.filter(s => s.id !== saleId);
            updateHeldSaleCount();
            window.closeResumeSaleModal();
        }

        // 4. DELETE A HELD SALE
        window.deleteHeldSale = (saleId) => {
            heldSales = heldSales.filter(s => s.id !== saleId);
            openResumeSaleModal(); // Re-render the list
            updateHeldSaleCount(); // Update the badge
        }

        // 5. Add Event Listeners
        holdSaleButton.addEventListener('click', handleHoldSale);
        resumeSaleButton.addEventListener('click', openResumeSaleModal);
        // --- END: Hold & Resume Sale Logic ---

        async function processSale() {
            if (processSaleButton.disabled || !userId) return;

            const customerName = customerNameInput.value.trim();
            const customerIdToRecord = selectedCustomerId; // This is null if it's a temporary customer

            const { subtotal, discountValue, discountAmount, redeemPointsAmount, totalCost, totalCOGS } = calculateTotal();

            const profit = totalCost - totalCOGS;
            const saleId = crypto.randomUUID().substring(0, 8);
            const paymentMethod = posPaymentMethod.value; 

            if (!customerName || totalCost < 0 || !paymentMethod) { 
                checkPosStatus(true, totalCost);
                return;
            }

            const materialsUsed = currentItems.filter(i => i.name && i.qty > 0).map(item => ({
                id: inventoryData.find(m => m.name === item.name)?.id,
                name: item.name,
                qty: item.qty,
                unitCost: item.cogs,
                salePrice: item.cost,
                subtotal: item.subtotal,
                cogsSubtotal: item.cogsSubtotal,
                usageUnit: item.usageUnit 
            }));

            if (materialsUsed.length === 0) return;

            showButtonLoading(processSaleButton, 'Processing...');

            // --- NEW: DUAL LOGIC FOR CASH VS PENDING ---

            if (paymentMethod === 'Cash') {
                // --- 1. CASH SALE (Original Logic) ---
                try {
                    let pointsEarned = 0;
                    let newTotalPoints = 0;
                    let customer = null; // <-- NEW
                    let isLoyaltyMember = false; // <-- NEW

                    // 1a. Deduct from Inventory
                    const updatePromises = materialsUsed.map(async (item) => {
                        const material = inventoryData.find(m => m.name === item.name);
                        if (material && material.stock >= item.qty) {
                            const newStock = material.stock - item.qty;
                            const itemRef = doc(db, getInventoryCollectionPath(userId), item.id);
                            await updateDoc(itemRef, { stock: newStock });
                            await logInventoryHistory(material.name, `Sale deduction: -${item.qty} ${item.usageUnit}`, 'sale', 'Sale Transaction', saleId);
                            const itemLowStockThreshold = Number(material.lowStockThreshold || 10);
                            if (newStock > 0 && newStock < itemLowStockThreshold) { 
                                await logInventoryHistory(material.name, `Stock is LOW: ${newStock} ${material.usageUnit} remaining`, 'low_stock', '', saleId);
                            }
                        }
                    });
                    await Promise.all(updatePromises);

                    // 1b. Record the Completed Sale
                    await addDoc(collection(db, getSalesCollectionPath(userId)), {
                        saleId: saleId,
                        customerId: customerIdToRecord || null,
                        customerName: customerName,
                        isTemporaryCustomer: !customerIdToRecord, // <-- NEW
                        materialsUsed: materialsUsed,
                        subtotal: subtotal,
                        discountValue: discountValue,
                        discountType: isDiscountPercent ? 'percent' : 'fixed',
                        discountAmount: discountAmount,
                        redeemPointsAmount: redeemPointsAmount,
                        totalCost: totalCost,
                        totalCOGS: totalCOGS, 
                        profit: profit,       
                        paymentMethod: paymentMethod, 
                        referenceNumber: 'CASH', 
                        date: Timestamp.now()
                    });

                    // 1c. Update Loyalty Points
                    if (customerIdToRecord) {
                        customer = customersData.find(c => c.id === customerIdToRecord); // <-- NEW
                        // Use ?? true as a fallback for old customers
                        isLoyaltyMember = customer && (customer.joinsLoyalty ?? true); // <-- NEW

                        if (isLoyaltyMember) { // <-- NEW CHECK
                            const loyaltyRate = parseInt(businessSettings.loyaltyRate) || 15;
                            pointsEarned = 0;
                            if (loyaltyRate > 0) {
                                pointsEarned = Math.floor(totalCost / loyaltyRate);
                            }
                            const customerRef = doc(db, getCustomersCollectionPath(userId), customerIdToRecord);
                            const currentPoints = customer.loyaltyPoints || 0;
                            newTotalPoints = currentPoints - redeemPointsAmount + pointsEarned;
                            await updateDoc(customerRef, { loyaltyPoints: newTotalPoints });
                        }
                    }

                    // 1d. Generate FINAL Receipt
                    const receiptItems = materialsUsed.map(m => ({ ...m, unitCost: m.salePrice, subtotal: m.subtotal }));
                    // --- NEW: Pass undefined if not a loyalty member ---
                    const receiptPointsEarned = isLoyaltyMember ? pointsEarned : undefined;
                    const receiptNewTotal = isLoyaltyMember ? newTotalPoints : undefined;
                    generateReceipt(saleId, customerName, receiptItems, subtotal, discountAmount, redeemPointsAmount, totalCost, paymentMethod, receiptPointsEarned, receiptNewTotal);

                    // 1e. Reset POS
                    resetPOS();
                    posMessage.textContent = 'Sale processed successfully! Receipt is ready for print.';
                    posMessage.classList.remove('hidden', 'text-red-500');
                    posMessage.classList.add('text-green-500');
                    setTimeout(() => posMessage.classList.add('hidden'), 5000);

                } catch (error) {
                    console.error("Error processing cash sale:", error);
                    posMessage.textContent = 'ERROR: Failed to process cash sale.';
                    posMessage.classList.remove('hidden');
                    posMessage.classList.add('text-red-500');
                } finally {
                    hideButtonLoading(processSaleButton);
                }

            } else {
                // --- 2. PENDING SALE (New Logic) ---
                try {
                    // 2a. Record the Pending Sale
                    // ** NO INVENTORY DEDUCTION, NO POINTS **
                    await addDoc(collection(db, getPendingSalesCollectionPath(userId)), {
                        saleId: saleId,
                        customerId: customerIdToRecord || null,
                        customerName: customerName,
                        isTemporaryCustomer: !customerIdToRecord, // <-- NEW
                        materialsUsed: materialsUsed,
                        subtotal: subtotal,
                        discountValue: discountValue,
                        discountType: isDiscountPercent ? 'percent' : 'fixed',
                        discountAmount: discountAmount,
                        redeemPointsAmount: redeemPointsAmount,
                        totalCost: totalCost,
                        totalCOGS: totalCOGS, 
                        profit: profit,       
                        paymentMethod: paymentMethod, 
                        date: Timestamp.now()
                    });

                    // 2b. Generate BILLING Receipt
                    const receiptItems = materialsUsed.map(m => ({ ...m, unitCost: m.salePrice, subtotal: m.subtotal }));
                    generateBillingReceipt(saleId, customerName, receiptItems, subtotal, discountAmount, redeemPointsAmount, totalCost, paymentMethod);

                    // 2c. Reset POS
                    resetPOS();
                    posMessage.textContent = 'Billing Receipt generated. Sale is now pending payment.';
                    posMessage.classList.remove('hidden', 'text-red-500');
                    posMessage.classList.add('text-green-500');
                    setTimeout(() => posMessage.classList.add('hidden'), 5000);

                } catch (error) {
                    console.error("Error processing pending sale:", error);
                    posMessage.textContent = 'ERROR: Failed to create pending sale.';
                    posMessage.classList.remove('hidden');
                    posMessage.classList.add('text-red-500');
                } finally {
                    hideButtonLoading(processSaleButton);
                }
            }
            // --- END: DUAL LOGIC ---
        }
        processSaleButton.addEventListener('click', processSale);


        // --- PDF/Receipt Generation Logic ---

        // MODIFIED: Signature
        function generateReceipt(id, customer, items, subtotal, discountAmount, redeemPointsAmount, total, paymentMethod, pointsEarned, newTotalPoints) { 

            // --- NEW: Get Receipt Elements ---
            const receiptPrintArea = document.getElementById('receipt-print-area');
            const logoEl = document.getElementById('receipt-logo');
            const contactInfoEl = document.getElementById('receipt-contact-info-wrapper');
            // --- END: New ---

            // --- APPLY SETTINGS ---

            // 1. Set Logo
            if (businessSettings.logoURL) {
                logoEl.src = businessSettings.logoURL;
                const logoSize = businessSettings.logoSize || 50; // Get size, default to 50
                logoEl.style.width = `${logoSize}%`; // Apply size as inline style
                logoEl.style.maxWidth = `${logoSize}%`; // Ensure it respects the width
                logoEl.classList.remove('hidden');
            } else {
                logoEl.classList.add('hidden');
            }

            // 2. Set Business Info (Name is always on)
            receiptBusinessName.textContent = `${businessSettings.name} `;

            // 3. Toggle Contact Info
            const showContact = businessSettings.showContact !== false; // Default true
            receiptBusinessInfo.textContent = `${businessSettings.address} | ${businessSettings.contact}`;
            contactInfoEl.classList.toggle('hidden', !showContact);

            // 4. Set Font Size
            const fontSize = businessSettings.fontSize || 'text-sm';
            receiptPrintArea.classList.remove('text-xs', 'text-sm', 'text-base'); // Clear old
            receiptPrintArea.classList.add(fontSize); // Add new

            // --- END APPLY SETTINGS ---

            // Existing logic
            document.getElementById('receipt-date').textContent = new Date().toLocaleString();
            document.getElementById('receipt-customer-name').textContent = customer;
            document.getElementById('receipt-id').textContent = id;

            // Set Subtotal, Discount, and Total
            receiptSubtotal.textContent = formatCurrency(subtotal);
            receiptDiscount.textContent = `- ${formatCurrency(discountAmount)}`;
            receiptTotalCost.textContent = formatCurrency(total);

            receiptPaymentMethod.textContent = paymentMethod || 'N/A'; 

            // --- NEW: Handle Points Display on Receipt ---

            // Show redeemed points if any were used
            if (redeemPointsAmount > 0) {
                receiptPointsRedeemed.textContent = `- ${formatCurrency(redeemPointsAmount)}`;
                receiptRedeemedLine.classList.remove('hidden');
            } else {
                receiptRedeemedLine.classList.add('hidden');
            }

            // Show points summary only if:
            // 1. The setting is enabled
            // 2. Points values were passed (i.e., not `undefined` because customer opted out)
            const showLoyaltySetting = businessSettings.showLoyalty === true; 
            if (showLoyaltySetting && typeof newTotalPoints !== 'undefined') { // <-- MODIFIED
                receiptPointsEarned.textContent = pointsEarned;
                receiptTotalPoints.textContent = newTotalPoints;
                receiptPointsSummary.classList.remove('hidden');
            } else {
                receiptPointsSummary.classList.add('hidden');
            }
            // --- END: Points Display Logic ---

            const materialsContainer = document.getElementById('receipt-materials');
            materialsContainer.innerHTML = '';

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between';
                div.innerHTML = `
                    <span>${item.qty} x ${item.name} (${formatCurrency(item.unitCost)}/${item.usageUnit})</span>
                    <span>${formatCurrency(item.subtotal)}</span>
                `;
                materialsContainer.appendChild(div);
            });

            // --- FIX: Isolate window.print() ---
            try {
                window.print();
            } catch (printError) {
                console.error("Print dialog failed to open:", printError);
            }
            // --- END FIX ---
        }

        // --- NEW: Helper to reprint a PENDING billing receipt ---
        window.printBillingReceipt = (saleId) => {
            const sale = pendingSalesData.find(s => s.id === saleId);
            if (!sale) {
                console.error("Pending sale not found for printing:", saleId);
                return;
            }

            // Prepare items for billing receipt
            const receiptItems = sale.materialsUsed.map(m => ({ 
                ...m, 
                unitCost: m.salePrice, // Billing receipt shows SALE price
                subtotal: m.subtotal 
            }));

            // Call the existing generateBillingReceipt function
            generateBillingReceipt(
                sale.saleId,
                sale.customerName,
                receiptItems,
                sale.subtotal,
                sale.discountAmount,
                sale.redeemPointsAmount,
                sale.totalCost,
                sale.paymentMethod
            );
        };
        // --- END: New Helper ---

        // --- NEW: Billing Receipt Generation ---
        function generateBillingReceipt(id, customer, items, subtotal, discountAmount, redeemPointsAmount, total, paymentMethod) { 
            // Set Business Info from settings
            receiptBusinessName.textContent = `${businessSettings.name} - BILLING RECEIPT`; // <-- CHANGED
            receiptBusinessInfo.textContent = `${businessSettings.address} | ${businessSettings.contact}`;
            
            const receiptPrintArea = document.getElementById('receipt-print-area');
            const logoEl = document.getElementById('receipt-logo');
            const contactInfoEl = document.getElementById('receipt-contact-info-wrapper');

            // Apply Settings
            if (businessSettings.logoURL) {
                logoEl.src = businessSettings.logoURL;
                const logoSize = businessSettings.logoSize || 50; 
                logoEl.style.width = `${logoSize}%`;
                logoEl.style.maxWidth = `${logoSize}%`;
                logoEl.classList.remove('hidden');
            } else {
                logoEl.classList.add('hidden');
            }
            const showContact = businessSettings.showContact !== false;
            contactInfoEl.classList.toggle('hidden', !showContact);
            const fontSize = businessSettings.fontSize || 'text-sm';
            receiptPrintArea.classList.remove('text-xs', 'text-sm', 'text-base');
            receiptPrintArea.classList.add(fontSize);

            // Populate Fields
            document.getElementById('receipt-date').textContent = new Date().toLocaleString();
            document.getElementById('receipt-customer-name').textContent = customer;
            document.getElementById('receipt-id').textContent = id;
            receiptSubtotal.textContent = formatCurrency(subtotal);
            receiptDiscount.textContent = `- ${formatCurrency(discountAmount)}`;
            receiptTotalCost.textContent = formatCurrency(total);
            receiptPaymentMethod.textContent = paymentMethod || 'N/A'; 

            // Handle Redeemed Points
            if (redeemPointsAmount > 0) {
                receiptPointsRedeemed.textContent = `- ${formatCurrency(redeemPointsAmount)}`;
                receiptRedeemedLine.classList.remove('hidden');
            } else {
                receiptRedeemedLine.classList.add('hidden');
            }

            // --- IMPORTANT: HIDE LOYALTY SUMMARY FOR BILLING ---
            receiptPointsSummary.classList.add('hidden');

            const materialsContainer = document.getElementById('receipt-materials');
            materialsContainer.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between';
                div.innerHTML = `
                    <span>${item.qty} x ${item.name} (${formatCurrency(item.unitCost)}/${item.usageUnit})</span>
                    <span>${formatCurrency(item.subtotal)}</span>
                `;
                materialsContainer.appendChild(div);
            });

            try {
                window.print();
            } catch (printError) {
                console.error("Print dialog failed to open:", printError);
            }
        }
        // --- END: New Billing Function ---

        // --- Reports Logic ---

        function listenToSales(uid) {
            const salesRef = collection(db, getSalesCollectionPath(uid));

            return onSnapshot(salesRef, (snapshot) => {
                salesData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date.toDate() 
                }));
                salesData.sort((a, b) => b.date.getTime() - a.date.getTime());
                renderReportsTable();
                renderCustomerDashboard(); 
                renderDashboard(); 
                
                if (currentHistoryCustomerId) {
                    const customer = customersData.find(c => c.id === currentHistoryCustomerId);
                    if (customer) {
                        window.showCustomerHistory(customer.id, customer.name);
                    } else {
                        customerHistoryList.innerHTML = '';
                        historyPlaceholder.classList.remove('hidden');
                        currentHistoryCustomerId = null;
                    }
                }
            }, (error) => {
                console.error("Error listening to sales:", error.message);
            });
        }

        function renderSalesChart(data) {
            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            const chartCanvas = document.getElementById('sales-chart');
            if (!chartCanvas) return; 
            
            const ctx = chartCanvas.getContext('2d');

            const chartData = [...data].sort((a, b) => a.date.getTime() - b.date.getTime());
            const labels = chartData.map(sale => sale.date.toLocaleDateString());
            const salesValues = chartData.map(sale => sale.totalCost);

            salesChartInstance = new Chart(ctx, {
                type: 'line', 
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Sales',
                        data: salesValues,
                        backgroundColor: 'rgba(79, 70, 229, 0.1)', // Indigo
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Sales: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderReportsTable(filteredData = salesData) {
            currentFilteredSales = filteredData; // <-- ADD THIS LINE

            // --- NEW: P&L Calculations ---
            const grossSubtotal = filteredData.reduce((acc, sale) => acc + (sale.subtotal || 0), 0);
            const totalDiscounts = filteredData.reduce((acc, sale) => acc + (sale.discountAmount || 0), 0);
            const totalRedeemed = filteredData.reduce((acc, sale) => acc + (sale.redeemPointsAmount || 0), 0);
            const netRevenue = filteredData.reduce((acc, sale) => acc + (sale.totalCost || 0), 0);
            const totalProfit = filteredData.reduce((acc, sale) => acc + (sale.profit || 0), 0);

            // --- NEW: Filter by customer type BEFORE calculating total sales ---
            let dataToRender = filteredData;
            if (reportsCustomerType === 'registered') {
                dataToRender = filteredData.filter(sale => !sale.isTemporaryCustomer);
            } else if (reportsCustomerType === 'temporary') {
                dataToRender = filteredData.filter(sale => sale.isTemporaryCustomer);
            }
            const totalSales = dataToRender.length; // <-- MOVED

            // --- NEW: Get all card elements ---
            const grossRevenueEl = document.getElementById('reports-gross-revenue');
            const totalDiscountsEl = document.getElementById('reports-total-discounts');
            const totalRedeemedEl = document.getElementById('reports-total-redeemed');
            const netRevenueEl = document.getElementById('reports-net-revenue');
            const totalProfitEl = document.getElementById('reports-total-profit');
            const totalSalesEl = document.getElementById('reports-total-sales');

            // --- NEW: Populate all 6 cards ---
            if (grossRevenueEl) {
                grossRevenueEl.textContent = formatCurrency(grossSubtotal);
            }
            if (totalDiscountsEl) {
                totalDiscountsEl.textContent = formatCurrency(totalDiscounts);
            }
            if (totalRedeemedEl) {
                totalRedeemedEl.textContent = formatCurrency(totalRedeemed);
            }
            if (netRevenueEl) {
                netRevenueEl.textContent = formatCurrency(netRevenue);
            }
            if (totalProfitEl) { // NEW
                totalProfitEl.textContent = formatCurrency(totalProfit);
            }
            if (totalSalesEl) {
                totalSalesEl.textContent = totalSales;
            }

            reportsTableBody.innerHTML = '';
            if (dataToRender.length === 0) { // <-- MODIFIED
                reportsEmptyMessage.textContent = "No transactions found for the selected filters."; // <-- MODIFIED
                reportsEmptyMessage.classList.remove('hidden');

                if (salesChartInstance) {
                    salesChartInstance.destroy();
                    salesChartInstance = null;
                }
                return;
            }
            reportsEmptyMessage.classList.add('hidden');

            const now = new Date();
            const sixHoursAgo = new Date(now.getTime() - (6 * 60 * 60 * 1000)); 

            dataToRender.forEach(sale => { // <-- MODIFIED
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // --- NEW: Customer Type Display ---
                const customerTypeDisplay = sale.isTemporaryCustomer ? 
                    '<span class="text-gray-500">Temporary</span>' :
                    '<span class="font-semibold text-indigo-700">Registered</span>';

                const customerDisplay = sale.customerId ? 
                    `<span class="font-bold text-indigo-700">${sale.customerName}</span>` : 
                    sale.customerName;

                const materialDetails = sale.materialsUsed.map(m => `${m.qty}x ${m.name} (${m.usageUnit})`).join(', ');

                const isRecent = sale.date > sixHoursAgo;
                let voidButtonHtml = '';
                if (isRecent) {
                    voidButtonHtml = `<button onclick="window.openConfirmVoidModal('${sale.id}', '${sale.saleId}')" class="text-red-600 hover:text-red-900 font-semibold">
                                        Void
                                    </button>`;
                }

                const printButtonHtml = `<button onclick="window.reprintReceipt('${sale.id}')" class="text-blue-600 hover:text-blue-900 font-semibold mr-3">
                                            Print
                                        </button>`;

                const remarksList = [];
                if (sale.discountType === 'percent') {
                    remarksList.push(`Discount (${sale.discountValue}%)`);
                } else if (sale.discountType === 'fixed' && sale.discountAmount > 0) {
                    remarksList.push(`Discount (${formatCurrency(sale.discountAmount)})`);
                } 
                else if (sale.discountAmount > 0 && !sale.discountType) {
                    remarksList.push("Discount Applied");
                }

                if (sale.redeemPointsAmount > 0) {
                    remarksList.push("Points Redeemed");
                }
                const remarksHtml = remarksList.join(', ');

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.date.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customerDisplay}</td>
                    <!-- NEW: Customer Type Data -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${customerTypeDisplay}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${materialDetails}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-base font-bold text-indigo-700">${formatCurrency(sale.totalCost)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-base font-bold text-green-700">${formatCurrency(sale.profit || 0)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${remarksHtml}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.referenceNumber || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${printButtonHtml} 
                        ${voidButtonHtml}
                    </td>
                `;
                reportsTableBody.appendChild(row);
            });

            renderSalesChart(dataToRender); // <-- MODIFIED
        }

        function filterReports() {
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
            const paymentMethod = document.getElementById('reports-payment-method-filter').value;
            const searchTerm = reportsSearchInput.value.toLowerCase().trim(); // <-- ADD THIS

            let filtered = salesData;

            if (startDate) {
                startDate.setHours(0, 0, 0, 0);
                filtered = filtered.filter(sale => sale.date >= startDate);
            }

            if (endDate) {
                endDate.setHours(23, 59, 59, 999);
                filtered = filtered.filter(sale => sale.date <= endDate);
            }

            if (paymentMethod) {
                filtered = filtered.filter(sale => sale.paymentMethod === paymentMethod);
            }

            // NEW: Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(sale => {
                    // Check customer name
                    const customerMatch = sale.customerName.toLowerCase().includes(searchTerm);

                    // Check item names
                    const itemsString = sale.materialsUsed.map(m => m.name).join(' ').toLowerCase();
                    const itemsMatch = itemsString.includes(searchTerm);

                    return customerMatch || itemsMatch;
                });
            }

            // MODIFIED: We just call renderReportsTable.
            // It will handle the customer type filtering internally.
            renderReportsTable(filtered); 
        }

        document.getElementById('filter-reports-button').addEventListener('click', filterReports);

        document.getElementById('reset-reports-button').addEventListener('click', () => {
            startDateInput.value = '';
            endDateInput.value = '';
            document.getElementById('reports-payment-method-filter').value = ''; 
            reportsSearchInput.value = ''; // <-- This is the line you just added
            renderReportsTable(); 
        });

        // --- NEW: Reports Search Listener ---
        reportsSearchInput.addEventListener('input', debounce(filterReports, 300));
        // --- END: New Listener ---

        // --- MODIFIED: Inventory History Filter Listeners ---
        document.getElementById('filter-inventory-history-button').addEventListener('click', filterInventoryHistory);

        document.getElementById('reset-inventory-history-button').addEventListener('click', () => {
            document.getElementById('inventory-history-start-date').value = '';
            document.getElementById('inventory-history-end-date').value = '';
            inventoryHistorySearch.value = ''; // <-- ADD THIS
            inventoryHistoryTypeFilter.value = ''; // <-- ADD THIS
            
            // Re-run the filter to reset the list
            filterInventoryHistory(); 
        });

        // NEW: Add listeners for the new inputs
        inventoryHistorySearch.addEventListener('input', debounce(filterInventoryHistory, 300));
        inventoryHistoryTypeFilter.addEventListener('change', filterInventoryHistory);
        
        // NEW: Add listener for the PDF button
        generateInventoryHistoryPdfButton.addEventListener('click', generateInventoryHistoryPDF);
        // --- END: New Listeners ---
        // --- END: Inventory History Filter Listeners ---

       // --- NEW: PDF GENERATION LOGIC (REVISED) ---

        function generatePDF() {
            // 1. Check if main library is loaded
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                console.error("jsPDF library is not loaded.");
                alert("Error: jsPDF library not loaded. Please refresh the page.");
                return;
            }

            const { jsPDF } = window.jspdf;
            // --- Set orientation to landscape ---
            const doc = new jsPDF({ orientation: 'landscape' });

            // 2. Check if autoTable plugin is loaded *on the instance* (Safer check)
            if (typeof doc.autoTable !== 'function') {
                console.error("jsPDF-AutoTable plugin is not loaded or did not attach.");
                alert("Error: PDF Table library not loaded. Please check your browser's console (F12) and Network tab for errors loading 'jspdf.plugin.autotable.min.js'.");
                return;
            }

            // 3. Get data
            const dataToRender = currentFilteredSales;
            
            // --- Corrected the ID from 'reports-total-earnings' to 'reports-net-revenue' ---
            const totalEarningsElement = document.getElementById('reports-net-revenue');
            if (!totalEarningsElement) {
                console.error("Could not find element with ID 'reports-net-revenue'");
                alert("Error: Could not find total revenue element on the page.");
                return;
            }
            const totalEarnings = totalEarningsElement.textContent; // This is Net Revenue
            
            const totalProfit = document.getElementById('reports-total-profit').textContent;
            const totalDiscounts = document.getElementById('reports-total-discounts').textContent;
            const totalPointsRedeemed = document.getElementById('reports-total-redeemed').textContent;
            const totalSalesCount = document.getElementById('reports-total-sales').textContent;

            // --- CHANGE 1: Get the selected payment method text ---
            const paymentMethodFilterEl = document.getElementById('reports-payment-method-filter');
            const paymentMethodText = paymentMethodFilterEl.options[paymentMethodFilterEl.selectedIndex].text;
            // --- END CHANGE 1 ---

            const startDate = document.getElementById('start-date').value || 'Start';
            const endDate = document.getElementById('end-date').value || 'Today';

            // 4. Set Title and Header Info
            doc.setFontSize(18);
            doc.text("Sales Transaction Report", 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100); // Gray color
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 29);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`Net Revenue (Filtered): ${totalEarnings}`, 14, 36);
            doc.text(`Total Profit (Filtered): ${totalProfit}`, 14, 43);
            doc.text(`Total Discounts: ${totalDiscounts}`, 14, 50);
            doc.text(`Total Points Redeemed: ${totalPointsRedeemed}`, 14, 57);
            doc.text(`Total Sales (Filtered): ${totalSalesCount}`, 14, 64);
            
            // --- CHANGE 2: Add the payment method filter to the PDF header ---
            doc.text(`Payment Method: ${paymentMethodText}`, 14, 71);
            // --- END CHANGE 2 ---

            doc.setFont('helvetica', 'normal');

            // 5. Prepare Table Data
            const head = [['Date', 'Customer', 'Items/Quantities', 'Total Cost (₱)', 'Profit (₱)', 'Remarks', 'Ref #']];
            const body = dataToRender.map(sale => {

                // --- CHANGE 3: Use newline '\n' instead of ', ' to fix text cropping ---
                const materialDetails = sale.materialsUsed.map(m => `${m.qty}x ${m.name} (${m.usageUnit})`).join('\n');
                // --- END CHANGE 3 ---

                const remarksList = [];
                if (sale.discountType === 'percent') {
                    remarksList.push(`Discount (${sale.discountValue}%)`);
                } else if (sale.discountType === 'fixed' && sale.discountAmount > 0) {
                    remarksList.push(`Discount (${formatCurrency(sale.discountAmount)})`);
                }
                else if (sale.discountAmount > 0 && !sale.discountType) {
                    remarksList.push("Discount Applied");
                }
                
                if (sale.redeemPointsAmount > 0) {
                    remarksList.push("Points");
                }
                const remarksText = remarksList.join(', ');

                return [
                    sale.date.toLocaleString(),
                    sale.customerName,
                    materialDetails,
                    formatCurrency(sale.totalCost), // Use your existing helper function
                    formatCurrency(sale.profit || 0),
                    remarksText,
                    sale.referenceNumber || 'N/A' // <-- ADD THIS
                ];
            });

            // 6. Generate Table
            doc.autoTable({
                // --- Adjusted startY to make room for the new payment method line ---
                startY: 80,
                head: head,
                body: body,
                theme: 'striped',
                headStyles: { 
                    fillColor: [79, 70, 229] // Indigo color from your app
                },
                didDrawPage: (data) => {
                    // Footer
                    let str = 'Page ' + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            // 7. Save the PDF
            const fileName = `Sales_Report_${startDate}_to_${endDate}.pdf`;
            doc.save(fileName);
        }

        // Add listener for the new button
        document.getElementById('generate-pdf-button').addEventListener('click', generatePDF);

        // --- NEW: Inventory History PDF Generation ---
        function generateInventoryHistoryPDF() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                console.error("jsPDF library is not loaded.");
                alert("Error: jsPDF library not loaded. Please refresh the page.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });

            if (typeof doc.autoTable !== 'function') {
                console.error("jsPDF-AutoTable plugin is not loaded.");
                alert("Error: PDF Table library not loaded. Please refresh the page.");
                return;
            }
            
            // 1. Get Data
            const dataToRender = currentFilteredInventoryHistory; // Use the filtered data
            const startDate = document.getElementById('inventory-history-start-date').value || 'Start';
            const endDate = document.getElementById('inventory-history-end-date').value || 'Today';
            
            const typeFilterEl = document.getElementById('inventory-history-type-filter');
            const typeText = typeFilterEl.options[typeFilterEl.selectedIndex].text;
            
            const searchText = inventoryHistorySearch.value;

            // 2. Set Title and Header Info
            doc.setFontSize(18);
            doc.text("Inventory History Report", 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 29);
            doc.text(`Type Filter: ${typeText}`, 14, 36);
            if (searchText) {
                doc.text(`Search: "${searchText}"`, 14, 43);
            }

            // 3. Prepare Table Data
            const head = [['Date', 'Item Name', 'Type', 'Message', 'Reason', 'Transaction ID']];
            const body = dataToRender.map(log => {
                let typeFriendlyName = log.type; // Default
                switch (log.type) {
                    case 'stock_in': typeFriendlyName = 'Stock Received'; break;
                    case 'stock_out': typeFriendlyName = 'Stock Used'; break;
                    case 'sale': typeFriendlyName = 'Sale Deduction'; break;
                    case 'points_adjustment': typeFriendlyName = 'Points Adjustment'; break;
                    case 'low_stock': typeFriendlyName = 'Low Stock Alert'; break;
                }

                return [
                    log.date.toLocaleString(),
                    log.itemName,
                    typeFriendlyName,
                    log.message,
                    log.reason || 'N/A', // Show N/A if reason is empty
                    log.transactionId || 'N/A' // <-- ADD THIS LINE
                ];
            });

            // 4. Generate Table
            doc.autoTable({
                startY: searchText ? 52 : 45, // Adjust start Y based on search text
                head: head,
                body: body,
                theme: 'striped',
                headStyles: { 
                    fillColor: [79, 70, 229] // Indigo
                },
                didDrawPage: (data) => {
                    // Footer
                    let str = 'Page ' + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            // 5. Save the PDF
            const fileName = `Inventory_History_Report_${startDate}_to_${endDate}.pdf`;
            doc.save(fileName);
        }

        function listenToPendingSales(uid) {
            const pendingSalesRef = collection(db, getPendingSalesCollectionPath(uid));
            return onSnapshot(query(pendingSalesRef, orderBy("date", "desc")), (snapshot) => {
                pendingSalesData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date.toDate() 
                }));
                renderPendingSalesTable();
                updatePendingSalesCountBadge();
            }, (error) => {
                console.error("Error listening to pending sales: ", error.message);
            });
        }

        function updatePendingSalesCountBadge() {
            const count = pendingSalesData.length;
            if (count > 0) {
                pendingSalesCountBadge.textContent = count;
                pendingSalesCountBadge.classList.remove('hidden');
            } else {
                pendingSalesCountBadge.classList.add('hidden');
            }
        }

        function renderPendingSalesTable() {
            pendingSalesTableBody.innerHTML = '';
            if (pendingSalesData.length === 0) {
                pendingSalesEmptyMessage.classList.remove('hidden');
                return;
            }
            pendingSalesEmptyMessage.classList.add('hidden');

            pendingSalesData.forEach(sale => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const materialDetails = sale.materialsUsed.map(m => `${m.qty}x ${m.name}`).join(', ');

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.date.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.customerName}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${materialDetails}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.paymentMethod}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-base font-bold text-indigo-700">${formatCurrency(sale.totalCost)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                        <button onclick="window.printBillingReceipt('${sale.id}')" class="text-blue-600 hover:text-blue-900 font-semibold">
                            Print Bill
                        </button>
                        <button onclick="window.openReceivePaymentModal('${sale.id}')" class="text-green-600 hover:text-green-900 font-semibold">
                            Confirm Payment
                        </button>
                        <button onclick="window.deletePendingSale('${sale.id}')" class="text-red-600 hover:text-red-900 font-semibold">
                            Delete
                        </button>
                    </td>
                `;
                pendingSalesTableBody.appendChild(row);
            });
        }
        
        window.openReceivePaymentModal = (saleId) => {
            const sale = pendingSalesData.find(s => s.id === saleId);
            if (!sale) return;

            receivePaymentSaleId.value = saleId;
            receivePaymentSaleName.textContent = sale.saleId;
            receivePaymentSaleTotal.textContent = formatCurrency(sale.totalCost);
            receivePaymentRefInput.value = '';
            receivePaymentMessage.classList.add('hidden');
            receivePaymentModal.classList.remove('hidden');
        };

        window.closeReceivePaymentModal = () => {
            receivePaymentModal.classList.add('hidden');
        };

        window.deletePendingSale = async (saleId) => {
            if (!saleId || !userId) return;
            if (!confirm("Are you sure you want to delete this pending sale? This cannot be undone.")) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, getPendingSalesCollectionPath(userId), saleId));
                console.log("Pending sale deleted:", saleId);
            } catch (error) {
                console.error("Error deleting pending sale:", error);
                posMessage.textContent = 'Error deleting pending sale.';
                posMessage.classList.remove('hidden');
                posMessage.classList.add('text-red-500');
            }
        };

        async function handleReceivePaymentSubmit(e) {
            e.preventDefault();
            const saleId = receivePaymentSaleId.value;
            const referenceNumber = receivePaymentRefInput.value.trim();

            if (!saleId || !referenceNumber) {
                receivePaymentMessage.textContent = "Reference number is required.";
                receivePaymentMessage.classList.remove('hidden');
                return;
            }

            const sale = pendingSalesData.find(s => s.id === saleId);
            if (!sale) {
                receivePaymentMessage.textContent = "Sale not found. Please refresh.";
                receivePaymentMessage.classList.remove('hidden');
                return;
            }

            const submitButton = e.target.querySelector('button[type="submit"]');
            showButtonLoading(submitButton, 'Processing...');

            try {
                let pointsEarned = 0;
                let newTotalPoints = 0;
                let customer = null; // <-- NEW
                let isLoyaltyMember = false; // <-- NEW

                // 1. Deduct from Inventory (Same logic from 'Cash' path)
                const updatePromises = sale.materialsUsed.map(async (item) => {
                    const material = inventoryData.find(m => m.name === item.name);
                    if (material && material.stock >= item.qty) {
                        const newStock = material.stock - item.qty;
                        const itemRef = doc(db, getInventoryCollectionPath(userId), item.id);
                        await updateDoc(itemRef, { stock: newStock });
                        await logInventoryHistory(material.name, `Sale deduction: -${item.qty} ${item.usageUnit}`, 'sale', 'Sale Transaction', sale.saleId);
                        const itemLowStockThreshold = Number(material.lowStockThreshold || 10);
                        if (newStock > 0 && newStock < itemLowStockThreshold) { 
                            await logInventoryHistory(material.name, `Stock is LOW: ${newStock} ${material.usageUnit} remaining`, 'low_stock', '', sale.saleId);
                        }
                    }
                });
                await Promise.all(updatePromises);

                // 2. Update Loyalty Points (Same logic from 'Cash' path)
                if (sale.customerId) {
                    customer = customersData.find(c => c.id === sale.customerId); // <-- NEW
                    // Use ?? true as a fallback for old customers
                    isLoyaltyMember = customer && (customer.joinsLoyalty ?? true); // <-- NEW

                    if (isLoyaltyMember) { // <-- NEW CHECK
                        const loyaltyRate = parseInt(businessSettings.loyaltyRate) || 15;
                        pointsEarned = 0;
                        if (loyaltyRate > 0) {
                            pointsEarned = Math.floor(sale.totalCost / loyaltyRate);
                        }
                        const customerRef = doc(db, getCustomersCollectionPath(userId), sale.customerId);
                        const currentPoints = customer.loyaltyPoints || 0;
                        newTotalPoints = currentPoints - sale.redeemPointsAmount + pointsEarned;
                        await updateDoc(customerRef, { loyaltyPoints: newTotalPoints });
                    }
                }

                // 3. Create Completed Sale Object
                const completedSale = {
                    ...sale, // Copy all data from pending sale
                    referenceNumber: referenceNumber,
                    completedAt: Timestamp.now() // Add completion timestamp
                };
                delete completedSale.id; // Remove the Firestore document ID

                // 4. Move the document
                await addDoc(collection(db, getSalesCollectionPath(userId)), completedSale);
                await deleteDoc(doc(db, getPendingSalesCollectionPath(userId), saleId));

                // 5. Generate FINAL Receipt
                const receiptItems = sale.materialsUsed.map(m => ({ ...m, unitCost: m.salePrice, subtotal: m.subtotal }));
                // --- NEW: Pass undefined if not a loyalty member ---
                const receiptPointsEarned = isLoyaltyMember ? pointsEarned : undefined;
                const receiptNewTotal = isLoyaltyMember ? newTotalPoints : undefined;
                generateReceipt(sale.saleId, sale.customerName, receiptItems, sale.subtotal, sale.discountAmount, sale.redeemPointsAmount, sale.totalCost, sale.paymentMethod, receiptPointsEarned, receiptNewTotal);

                window.closeReceivePaymentModal();

            } catch (error) {
                console.error("Error completing payment:", error);
                receivePaymentMessage.textContent = "Error: " + error.message;
                receivePaymentMessage.classList.remove('hidden');
            } finally {
                hideButtonLoading(submitButton)
            }
        }
        receivePaymentForm.addEventListener('submit', handleReceivePaymentSubmit);
        // --- END: Pending Sales Logic ---
        
        // --- Event Listeners and Setup ---

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.tab-button');
                if (tabButton) {
                    setTab(tabButton.getAttribute('data-tab'));
                }
            });
        });

        document.getElementById('logout-button').addEventListener('click', async () => {
            try {
                await signOut(auth);
                authEmailInput.value = '';
                authPasswordInput.value = '';
                authMessage.classList.add('hidden');
                toggleAuthMode(false);
                console.log("User logged out successfully.");
            } catch (error) {
                console.error("Error signing out:", error);
            }
        });
        // --- NEW: Dashboard Quick Filter Logic ---
        document.querySelectorAll('.dashboard-filter-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const filter = e.target.dataset.filter;
                currentDashboardFilter = filter; // Set the global state
                
                // Update button styles to show the active one
                document.querySelectorAll('.dashboard-filter-button').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-white', 'dark:none', 'text-white-700', 'dark:text-white-700', 'hover:bg-green-800');
                });
                
                e.target.classList.add('bg-indigo-600', 'text-white');
                e.target.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-50');
                
                renderDashboard(); // Re-render the dashboard with the new filter
            });
        });
        // --- END: Dashboard Quick Filter Logic ---

        // --- (ADD ALL OF THIS CODE) ARCHIVE LOGIC ---

        // A helper function to move a document
        async function moveDoc(fromCollectionPath, toCollectionPath, docId) {
            if (!userId || !docId) throw new Error("User or Doc ID is missing.");

            // Use getDoc, not onSnapshot, for a one-time read
            const fromRef = doc(db, fromCollectionPath, docId);
            const fromSnap = await getDoc(fromRef); 

            if (!fromSnap.exists()) {
                throw new Error("Source document not found.");
            }

            const data = fromSnap.data();

            // Add/update a timestamp
            if (toCollectionPath.includes('archived')) {
                data.archivedAt = Timestamp.now();
            } else {
                // Optionally remove the archivedAt timestamp when un-archiving
                delete data.archivedAt; 
            }

            // Write to the new collection (using the same ID)
            const toRef = doc(db, toCollectionPath, docId);
            await setDoc(toRef, data);

            // Delete from the old collection
            await deleteDoc(fromRef);

            return data; // Return the moved data
        }

        // --- Archive Listeners ---

        function listenToArchivedCategories(uid) {
            const categoriesRef = collection(db, getArchivedCategoriesCollectionPath(uid));
            return onSnapshot(categoriesRef, (snapshot) => {
                archivedCategoriesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                archivedCategoriesData.sort((a, b) => a.name.localeCompare(b.name));
                renderArchiveTab(); // Re-render the archive tab if it's active
            }, (error) => {
                console.error("Error listening to archived categories: ", error.message);
            });
        }

        function listenToArchivedInventory(uid) {
            const inventoryRef = collection(db, getArchivedInventoryCollectionPath(uid));
            return onSnapshot(inventoryRef, (snapshot) => {
                archivedInventoryData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                archivedInventoryData.sort((a, b) => a.name.localeCompare(b.name));
                renderArchiveTab();
            }, (error) => {
                console.error("Error listening to archived inventory: ", error.message);
            });
        }

        function listenToArchivedCustomers(uid) {
            const customersRef = collection(db, getArchivedCustomersCollectionPath(uid));
            return onSnapshot(customersRef, (snapshot) => {
                archivedCustomersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                archivedCustomersData.sort((a, b) => a.name.localeCompare(b.name));
                renderArchiveTab();
            }, (error) => {
                console.error("Error listening to archived customers: ", error.message);
            });
        }

        // --- Main Archive Tab Render Function ---

        function renderArchiveTab() {
            // Only render if the tab is active (to avoid unnecessary work)
            if (document.getElementById('archive-tab').classList.contains('hidden')) {
                return;
            }

            renderArchivedCategoryList();
            renderArchivedInventoryList();
            renderArchivedCustomerList();
        }

        // --- Archive List Renderers ---

        function renderArchivedCategoryList() {
            archivedCategoryListBody.innerHTML = '';
            if (archivedCategoriesData.length === 0) {
                archivedCategoryEmptyMessage.classList.remove('hidden');
                return;
            }
            archivedCategoryEmptyMessage.classList.add('hidden');
            archivedCategoriesData.forEach(category => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${category.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="window.unarchiveCategory('${category.id}')" class="text-green-600 hover:text-green-900 font-semibold">
                            Un-archive
                        </button>
                    </td>
                `;
                archivedCategoryListBody.appendChild(row);
            });
        }

        function renderArchivedInventoryList() {
            archivedInventoryListBody.innerHTML = '';
            if (archivedInventoryData.length === 0) {
                archivedInventoryEmptyMessage.classList.remove('hidden');
                return;
            }
            archivedInventoryEmptyMessage.classList.add('hidden');
            archivedInventoryData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.categoryName || 'Uncategorized'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.unitCost || 0)}/${item.usageUnit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="window.unarchiveInventoryItem('${item.id}')" class="text-green-600 hover:text-green-900 font-semibold">
                            Un-archive
                        </button>
                    </td>
                `;
                archivedInventoryListBody.appendChild(row);
            });
        }

        function renderArchivedCustomerList() {
            archivedCustomerListBody.innerHTML = '';
            if (archivedCustomersData.length === 0) {
                archivedCustomerEmptyMessage.classList.remove('hidden');
                return;
            }
            archivedCustomerEmptyMessage.classList.add('hidden');
            archivedCustomersData.forEach(customer => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.contactNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="window.unarchiveCustomer('${customer.id}')" class="text-green-600 hover:text-green-900 font-semibold">
                            Un-archive
                        </button>
                    </td>
                `;
                archivedCustomerListBody.appendChild(row);
            });
        }

        // --- Archive & Un-archive Functions (Make them global) ---

        window.archiveCategory = async (docId) => {
            if (!userId || !docId) return;

            try {
                // 1. Find all inventory items with this categoryId
                const q = query(collection(db, getInventoryCollectionPath(userId)), where("categoryId", "==", docId));
                const querySnapshot = await getDocs(q);
                
                const archivePromises = [];

                // 2. Add the category itself to the list to be moved
                archivePromises.push(moveDoc(getCategoriesCollectionPath(userId), getArchivedCategoriesCollectionPath(userId), docId));

                // 3. Add all found inventory items to the list
                querySnapshot.forEach((itemDoc) => {
                    console.log(`Archiving item: ${itemDoc.id}`);
                    archivePromises.push(moveDoc(getInventoryCollectionPath(userId), getArchivedInventoryCollectionPath(userId), itemDoc.id));
                });

                // 4. Run all move operations
                await Promise.all(archivePromises);
                
                console.log(`Category ${docId} and ${querySnapshot.docs.length} item(s) archived.`);
                categoryMessage.textContent = `Category and ${querySnapshot.docs.length} associated item(s) have been archived.`;
                categoryMessage.classList.remove('hidden', 'text-red-500');
                categoryMessage.classList.add('text-green-500');
                setTimeout(() => categoryMessage.classList.add('hidden'), 5000);

            } catch (error) {
                console.error("Error archiving category and items:", error);
                categoryMessage.textContent = 'Error during cascade archive.';
                categoryMessage.classList.remove('hidden');
                categoryMessage.classList.add('text-red-500');
            }
        };

        window.unarchiveCategory = async (docId) => {
             if (!userId || !docId) return;

            try {
                // 1. Find all *archived* inventory items with this categoryId
                const q = query(collection(db, getArchivedInventoryCollectionPath(userId)), where("categoryId", "==", docId));
                const querySnapshot = await getDocs(q);
                
                const unarchivePromises = [];

                // 2. Add the category itself to the list to be moved back
                unarchivePromises.push(moveDoc(getArchivedCategoriesCollectionPath(userId), getCategoriesCollectionPath(userId), docId));

                // 3. Add all found inventory items to the list to be moved back
                querySnapshot.forEach((itemDoc) => {
                    console.log(`Un-archiving item: ${itemDoc.id}`);
                    unarchivePromises.push(moveDoc(getArchivedInventoryCollectionPath(userId), getInventoryCollectionPath(userId), itemDoc.id));
                });

                // 4. Run all move operations
                await Promise.all(unarchivePromises);
                
                console.log(`Category ${docId} and ${querySnapshot.docs.length} item(s) un-archived.`);
                // We show the message on the 'categories' tab, not the archive tab
                categoryMessage.textContent = `Category and ${querySnapshot.docs.length} item(s) have been restored.`;
                categoryMessage.classList.remove('hidden', 'text-red-500');
                categoryMessage.classList.add('text-green-500');
                setTimeout(() => categoryMessage.classList.add('hidden'), 5000);

            } catch (error) {
                console.error("Error un-archiving category and items:", error);
            }
        };

        window.archiveInventoryItem = async (docId) => {
            try {
                await moveDoc(getInventoryCollectionPath(userId), getArchivedInventoryCollectionPath(userId), docId);
                console.log(`Inventory item ${docId} archived.`);
            } catch (error) {
                console.error("Error archiving inventory item:", error);
            }
        };

        window.unarchiveInventoryItem = async (docId) => {
            if (!userId || !docId) return;

            try {
                // 1. Move the item and get its data in one step
                const itemData = await moveDoc(getArchivedInventoryCollectionPath(userId), getInventoryCollectionPath(userId), docId);
                console.log(`Inventory item ${docId} un-archived.`);

                // 2. Check if the un-archived item has a categoryId
                if (itemData && itemData.categoryId) {
                    const categoryId = itemData.categoryId;
                    
                    // 3. Check if this category is currently in the archive
                    const archivedCategoryRef = doc(db, getArchivedCategoriesCollectionPath(userId), categoryId);
                    const categorySnap = await getDoc(archivedCategoryRef);

                    if (categorySnap.exists()) {
                        // 4. If it is, un-archive it too
                        await moveDoc(getArchivedCategoriesCollectionPath(userId), getCategoriesCollectionPath(userId), categoryId);
                        console.log(`Associated category ${categoryId} was also un-archived.`);
                        
                        // Show a message on the main category tab
                        categoryMessage.textContent = `Category "${categorySnap.data().name}" was restored with its item.`;
                        categoryMessage.classList.remove('hidden', 'text-red-500');
                        categoryMessage.classList.add('text-green-500');
                        setTimeout(() => categoryMessage.classList.add('hidden'), 5000);
                    }
                }
            } catch (error) {
                console.error("Error un-archiving inventory item:", error);
            }
        };

        window.archiveCustomer = async (docId) => {
            try {
                await moveDoc(getCustomersCollectionPath(userId), getArchivedCustomersCollectionPath(userId), docId);
                console.log(`Customer ${docId} archived.`);
            } catch (error) {
                console.error("Error archiving customer:", error);
            }
        };

        window.unarchiveCustomer = async (docId) => {
            try {
                await moveDoc(getArchivedCustomersCollectionPath(userId), getCustomersCollectionPath(userId), docId);
                console.log(`Customer ${docId} un-archived.`);
            } catch (error) {
                console.error("Error un-archiving customer:", error);
            }
        };

        // --- NEW: Theme Toggle Logic ---
        
        // Function to update the icons based on the current theme
        function updateThemeIcons() {
            if (document.documentElement.classList.contains('dark')) {
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                themeToggleLightIcon.classList.add('hidden');
                themeToggleDarkIcon.classList.remove('hidden');
            }
        }

        // Run it once on load
        updateThemeIcons();

        // Add click listener for the toggle button
        themeToggleButton.addEventListener('click', () => {
            // toggle the 'dark' class on the <html> element
            document.documentElement.classList.toggle('dark');

            // update localStorage
            if (document.documentElement.classList.contains('dark')) {
                localStorage.theme = 'dark';
            } else {
                localStorage.theme = 'light';
            }

            // update the icons
            updateThemeIcons();
        });

        // --- NEW: Connection Status Logic ---
        
        // Helper function to update the banner
        function updateConnectionStatus() {
            if (navigator.onLine) {
                // Connection is on
                connectionStatusBanner.textContent = 'Connection Restored. You are back online.';
                connectionStatusBanner.classList.remove('hidden');
                connectionStatusBanner.classList.remove('bg-red-500');
                connectionStatusBanner.classList.add('bg-green-500');

                // Hide the "restored" message after 3 seconds
                setTimeout(() => {
                    connectionStatusBanner.classList.add('hidden');
                }, 3000);
            } else {
                // Connection is off
                connectionStatusBanner.textContent = 'No Internet Connection. Your data will not be saved.';
                connectionStatusBanner.classList.remove('hidden');
                connectionStatusBanner.classList.remove('bg-green-500');
                connectionStatusBanner.classList.add('bg-red-500');
            }
        }

        // Add listeners for online/offline events
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Check status on initial load (after a short delay to let app init)
        setTimeout(() => {
            if (!navigator.onLine) {
                updateConnectionStatus();
            }
        }, 1000);
        // --- END: New Logic ---

        // --- NEW: Customer Report Filter Logic ---
        document.querySelectorAll('.customer-report-filter-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const filter = e.target.dataset.customerFilter;
                reportsCustomerType = filter; // Set the global state

                // Update button styles
                document.querySelectorAll('.customer-report-filter-button').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-white', 'dark:none', 'text-white-700', 'dark:text-white-700', 'hover:bg-green-800');
                });

                e.target.classList.add('bg-indigo-600', 'text-white');
                e.target.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-50');

                // Re-run the main filter function, which will now use the new state
                filterReports(); 
            });
        });


        window.addEventListener('load', initFirebase);
    </script>

    <div id="connection-status-banner" class="hidden fixed bottom-0 left-0 right-0 p-4 text-center text-white font-semibold z-50">
        </div>
    </body>
</html>
